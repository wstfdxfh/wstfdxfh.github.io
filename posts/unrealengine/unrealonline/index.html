<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>UnrealOnline | 李睿杰的博客</title>
<meta name="keywords" content="">
<meta name="description" content="简介
相关课程：
https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/
这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。
效果如下：

在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。
配置文件设置
在DefaultEngine.ini中，添加以下内容：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


[/Script/Engine.GameEngine]
&#43;NetDriverDefinitions=(DefName=&#34;GameNetDriver&#34;,DriverClassName=&#34;OnlineSubsystemSteam.SteamNetDriver&#34;,DriverClassNameFallback=&#34;OnlineSubsystemUtils.IpNetDriver&#34;)

[OnlineSubsystem]
DefaultPlatformService=Steam

[OnlineSubsystemSteam]
bEnabled=true
SteamDevAppId=480
bInitServerOnClient=true

[/Script/OnlineSubsystemSteam.SteamNetDriver]
NetConnectionClassName=&#34;OnlineSubsystemSteam.SteamNetConnection&#34;


480是一个公用的游戏id
在DefaultGame.ini中添加


1
2


[/Script/Engine.GameSession]
MaxPlayers=100


规定了最大玩家数量。
插件创建
在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：

例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。
在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20


{
    ...
	&#34;Modules&#34;: [
		{
			&#34;Name&#34;: &#34;MultiplayerSessions&#34;,
			&#34;Type&#34;: &#34;Runtime&#34;,
			&#34;LoadingPhase&#34;: &#34;Default&#34;
		}
	],
	&#34;Plugins&#34;:[
		{
			&#34;Name&#34;: &#34;OnlineSubsystem&#34;,
			&#34;Enabled&#34;: true
		},
		{
			&#34;Name&#34;: &#34;OnlineSubsystemSteam&#34;,
			&#34;Enabled&#34;: true
		}
	]
}


MultiplayerSessions.Build.cs">
<meta name="author" content="李睿杰">
<link rel="canonical" href="https://wstfdxfh.github.io/posts/unrealengine/unrealonline/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://wstfdxfh.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://wstfdxfh.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://wstfdxfh.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://wstfdxfh.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://wstfdxfh.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://wstfdxfh.github.io/posts/unrealengine/unrealonline/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://wstfdxfh.github.io/posts/unrealengine/unrealonline/">
  <meta property="og:site_name" content="李睿杰的博客">
  <meta property="og:title" content="UnrealOnline">
  <meta property="og:description" content="简介 相关课程：
https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/
这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。
效果如下：
在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。
配置文件设置 在DefaultEngine.ini中，添加以下内容：
1 2 3 4 5 6 7 8 9 10 11 12 13 [/Script/Engine.GameEngine] &#43;NetDriverDefinitions=(DefName=&#34;GameNetDriver&#34;,DriverClassName=&#34;OnlineSubsystemSteam.SteamNetDriver&#34;,DriverClassNameFallback=&#34;OnlineSubsystemUtils.IpNetDriver&#34;) [OnlineSubsystem] DefaultPlatformService=Steam [OnlineSubsystemSteam] bEnabled=true SteamDevAppId=480 bInitServerOnClient=true [/Script/OnlineSubsystemSteam.SteamNetDriver] NetConnectionClassName=&#34;OnlineSubsystemSteam.SteamNetConnection&#34; 480是一个公用的游戏id
在DefaultGame.ini中添加
1 2 [/Script/Engine.GameSession] MaxPlayers=100 规定了最大玩家数量。
插件创建 在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：
例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。
在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { ... &#34;Modules&#34;: [ { &#34;Name&#34;: &#34;MultiplayerSessions&#34;, &#34;Type&#34;: &#34;Runtime&#34;, &#34;LoadingPhase&#34;: &#34;Default&#34; } ], &#34;Plugins&#34;:[ { &#34;Name&#34;: &#34;OnlineSubsystem&#34;, &#34;Enabled&#34;: true }, { &#34;Name&#34;: &#34;OnlineSubsystemSteam&#34;, &#34;Enabled&#34;: true } ] } MultiplayerSessions.Build.cs">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-19T18:02:04+08:00">
    <meta property="article:modified_time" content="2025-05-19T18:02:04+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="UnrealOnline">
<meta name="twitter:description" content="简介
相关课程：
https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/
这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。
效果如下：

在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。
配置文件设置
在DefaultEngine.ini中，添加以下内容：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


[/Script/Engine.GameEngine]
&#43;NetDriverDefinitions=(DefName=&#34;GameNetDriver&#34;,DriverClassName=&#34;OnlineSubsystemSteam.SteamNetDriver&#34;,DriverClassNameFallback=&#34;OnlineSubsystemUtils.IpNetDriver&#34;)

[OnlineSubsystem]
DefaultPlatformService=Steam

[OnlineSubsystemSteam]
bEnabled=true
SteamDevAppId=480
bInitServerOnClient=true

[/Script/OnlineSubsystemSteam.SteamNetDriver]
NetConnectionClassName=&#34;OnlineSubsystemSteam.SteamNetConnection&#34;


480是一个公用的游戏id
在DefaultGame.ini中添加


1
2


[/Script/Engine.GameSession]
MaxPlayers=100


规定了最大玩家数量。
插件创建
在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：

例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。
在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20


{
    ...
	&#34;Modules&#34;: [
		{
			&#34;Name&#34;: &#34;MultiplayerSessions&#34;,
			&#34;Type&#34;: &#34;Runtime&#34;,
			&#34;LoadingPhase&#34;: &#34;Default&#34;
		}
	],
	&#34;Plugins&#34;:[
		{
			&#34;Name&#34;: &#34;OnlineSubsystem&#34;,
			&#34;Enabled&#34;: true
		},
		{
			&#34;Name&#34;: &#34;OnlineSubsystemSteam&#34;,
			&#34;Enabled&#34;: true
		}
	]
}


MultiplayerSessions.Build.cs">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://wstfdxfh.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "UnrealEngine",
      "item": "https://wstfdxfh.github.io/posts/unrealengine/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "UnrealOnline",
      "item": "https://wstfdxfh.github.io/posts/unrealengine/unrealonline/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "UnrealOnline",
  "name": "UnrealOnline",
  "description": "简介 相关课程：\nhttps://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/\n这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。\n效果如下：\n在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。\n配置文件设置 在DefaultEngine.ini中，添加以下内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 [/Script/Engine.GameEngine] +NetDriverDefinitions=(DefName=\u0026#34;GameNetDriver\u0026#34;,DriverClassName=\u0026#34;OnlineSubsystemSteam.SteamNetDriver\u0026#34;,DriverClassNameFallback=\u0026#34;OnlineSubsystemUtils.IpNetDriver\u0026#34;) [OnlineSubsystem] DefaultPlatformService=Steam [OnlineSubsystemSteam] bEnabled=true SteamDevAppId=480 bInitServerOnClient=true [/Script/OnlineSubsystemSteam.SteamNetDriver] NetConnectionClassName=\u0026#34;OnlineSubsystemSteam.SteamNetConnection\u0026#34; 480是一个公用的游戏id\n在DefaultGame.ini中添加\n1 2 [/Script/Engine.GameSession] MaxPlayers=100 规定了最大玩家数量。\n插件创建 在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：\n例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。\n在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { ... \u0026#34;Modules\u0026#34;: [ { \u0026#34;Name\u0026#34;: \u0026#34;MultiplayerSessions\u0026#34;, \u0026#34;Type\u0026#34;: \u0026#34;Runtime\u0026#34;, \u0026#34;LoadingPhase\u0026#34;: \u0026#34;Default\u0026#34; } ], \u0026#34;Plugins\u0026#34;:[ { \u0026#34;Name\u0026#34;: \u0026#34;OnlineSubsystem\u0026#34;, \u0026#34;Enabled\u0026#34;: true }, { \u0026#34;Name\u0026#34;: \u0026#34;OnlineSubsystemSteam\u0026#34;, \u0026#34;Enabled\u0026#34;: true } ] } MultiplayerSessions.Build.cs\n",
  "keywords": [
    
  ],
  "articleBody": "简介 相关课程：\nhttps://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/\n这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。\n效果如下：\n在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。\n配置文件设置 在DefaultEngine.ini中，添加以下内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 [/Script/Engine.GameEngine] +NetDriverDefinitions=(DefName=\"GameNetDriver\",DriverClassName=\"OnlineSubsystemSteam.SteamNetDriver\",DriverClassNameFallback=\"OnlineSubsystemUtils.IpNetDriver\") [OnlineSubsystem] DefaultPlatformService=Steam [OnlineSubsystemSteam] bEnabled=true SteamDevAppId=480 bInitServerOnClient=true [/Script/OnlineSubsystemSteam.SteamNetDriver] NetConnectionClassName=\"OnlineSubsystemSteam.SteamNetConnection\" 480是一个公用的游戏id\n在DefaultGame.ini中添加\n1 2 [/Script/Engine.GameSession] MaxPlayers=100 规定了最大玩家数量。\n插件创建 在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：\n例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。\n在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { ... \"Modules\": [ { \"Name\": \"MultiplayerSessions\", \"Type\": \"Runtime\", \"LoadingPhase\": \"Default\" } ], \"Plugins\":[ { \"Name\": \"OnlineSubsystem\", \"Enabled\": true }, { \"Name\": \"OnlineSubsystemSteam\", \"Enabled\": true } ] } MultiplayerSessions.Build.cs\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 using UnrealBuildTool; public class MultiplayerSessions : ModuleRules { public MultiplayerSessions(ReadOnlyTargetRules Target) : base(Target) { PCHUsage = ModuleRules.PCHUsageMode.UseExplicitOrSharedPCHs; PublicIncludePaths.AddRange( new string[] {} ); PrivateIncludePaths.AddRange( new string[] {} ); PublicDependencyModuleNames.AddRange( new string[]{ \"Core\", \"OnlineSubsystem\", \"OnlineSubsystemSteam\", \"UMG\", \"Slate\", \"SlateCore\" } ); PrivateDependencyModuleNames.AddRange( new string[]{ \"CoreUObject\", \"Engine\", \"Slate\", \"SlateCore\", } ); DynamicallyLoadedModuleNames.AddRange(new string[]{}); } } 目录类代码 创建一个menuC++类，并在此基础上创建一个蓝图\n对应蓝图实现如下：\n初始关卡蓝图如下：\nMenu.h代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 #pragma once #include \"CoreMinimal.h\" #include \"Blueprint/UserWidget.h\" #include \"Interfaces/OnlineSessionInterface.h\" #include \"Menu.generated.h\" UCLASS() class MULTIPLAYERSESSIONS_API UMenu : public UUserWidget { GENERATED_BODY() public: UFUNCTION(BlueprintCallable) void MenuSetup( int32 NumberOfPublicConnections = 4, FString TypeOfMatch = FString(TEXT(\"FreeForAll\")), FString LobbyPath = FString(TEXT(\"/Game/ThirdPerson/Maps/Lobby\"))); protected: virtual bool Initialize() override; // 当退出关卡加入大厅时调用 virtual void NativeDestruct() override; // 回调函数，绑定在FMultiplayerOnCreateSessionComplete上 UFUNCTION() void OnCreateSession(bool bWasSuccessful); void OnFindSessions(const TArray\u003cFOnlineSessionSearchResult\u003e\u0026 SessionResults, bool bWasSuccessful); void OnJoinSession(EOnJoinSessionCompleteResult::Type Result); UFUNCTION() void OnDestroySession(bool bWasSuccessful); UFUNCTION() void OnStartSession(bool bWasSuccessful); private: // 必须和Editor中名称完全一致 UPROPERTY(meta=(BindWidget)) class UButton* HostButton; UPROPERTY(meta=(BindWidget)) UButton* JoinButton; UFUNCTION() void HostButtonClicked(); UFUNCTION() void JoinButtonClicked(); void MenuTearDown(); class UMultiplayerSessionsSubsystem* MultiplayerSessionsSubsystem; int32 NumPublicConnections{4}; FString MatchType{TEXT(\"FreeForAll\")}; FString PathToLobby{TEXT(\"\")}; }; 按钮绑定 对于蓝图中名称和头文件中完全一致的UI控件，可以使用UPROPERTY(meta=(BindWidget))进行自动绑定，这样当蓝图中的按钮被点击时，cpp中的同名称按钮也会被触发，由于UMenu::Initialize函数添加了HostButton-\u003eOnClicked.AddDynamic(this, \u0026ThisClass::HostButtonClicked);绑定，因此会触发相应的回调函数。\n回调函数声明注意 这里回调函数中，有部分包含了UFUNCTION声明，有的没有，其中包含了的使用的是动态回调，而没有的则使用普通回调，不能被蓝图使用，这种差别的原因是TArray\u003c\u003e或者EOnJoinSessionCompleteResult::Type的类型不被UE的反射系统支持，而bool则原生支持，所以调用的时候可以使用动态代理的回调。要令上述类型支持动态回调，方法之一是将这些类型作为一个声明了UCLASS,USTRUCT的成员，并且使用UPROPERTY标记，这样可以将类作为参数间接访问相关类型。\nMenu.cpp代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 #include \"Menu.h\" #include \"Components/Button.h\" #include \"MultiplayerSessionsSubsystem.h\" #include \"OnlineSessionSettings.h\" #include \"OnlineSubsystemUtils.h\" void UMenu::MenuSetup(int32 NumberOfPublicConnections, FString TypeOfMatch, FString LobbyPath) { PathToLobby = FString::Printf(TEXT(\"%s?listen\"), *LobbyPath); NumPublicConnections = NumberOfPublicConnections; MatchType = TypeOfMatch; AddToViewport(); SetVisibility(ESlateVisibility::Visible); SetIsFocusable(true); UWorld* World = GetWorld(); if(World) { APlayerController* PlayerController = World-\u003eGetFirstPlayerController(); if(PlayerController) { FInputModeUIOnly InputModeData; InputModeData.SetWidgetToFocus(TakeWidget()); InputModeData.SetLockMouseToViewportBehavior(EMouseLockMode::DoNotLock); PlayerController-\u003eSetInputMode(InputModeData); PlayerController-\u003eSetShowMouseCursor(true); } } UGameInstance* GameInstance = GetGameInstance(); if(GameInstance) { MultiplayerSessionsSubsystem = GameInstance-\u003eGetSubsystem\u003cUMultiplayerSessionsSubsystem\u003e(); } if(MultiplayerSessionsSubsystem) { MultiplayerSessionsSubsystem-\u003eMultiplayerOnCreateSessionComplete.AddDynamic(this, \u0026ThisClass::OnCreateSession); MultiplayerSessionsSubsystem-\u003eMultiplayerOnFindSessionsComplete.AddUObject(this, \u0026ThisClass::OnFindSessions); MultiplayerSessionsSubsystem-\u003eMultiplayerOnJoinSessionComplete.AddUObject(this, \u0026ThisClass::OnJoinSession); MultiplayerSessionsSubsystem-\u003eMultiplayerOnDestroySessionComplete.AddDynamic(this, \u0026ThisClass::OnDestroySession); MultiplayerSessionsSubsystem-\u003eMultiplayerOnStartSessionComplete.AddDynamic(this, \u0026ThisClass::OnStartSession); } } bool UMenu::Initialize() { // AddToViewport不放在该函数的原因是此时尚未完成全部初始化 if(!Super::Initialize()){ return false; } if(HostButton){ HostButton-\u003eOnClicked.AddDynamic(this, \u0026ThisClass::HostButtonClicked); } if(JoinButton) { JoinButton-\u003eOnClicked.AddDynamic(this, \u0026ThisClass::JoinButtonClicked); } return true; } void UMenu::NativeDestruct() { MenuTearDown(); Super::NativeDestruct(); } void UMenu::OnCreateSession(bool bWasSuccessful) { if(bWasSuccessful) { UWorld* World = GetWorld(); if(World) { World-\u003eServerTravel(PathToLobby); } } else { HostButton-\u003eSetIsEnabled(true); } } void UMenu::OnFindSessions(const TArray\u003cFOnlineSessionSearchResult\u003e\u0026 SessionResults, bool bWasSuccessful) { if(!MultiplayerSessionsSubsystem) { return; } for(auto\u0026 Result : SessionResults) { FString SettingsValue; Result.Session.SessionSettings.Get(FName(\"MatchType\"), SettingsValue); if(SettingsValue == MatchType) { MultiplayerSessionsSubsystem-\u003eJoinSession(Result); return; } } if(!bWasSuccessful || SessionResults.Num()==0) { JoinButton-\u003eSetIsEnabled(true); } } void UMenu::OnJoinSession(EOnJoinSessionCompleteResult::Type Result) { IOnlineSubsystem* Subsystem = Online::GetSubsystem(GetWorld()); if(Subsystem) { IOnlineSessionPtr SessionInterface = Subsystem-\u003eGetSessionInterface(); if(SessionInterface.IsValid()) { FString Address; SessionInterface-\u003eGetResolvedConnectString(NAME_GameSession, Address); APlayerController* PlayerController = GetGameInstance()-\u003eGetFirstLocalPlayerController(); if(PlayerController) { PlayerController-\u003eClientTravel(Address, TRAVEL_Absolute); } } } if(Result!=EOnJoinSessionCompleteResult::Success) { JoinButton-\u003eSetIsEnabled(true); } } void UMenu::HostButtonClicked() { HostButton-\u003eSetIsEnabled(false); if(MultiplayerSessionsSubsystem) { MultiplayerSessionsSubsystem-\u003eCreateSession(NumPublicConnections, MatchType); } } void UMenu::JoinButtonClicked() { JoinButton-\u003eSetIsEnabled(false); if(MultiplayerSessionsSubsystem) { MultiplayerSessionsSubsystem-\u003eFindSessions(10000); } } void UMenu::MenuTearDown() { RemoveFromParent(); if(UWorld* World = GetWorld()) { if(APlayerController* PlayerController = World-\u003eGetFirstPlayerController()) { FInputModeGameOnly InputModeData; PlayerController-\u003eSetInputMode(InputModeData); PlayerController-\u003eSetShowMouseCursor(false); } } } 该代码的注意点如下：\nInitialize函数在创建UI时进行调用，只进行按钮的代理绑定操作，其他初始操作（比如AddToViewport）放到自定义函数； MenuSetup中，调整了一些UI设置，并且获取了UMultiplayerSessionsSubsystem，并且获取其中的代理进行了回调函数的绑定，注意动态回调和非动态的函数区别。 在相关按钮被按下后，按钮被设置为不可用，直到回调中返回结果后才可以再次点击，这是为了防止多次调用内容。 UMenu::NativeDestruct函数被调用时，表示用户被移动到其他地图，本地图被移除。 OnlineSubSystem代码 MultiplayerSessionsSubsystem.h继承UGameInstanceSubsystem，特点为：\n是一个单例类 和GameInstance拥有相同的生命周期，游戏开始时创建，结束时销毁 通过继承UGameInstanceSubsystem，而非UGameInstance，可以使具体功能实现解耦 实现如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 #pragma once #include \"CoreMinimal.h\" #include \"Subsystems/GameInstanceSubsystem.h\" #include \"Interfaces/OnlineSessionInterface.h\" #include \"MultiplayerSessionsSubsystem.generated.h\" // // Delcaring our own custom delegates for the Menu class to bind callbacks to // DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnCreateSessionComplete, bool, bWasSuccessful); DECLARE_MULTICAST_DELEGATE_TwoParams(FMultiplayerOnFindSessionsComplete, const TArray\u003cFOnlineSessionSearchResult\u003e\u0026 SessionResults, bool bWasSuccessful); DECLARE_MULTICAST_DELEGATE_OneParam(FMultiplayerOnJoinSessionComplete, EOnJoinSessionCompleteResult::Type Result); DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnDestroySessionComplete, bool, bWasSuccessful); DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnStartSessionComplete, bool, bWasSuccessful); UCLASS() class MULTIPLAYERSESSIONS_API UMultiplayerSessionsSubsystem : public UGameInstanceSubsystem { GENERATED_BODY() public: UMultiplayerSessionsSubsystem(); // // To handle session functionality. The Menu class will call these // void CreateSession(int32 NumPublicConnections, FString MatchType); void FindSessions(int32 MaxSearchResults); void JoinSession(const FOnlineSessionSearchResult\u0026 SessionResult); void DestroySession(); void StartSession(); // // Our own custom delegates for the Menu class to bind callbacks to // FMultiplayerOnCreateSessionComplete MultiplayerOnCreateSessionComplete; FMultiplayerOnFindSessionsComplete MultiplayerOnFindSessionsComplete; FMultiplayerOnJoinSessionComplete MultiplayerOnJoinSessionComplete; FMultiplayerOnDestroySessionComplete MultiplayerOnDestroySessionComplete; FMultiplayerOnStartSessionComplete MultiplayerOnStartSessionComplete; protected: // // Internal callbacks for the delegates we'll add to the Online Session Interface delegate list. // These don't need to be called outside this class. // void OnCreateSessionComplete(FName SessionName, bool bWasSuccessful); void OnFindSessionsComplete(bool bWasSuccessful); void OnJoinSessionComplete(FName SessionName, EOnJoinSessionCompleteResult::Type Result); void OnDestroySessionComplete(FName SessionName, bool bWasSuccessful); void OnStartSessionComplete(FName SessionName, bool bWasSuccessful); private: IOnlineSessionPtr SessionInterface; TSharedPtr\u003cFOnlineSessionSettings\u003e LastSessionSettings; TSharedPtr\u003cFOnlineSessionSearch\u003e LastSessionSearch; // // To add to the Online Session Interface delegate list. // We'll bind our MultiplayerSessionsSubsystem internal callbacks to these. // FOnCreateSessionCompleteDelegate CreateSessionCompleteDelegate; FDelegateHandle CreateSessionCompleteDelegateHandle; FOnFindSessionsCompleteDelegate FindSessionsCompleteDelegate; FDelegateHandle FindSessionsCompleteDelegateHandle; FOnJoinSessionCompleteDelegate JoinSessionCompleteDelegate; FDelegateHandle JoinSessionCompleteDelegateHandle; FOnDestroySessionCompleteDelegate DestroySessionCompleteDelegate; FDelegateHandle DestroySessionCompleteDelegateHandle; FOnStartSessionCompleteDelegate StartSessionCompleteDelegate; FDelegateHandle StartSessionCompleteDelegateHandle; bool bCreateSessionOnDestroy{false}; int32 LastNumPublicConnections; FString LastMatchType; }; 注意点如下：\n代码开始通过宏定义了若干个自定义的代理，这些代理有些是动态多播代理，有些是普通多播代理，原因在于参数的限制。声明代理后需要在类内部进行实例的声明； 在这里声明若干自定义代理的目的是为了让menu的函数可以在各种session任务完成后执行相应的回调函数，同时本类不需要知道具体的实现，实现类之间的解耦； 这里将CreateSession等函数声明为public函数，方便menu直接调用 private部分声明了多种代理，用于绑定当相关Session操作完成后会进行回调的函数，和上面的自定义回调进行对比，前面的用于令其他类绑定对应的回调函数，通知者为当前类；当前的代理用来给Session Interface进行绑定，通知者为Interface； 将代理绑定到Session Interface后，返回对应的Handle，这个Handle可以后续将代理进行解绑。 MultiplayerSessionsSubsystem.cpp实现如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 #include \"MultiplayerSessionsSubsystem.h\" #include \"OnlineSubsystem.h\" #include \"OnlineSessionSettings.h\" #include \"OnlineSubsystemUtils.h\" #include \"Online/OnlineSessionNames.h\" UMultiplayerSessionsSubsystem::UMultiplayerSessionsSubsystem(): CreateSessionCompleteDelegate(FOnCreateSessionCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnCreateSessionComplete)), FindSessionsCompleteDelegate(FOnFindSessionsCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnFindSessionsComplete)), JoinSessionCompleteDelegate(FOnJoinSessionCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnJoinSessionComplete)), DestroySessionCompleteDelegate(FOnDestroySessionCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnDestroySessionComplete)), StartSessionCompleteDelegate(FOnStartSessionCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnStartSessionComplete)) { IOnlineSubsystem* Subsystem = Online::GetSubsystem(UObject::GetWorld()); if(Subsystem) { SessionInterface = Subsystem-\u003eGetSessionInterface(); } } void UMultiplayerSessionsSubsystem::CreateSession(int32 NumPublicConnections, FString MatchType) { if(!SessionInterface.IsValid()) { return; } auto ExistingSession = SessionInterface-\u003eGetNamedSession(NAME_GameSession); if(ExistingSession != nullptr) { bCreateSessionOnDestroy = true; LastNumPublicConnections = NumPublicConnections; LastMatchType = MatchType; DestroySession(); } // Store the delegate in a FDelegateHandle so we can later remove it from the delegate list CreateSessionCompleteDelegateHandle = SessionInterface-\u003eAddOnCreateSessionCompleteDelegate_Handle(CreateSessionCompleteDelegate); LastSessionSettings = MakeShareable(new FOnlineSessionSettings()); LastSessionSettings-\u003ebIsLANMatch = Online::GetSubsystem(GetWorld())-\u003eGetSubsystemName() == \"NULL\" ? true : false; LastSessionSettings-\u003eNumPublicConnections = NumPublicConnections; LastSessionSettings-\u003ebAllowJoinInProgress = true; LastSessionSettings-\u003ebAllowJoinViaPresence = true; LastSessionSettings-\u003ebShouldAdvertise = true; LastSessionSettings-\u003ebUsesPresence = true; LastSessionSettings-\u003ebUseLobbiesIfAvailable = true; LastSessionSettings-\u003eSet(FName(\"MatchType\"), MatchType, EOnlineDataAdvertisementType::ViaOnlineServiceAndPing); LastSessionSettings-\u003eBuildUniqueId = 1; const ULocalPlayer* LocalPlayer = GetWorld()-\u003eGetFirstLocalPlayerFromController(); if(!SessionInterface-\u003eCreateSession(*LocalPlayer-\u003eGetPreferredUniqueNetId(), NAME_GameSession, *LastSessionSettings)) { SessionInterface-\u003eClearOnCreateSessionCompleteDelegate_Handle(CreateSessionCompleteDelegateHandle); // Broadcast our own custom delegate MultiplayerOnCreateSessionComplete.Broadcast(false); } } void UMultiplayerSessionsSubsystem::FindSessions(int32 MaxSearchResults) { if(!SessionInterface.IsValid()) { return; } FindSessionsCompleteDelegateHandle = SessionInterface-\u003eAddOnFindSessionsCompleteDelegate_Handle(FindSessionsCompleteDelegate); LastSessionSearch = MakeShareable(new FOnlineSessionSearch()); LastSessionSearch-\u003eMaxSearchResults = MaxSearchResults; LastSessionSearch-\u003ebIsLanQuery = Online::GetSubsystem(GetWorld())-\u003eGetSubsystemName() == \"NULL\" ? true : false; LastSessionSearch-\u003eQuerySettings.Set(SEARCH_PRESENCE, true, EOnlineComparisonOp::Equals); const ULocalPlayer* LocalPlayer = GetWorld()-\u003eGetFirstLocalPlayerFromController(); if(!SessionInterface-\u003eFindSessions(*LocalPlayer-\u003eGetPreferredUniqueNetId(), LastSessionSearch.ToSharedRef())) { SessionInterface-\u003eClearOnFindSessionsCompleteDelegate_Handle(FindSessionsCompleteDelegateHandle); MultiplayerOnFindSessionsComplete.Broadcast(TArray\u003cFOnlineSessionSearchResult\u003e(), false); } } void UMultiplayerSessionsSubsystem::JoinSession(const FOnlineSessionSearchResult\u0026 SessionResult) { // 相较原版本修改的地方 FOnlineSessionSearchResult Result = SessionResult; if(!SessionInterface || !SessionInterface.IsValid()) { MultiplayerOnJoinSessionComplete.Broadcast(EOnJoinSessionCompleteResult::UnknownError); return; } JoinSessionCompleteDelegateHandle = SessionInterface-\u003eAddOnJoinSessionCompleteDelegate_Handle(JoinSessionCompleteDelegate); Result.Session.SessionSettings.bUseLobbiesIfAvailable = true; Result.Session.SessionSettings.bUsesPresence = true; const ULocalPlayer* LocalPlayer = GetWorld()-\u003eGetFirstLocalPlayerFromController(); if(!SessionInterface-\u003eJoinSession(*LocalPlayer-\u003eGetPreferredUniqueNetId(), NAME_GameSession, Result)) { SessionInterface-\u003eClearOnJoinSessionCompleteDelegate_Handle(JoinSessionCompleteDelegateHandle); MultiplayerOnJoinSessionComplete.Broadcast(EOnJoinSessionCompleteResult::UnknownError); } } void UMultiplayerSessionsSubsystem::DestroySession() { if(!SessionInterface.IsValid()) { MultiplayerOnDestroySessionComplete.Broadcast(false); return; } DestroySessionCompleteDelegateHandle = SessionInterface-\u003eAddOnDestroySessionCompleteDelegate_Handle(DestroySessionCompleteDelegate); if(!SessionInterface-\u003eDestroySession(NAME_GameSession)) { SessionInterface-\u003eClearOnDestroySessionCompleteDelegate_Handle(DestroySessionCompleteDelegateHandle); MultiplayerOnDestroySessionComplete.Broadcast(false); } } void UMultiplayerSessionsSubsystem::OnCreateSessionComplete(FName SessionName, bool bWasSuccessful) { if(SessionInterface) { SessionInterface-\u003eClearOnCreateSessionCompleteDelegate_Handle(CreateSessionCompleteDelegateHandle); } MultiplayerOnCreateSessionComplete.Broadcast(bWasSuccessful); } void UMultiplayerSessionsSubsystem::OnFindSessionsComplete(bool bWasSuccessful) { if(SessionInterface) { SessionInterface-\u003eClearOnFindSessionsCompleteDelegate_Handle(FindSessionsCompleteDelegateHandle); } if(LastSessionSearch-\u003eSearchResults.Num() \u003c= 0) { MultiplayerOnFindSessionsComplete.Broadcast(TArray\u003cFOnlineSessionSearchResult\u003e(), false); return; } MultiplayerOnFindSessionsComplete.Broadcast(LastSessionSearch-\u003eSearchResults, bWasSuccessful); } void UMultiplayerSessionsSubsystem::OnJoinSessionComplete(FName SessionName, EOnJoinSessionCompleteResult::Type Result) { if(SessionInterface) { SessionInterface-\u003eClearOnJoinSessionCompleteDelegate_Handle(JoinSessionCompleteDelegateHandle); } MultiplayerOnJoinSessionComplete.Broadcast(Result); } void UMultiplayerSessionsSubsystem::OnDestroySessionComplete(FName SessionName, bool bWasSuccessful) { if(SessionInterface) { SessionInterface-\u003eClearOnDestroySessionCompleteDelegate_Handle(DestroySessionCompleteDelegateHandle); } if(bWasSuccessful \u0026\u0026 bCreateSessionOnDestroy) { bCreateSessionOnDestroy = false; CreateSession(LastNumPublicConnections, LastMatchType); } MultiplayerOnDestroySessionComplete.Broadcast(bWasSuccessful); } 首先，这里和官方实现的主要差别在：UMultiplayerSessionsSubsystem::JoinSession部分，在其中，使用了拷贝的FOnlineSessionSearchResult类型，并且重新进行了一些设定，进行设定后，在测试的版本中可以顺利加入游戏，否则不能。\n接下来对代码内容进行说明：\n在构造函数中，对各种Delegate进行了初始化，注意到这里的回调函数都是非动态的； CreateSession的实现中，如果当前还有未删除的session，就保存当前的参数，执行DestroySession，并在实现后的回调函数中进行判断并再次创建Session，如果直接在CreateSession中删除并创建，会导致Destroy还未成功就进行创建，导致创建失败。 NAME_GameSession是一个宏，在这里作为session的固定名字； 在Session操作开始时，将代理进行绑定，而当操作成功的回调或者操作失败时，就通过Handle清除对应的代理，防止重复触发； 对于自定义代理，需要在操作成功或者失败时进行广播（Broadcast）操作 无缝传送 非无缝传送（Non-Seamless Travel）\n客户端断开与服务器的连接 客户端重新连接到同一个服务器 非无缝传送发生的情况：\n第一次加载地图时 第一次连接到服务器时 结束一场多人游戏并开始新游戏时 无缝传送（Seamless Travel）\n带来更流畅的游戏体验 避免任何重新连接问题（例如玩家在切换地图时被踢出） 1 2 // 在GameMode中启用 bUseSeamlessTravel = true; 需要一个过渡地图（transition map），用于在主地图切换时承载玩家状态 在任何时刻必须有地图被加载，以保证传送过程不中断，系统正常运行，同时可以不同时加载两个大型地图 多人游戏中的关卡切换（Travel in Multiplayer） 1. UWorld::ServerTravel\n仅限服务器端调用 将服务器跳转至一个新关卡 所有已连接的客户端都会跟随切换 服务器会调用 APlayerController::ClientTravel 2. APlayerController::ClientTravel\n当客户端调用时：连接到一个新的服务器 当服务器调用时：使特定玩家切换到一个新地图 接下来以大厅实现的LobbyGameMode为例，说明实现：\n1 2 3 4 5 6 7 8 // .h UCLASS() class BLASTERS_API ALobbyGameMode : public AGameMode { GENERATED_BODY() public: virtual void PostLogin(APlayerController* NewPlayer) override; }; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // .cpp void ALobbyGameMode::PostLogin(APlayerController* NewPlayer) { Super::PostLogin(NewPlayer); int32 NumberOfPlayers = GameState.Get()-\u003ePlayerArray.Num(); if(NumberOfPlayers == 2) { UWorld* World = GetWorld(); if(World) { bUseSeamlessTravel = true; World-\u003eServerTravel(FString(\"/Game/Maps/BlasterMap?listen\")); } } } 随后可以在此基础上新建一个蓝图GameMode，并且设置默认角色等内容。\n同时，需要设置一个过渡关卡，新建空关卡并且在设置中设置Transition Level为本关卡\n打印NetworkRole 对于Pawn和character，它们在服务端和客户端中的网络角色会有不同，分为\n角色类型 控制权 所在位置 用途 ROLE_Authority 服务器 服务器 控制游戏逻辑，广播状态 ROLE_AutonomousProxy 客户端 本地玩家客户端 接收输入，发送请求到服务器 ROLE_SimulatedProxy 客户端 其他客户端玩家 显示服务器同步的玩家动作 ROLE_None 无 本地（非网络参与） 本地临时对象、不同步 为了在玩家头顶显示不同段中所有玩家的Role，首先设计一个UserWidget（包括C++以及对应蓝图），随后将这些蓝图附加在角色上，同时在角色的C++类中也要创建\n1 2 3 4 5 6 7 // .h UPROPERTY(EditAnywhere, BlueprintReadOnly, meta=(AllowPrivateAccess=\"true\")) class UWidgetComponent* OverheadWidget; // .cpp 构造函数 OverheadWidget = CreateDefaultSubobject\u003cUWidgetComponent\u003e(TEXT(\"OverheadWidget\")); OverheadWidget-\u003eSetupAttachment(RootComponent); 随后在Widget中进行相关的代码实现\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 // .h UCLASS() class BLASTERS_API UOverheadWidget : public UUserWidget { GENERATED_BODY() public: UPROPERTY(meta=(BindWidget)) class UTextBlock* DisplayText; void SetDisplayText(FString TextToDisplay); UFUNCTION(BlueprintCallable) void ShowPlayerRole(APawn* InPawn); protected: virtual void NativeDestruct() override; }; // .cpp void UOverheadWidget::SetDisplayText(FString TextToDisplay) { if(DisplayText) { DisplayText-\u003eSetText(FText::FromString(TextToDisplay)); } } void UOverheadWidget::ShowPlayerRole(APawn* InPawn) { if(InPawn) { // ENetRole RemoteRole = InPawn-\u003eGetRemoteRole(); ENetRole LocalRole = InPawn-\u003eGetLocalRole(); FString Role; switch(LocalRole) { case ENetRole::ROLE_Authority: Role = FString(\"Authority\"); break; case ENetRole::ROLE_AutonomousProxy: Role = FString(\"AutonomousProxy\"); break; case ENetRole::ROLE_SimulatedProxy: Role = FString(\"SimulatedProxy\"); break; case ENetRole::ROLE_None: Role = FString(\"None\"); break; } SetDisplayText(FString::Printf(TEXT(\"Local Role: %s\"), *Role)); } } void UOverheadWidget::NativeDestruct() { RemoveFromParent(); Super::NativeDestruct(); } 最后在蓝图中实现\n变量复制 接下来以bIsAiming这个和角色动画有关的变量说明如何将变量传递到服务器和客户端\n为了编译管理和武器装备有关的变量，设置一个CombatComponent，因为其中的变量需要复制到客户端，所以创建的时候需要设置该组件可复制\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // CombatComponent.h class BLASTERS_API UCombatComponent : public UActorComponent // CombatComponent.cpp UPROPERTY(Replicated) bool bAiming; // BlasterCharacter.h UPROPERTY(VisibleAnywhere) class UCombatComponent* Combat; // BlasterCharacter.cpp ABlasterCharacter::ABlasterCharacter() { // ... Combat = CreateDefaultSubobject\u003cUCombatComponent\u003e(TEXT(\"CombatComponent\")); Combat-\u003eSetIsReplicated(true); // ... } 通过SetIsReplicated(true)，该组件下的相关内容就可以标记为可复制.\n将输入关联到函数中，并且由函数修改相关变量\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 void ABlasterCharacter::SetupPlayerInputComponent(UInputComponent* PlayerInputComponent) { Super::SetupPlayerInputComponent(PlayerInputComponent); PlayerInputComponent-\u003eBindAction(\"Aim\", IE_Pressed, this, \u0026ABlasterCharacter::AimButtonPressed); PlayerInputComponent-\u003eBindAction(\"Aim\", IE_Released, this, \u0026ABlasterCharacter::AimButtonReleased); } void ABlasterCharacter::AimButtonPressed() { if(Combat) { Combat-\u003eSetAiming(true); } } void ABlasterCharacter::AimButtonReleased() { if(Combat) { Combat-\u003eSetAiming(false); } } 该方法确保了只有在实际装备武器的时候才执行相关变量修改命令，对应的函数如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // .h void SetAiming(bool bIsAiming); UFUNCTION(Server, Reliable) void ServerSetAiming(bool bIsAiming); // .cpp void UCombatComponent::SetAiming(bool bIsAiming) { // 这里首先进行设置是为了保证客户端可以立即获得反馈 bAiming = bIsAiming; // 客户端和服务端调用都在服务端执行 ServerSetAiming(bIsAiming); if (Character) { Character-\u003eGetCharacterMovement()-\u003eMaxWalkSpeed = bIsAiming ? AimWalkSpeed : BaseWalkSpeed; } } void UCombatComponent::ServerSetAiming_Implementation(bool bIsAiming) { bAiming = bIsAiming; if (Character) { Character-\u003eGetCharacterMovement()-\u003eMaxWalkSpeed = bIsAiming ? AimWalkSpeed : BaseWalkSpeed; } } 其中在声明中的Server表示该行为只在服务器端执行，如果在客户端调用了该函数也会变为在服务端执行；\nReliable表示该函数是可靠，并且相对于同一个Actor是有序执行的。\n同时，需要重写GetLifetimeReplicatedProps函数来指定变量复制时的行为\n1 2 3 4 5 6 7 8 9 10 11 // .h public:\tvirtual void GetLifetimeReplicatedProps(TArray\u003cclass FLifetimeProperty\u003e\u0026 OutLifetimeProps) const override; // .cpp void UCombatComponent::GetLifetimeReplicatedProps(TArray\u003cclass FLifetimeProperty\u003e\u0026 OutLifetimeProps) const { Super::GetLifetimeReplicatedProps(OutLifetimeProps); DOREPLIFETIME(UCombatComponent, EquippedWeapon); DOREPLIFETIME(UCombatComponent, bAiming); } 以上的DOREPLIFETIME表示进行无条件复制，再比如ABlasterCharacter::GetLifetimeReplicatedProps 中的DOREPLIFETIME_CONDITION(ABlasterCharacter, OverlappingWeapon, COND_OwnerOnly);表示只复制给Owner.\n同时，OnRep类的函数还可以传递参数，表示上一次复制的值\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // BlasterCharacter.h UPROPERTY(ReplicatedUsing = OnRep_OverlappingWeapon) class AWeapon* OverlappingWeapon; UFUNCTION() void OnRep_OverlappingWeapon(AWeapon* LastWeapon); // BlasterCharacter.cpp void ABlasterCharacter::OnRep_OverlappingWeapon(AWeapon* LastWeapon){ if(OverlappingWeapon){ OverlappingWeapon-\u003eShowPickUpWidget(true); } if(LastWeapon){ LastWeapon-\u003eShowPickUpWidget(false); } } 处理复制过程中的压缩导致的范围变化问题 对于如Rotator中的变量，UE引擎在进行复制的时候，会对其中的浮点数进行压缩，在这个过程中，可能会发生预料之外的情况，比如将一个小于0的角度映射为接近360度的角度，在这种情况下，我们需要再代码中重新将相关范围调整回负数.\n1 2 3 4 5 6 7 8 AO_Pitch = GetBaseAimRotation().Pitch; // 在传输过程中，角度会被缩放到[0, 360]之间，因此需要将其转换为原本设定的区间 if(AO_Pitch \u003e 90.f \u0026\u0026 !IsLocallyControlled()) { FVector2D InRange(270.f, 360.f); FVector2D OutRange(-90.f, 0.f); AO_Pitch = FMath::GetMappedRangeValueClamped(InRange, OutRange, AO_Pitch); } 实现射击功能 对于多人游戏中的设计功能，主要有以下几项需要实现：\n射击时，需要记录发射者屏幕的中心点，并且以此为目标位置发射子弹 发射时，需要有枪口火焰动画，还需要子弹轨迹、抛射弹壳动画等 对于第一种，必须由服务器进行执行，并且使用多播在各台机器上执行\n实现如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 // CombatComponent.h // ... protected: void FireButtonPressed(bool bPressed); UFUNCTION(Server, Reliable) void ServerFire(const FVector_NetQuantize\u0026 TraceHitTarget); UFUNCTION(NetMulticast, Reliable) void MulticastFire(const FVector_NetQuantize\u0026 TraceHitTarget); void TraceUnderCrosshairs(FHitResult\u0026 TraceHitResult); private: class ABlasterCharacter* Character; UPROPERTY(ReplicatedUsing=OnRep_EquippedWeapon) AWeapon* EquippedWeapon; UPROPERTY(Replicated) bool bAiming; bool bFireButtonPressed; // CombatComponent.cpp void UCombatComponent::FireButtonPressed(bool bPressed) { bFireButtonPressed = bPressed; if(bFireButtonPressed) { FHitResult HitResult; TraceUnderCrosshairs(HitResult); ServerFire(HitResult.ImpactPoint); } } void UCombatComponent::TraceUnderCrosshairs(FHitResult\u0026 TraceHitResult) { FVector2D ViewportSize; if(GEngine \u0026\u0026 GEngine-\u003eGameViewport) { GEngine-\u003eGameViewport-\u003eGetViewportSize(ViewportSize); } FVector2D CrosshairLocation(ViewportSize.X / 2.f, ViewportSize.Y / 2.f); FVector CrosshairWorldPosition; FVector CrosshairWorldDirection; bool bScreenToWorld = UGameplayStatics::DeprojectScreenToWorld( UGameplayStatics::GetPlayerController(this, 0), CrosshairLocation, CrosshairWorldPosition, CrosshairWorldDirection ); if(bScreenToWorld) { FVector Start = CrosshairWorldPosition; FVector End = Start + CrosshairWorldDirection * TRACE_LENGTH; GetWorld()-\u003eLineTraceSingleByChannel( TraceHitResult, Start, End, ECC_Visibility ); if(!TraceHitResult.bBlockingHit) { TraceHitResult.ImpactPoint = End; } } } void UCombatComponent::ServerFire_Implementation(const FVector_NetQuantize\u0026 TraceHitTarget) { MulticastFire(TraceHitTarget); } void UCombatComponent::MulticastFire_Implementation(const FVector_NetQuantize\u0026 TraceHitTarget) { if(EquippedWeapon == nullptr || Character == nullptr) return; Character-\u003ePlayFireMontage(bAiming); EquippedWeapon-\u003eFire(TraceHitTarget); } 多播函数的作用是：如果在服务端运行，则会在服务端和客户端所有机器上调用（如果在客户端，那么只在调用的机器上执行），这种通过多播执行了播放开火动画的功能。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 void AWeapon::Fire(const FVector\u0026 HitTarget) { if(FireAnimation) WeaponMesh-\u003ePlayAnimation(FireAnimation, false); if (CasingClass) { const USkeletalMeshSocket* AmmoEjectSocket = WeaponMesh-\u003eGetSocketByName(FName(\"AmmoEject\")); if (AmmoEjectSocket) { FTransform SocketTransform = AmmoEjectSocket-\u003eGetSocketTransform(WeaponMesh); UWorld* World = GetWorld(); if (World) { World-\u003eSpawnActor\u003cACasing\u003e( CasingClass, SocketTransform.GetLocation(), SocketTransform.GetRotation().Rotator() ); } } } } 这个函数的作用也是在多播中被调用，执行抛射弹壳等效果动画。\n同时，实际进行设计的武器继承了该类，并且重写了Fire函数，如下所示：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 void AProjectileWeapon::Fire(const FVector\u0026 HitTarget) { Super::Fire(HitTarget); if(!HasAuthority()) return; APawn* InstigatorPawn = Cast\u003cAPawn\u003e(GetOwner()); const USkeletalMeshSocket* MuzzleFlashSocket = GetWeaponMesh()-\u003eGetSocketByName(FName(\"MuzzleFlash\")); if(MuzzleFlashSocket) { FTransform SocketTransform = MuzzleFlashSocket-\u003eGetSocketTransform(GetWeaponMesh()); // From muzzle flash socket to hit location from TraceUnderCrosshairs FVector ToTarget = HitTarget - SocketTransform.GetLocation(); FRotator TargetRotation = ToTarget.Rotation(); if(ProjectileClass \u0026\u0026 InstigatorPawn) { FActorSpawnParameters SpawnParameters; SpawnParameters.Owner = GetOwner(); SpawnParameters.Instigator = InstigatorPawn; if(UWorld* World = GetWorld()) World-\u003eSpawnActor\u003cAProjectile\u003e(ProjectileClass, SocketTransform.GetLocation(), TargetRotation, SpawnParameters); } } } 该函数只在服务端上执行有效功能：发射弹丸\n播放动画Montage 首先创建一个动画Montage 创建一个新的Anim Slot，并修改Default Slot\n在动画蓝图中应用Slot\n随后在代码中设置相关的函数和Montange\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // BlasterCharacter.h UPROPERTY(EditAnywhere, Category = Combat) UAnimMontage* ElimMontage; void PlayElimMontage(); // BlasterCharacter.cpp void ABlasterCharacter::PlayElimMontage() { UAnimInstance* AnimInstance = GetMesh()-\u003eGetAnimInstance(); if(AnimInstance \u0026\u0026 ElimMontage) { AnimInstance-\u003eMontage_Play(ElimMontage); } } 要实现同时在客户端和主机播放动画，需要使用多播。\n首先，片段角色是否死亡，以及是否播放动画位置在主机端，但是实际调用播放动画函数需要在所有段上执行\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 // BlasterCharacter.h void Elim(); UFUNCTION(NetMulticast, Reliable) void MulticastElim(); // BlasterCharacter.cpp void ABlasterCharacter::Elim() { if(Combat \u0026\u0026 Combat-\u003eEquippedWeapon) { Combat-\u003eEquippedWeapon-\u003eDropped(); } MulticastElim(); GetWorldTimerManager().SetTimer( ElimTimer, this, \u0026ABlasterCharacter::ElimTimerFinished, ElimDelay ); } void ABlasterCharacter::MulticastElim_Implementation() { bElimmed = true; PlayElimMontage(); if(DissolveMaterialInstance) { DynamicDissolveMaterialInstance = UMaterialInstanceDynamic::Create(DissolveMaterialInstance, this); GetMesh()-\u003eSetMaterial(0, DynamicDissolveMaterialInstance); DynamicDissolveMaterialInstance-\u003eSetScalarParameterValue(TEXT(\"Dissolve\"), 0.55f); DynamicDissolveMaterialInstance-\u003eSetScalarParameterValue(TEXT(\"Glow\"), 200.f); } StartDissolve(); // Disable character movement GetCharacterMovement()-\u003eDisableMovement(); GetCharacterMovement()-\u003eStopMovementImmediately(); if(BlasterPlayerController) { DisableInput(BlasterPlayerController); } // Disable collision GetCapsuleComponent()-\u003eSetCollisionEnabled(ECollisionEnabled::NoCollision); GetMesh()-\u003eSetCollisionEnabled(ECollisionEnabled::NoCollision); // Spawn elim bot if (ElimBotEffect) { FVector ElimBotSpawnPoint(GetActorLocation().X, GetActorLocation().Y, GetActorLocation().Z + 200.f); ElimBotComponent = UGameplayStatics::SpawnEmitterAtLocation( GetWorld(), ElimBotEffect, ElimBotSpawnPoint, GetActorRotation() ); } if (ElimBotSound) { UGameplayStatics::SpawnSoundAtLocation( this, ElimBotSound, GetActorLocation() ); } } 除此之外，也可以在变量被改变的时候播放动画，实现在所有机器上播放的效果，比如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // BlasterCharacter.cpp void ABlasterCharacter::ReceiveDamage(AActor* DamagedActor, float Damage, const UDamageType* DamageType, class AController* InstigatorController, AActor* DamageCauser) { Health = FMath::Clamp(Health - Damage, 0.f, MaxHealth); UpdateHUDHealth(); PlayHitReactMontage(); if(Health \u003c= 0.f) { ABlasterGameMode* BlasterGameMode = GetWorld()-\u003eGetAuthGameMode\u003cABlasterGameMode\u003e(); if(BlasterGameMode) { BlasterPlayerController = BlasterPlayerController == nullptr ? Cast\u003cABlasterPlayerController\u003e(Controller) : BlasterPlayerController; ABlasterPlayerController* AttackerController = Cast\u003cABlasterPlayerController\u003e(InstigatorController); BlasterGameMode-\u003ePlayerEliminated(this, BlasterPlayerController, AttackerController); } } } void ABlasterCharacter::OnRep_Health() { UpdateHUDHealth(); PlayHitReactMontage(); } 实现击杀计分 当服务器上角色生命值小于0时，会调用BlasterGameMode-\u003ePlayerEliminated(this, BlasterPlayerController, AttackerController);方法，之所以不直接在角色上调用是因为之后可能会删除角色\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 void ABlasterGameMode::PlayerEliminated(ABlasterCharacter* ElimmedCharacter, ABlasterPlayerController* VictimController, ABlasterPlayerController* AttackerController) { if(AttackerController == nullptr || AttackerController-\u003ePlayerState == nullptr) return; if(VictimController == nullptr || VictimController-\u003ePlayerState == nullptr) return; ABlasterPlayerState* AttackerPlayerState = AttackerController ? Cast\u003cABlasterPlayerState\u003e(AttackerController-\u003ePlayerState) : nullptr; ABlasterPlayerState* VictimPlayerState = VictimController ? Cast\u003cABlasterPlayerState\u003e(VictimController-\u003ePlayerState) : nullptr; if(AttackerPlayerState \u0026\u0026 AttackerPlayerState != VictimPlayerState) { AttackerPlayerState-\u003eAddToScore(1.f); } if(VictimPlayerState) { VictimPlayerState-\u003eAddToDefeats(1); } if(ElimmedCharacter) { ElimmedCharacter-\u003eElim(); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 void ABlasterPlayerState::AddToScore(float ScoreAmount) { SetScore(GetScore() + ScoreAmount); Character = Character == nullptr ? Cast\u003cABlasterCharacter\u003e(GetPawn()) : Character; if(Character) { Controller = Controller == nullptr ? Cast\u003cABlasterPlayerController\u003e(Character-\u003eController) : Controller; if(Controller) { Controller-\u003eSetHUDScore(GetScore()); } } } void ABlasterPlayerState::AddToDefeats(int32 DefeatsAmount) { Defeats += DefeatsAmount; Character = Character == nullptr ? Cast\u003cABlasterCharacter\u003e(GetPawn()) : Character; if(Character) { Controller = Controller == nullptr ? Cast\u003cABlasterPlayerController\u003e(Character-\u003eController) : Controller; if(Controller) { Controller-\u003eSetHUDDefeats(Defeats); } } } 代码中的Score是PlayerState自带的复制变量，而Defeats是自定义变量，需要手动声明复制以及实现OnRep函数，而Score在复制时的操作也可以进行重写\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 void ABlasterPlayerState::GetLifetimeReplicatedProps(TArray\u003cFLifetimeProperty\u003e\u0026 OutLifetimeProps) const { Super::GetLifetimeReplicatedProps(OutLifetimeProps); DOREPLIFETIME(ABlasterPlayerState, Defeats); } void ABlasterPlayerState::OnRep_Score() { Super::OnRep_Score(); Character = Character == nullptr ? Cast\u003cABlasterCharacter\u003e(GetPawn()) : Character; if(Character) { Controller = Controller == nullptr ? Cast\u003cABlasterPlayerController\u003e(Character-\u003eController) : Controller; if(Controller) { Controller-\u003eSetHUDScore(GetScore()); } } } void ABlasterPlayerState::OnRep_Defeats() { Character = Character == nullptr ? Cast\u003cABlasterCharacter\u003e(GetPawn()) : Character; if(Character \u0026\u0026 Character-\u003eController) { Controller = Controller == nullptr ? Cast\u003cABlasterPlayerController\u003e(Character-\u003eController) : Controller; if(Controller) { Controller-\u003eSetHUDDefeats(Defeats); } } } 击杀回调函数与重生 在角色死亡后，一般不会离开重生，因此需要调用回调函数（见播放动画Montage），回调函数中会进行重生相关实现\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 void ABlasterCharacter::ElimTimerFinished() { ABlasterGameMode* BlasterGameMode = GetWorld()-\u003eGetAuthGameMode\u003cABlasterGameMode\u003e(); if(BlasterGameMode) { BlasterGameMode-\u003eRequestRespawn(this, Controller); } } void ABlasterGameMode::RequestRespawn(ACharacter* ElimmedCharacter, AController* ElimmedController) { if(ElimmedCharacter) { ElimmedCharacter-\u003eReset(); ElimmedCharacter-\u003eDestroy(); } if(ElimmedController) { TArray\u003cAActor*\u003e PlayerStarts; UGameplayStatics::GetAllActorsOfClass(this, APlayerStart::StaticClass(), PlayerStarts); int32 Selection = FMath::RandRange(0, PlayerStarts.Num() - 1); RestartPlayerAtPlayerStart(ElimmedController, PlayerStarts[Selection]); } } 客户端服务器同步倒计时 在服务器和客户端上，都可以通过 GetWorld()-\u003eGetTimeSeconds()获得时间，以此可以获得倒计时\n1 SetHUDMatchCountdown(MatchTime - GetWorld()-\u003eGetTimeSeconds()); 但是，由于服务器和客户端加载时间不同，即使不存在网络延迟，倒计时也不一致\n解决的方法是：\n客户端向服务器发送请求服务器时间的请求，参数为客户端当前时间； 服务器调用客户端上的函数，参数为当前时间和客户端传来的时间 客户端根据参数中的客户端时间，可以估算出RTT时间，以一半的RTT加上服务器的时间，可以估算当前服务器时间 实际操作中，客户端在游戏开始时和间隔若干秒时间调用一次操作，以保证和服务器的时间同步，具体实现如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // BlasterPlayerController.cpp float ABlasterPlayerController::GetServerTime() { if(HasAuthority()) return GetWorld()-\u003eGetTimeSeconds(); return GetWorld()-\u003eGetTimeSeconds() + ClientServerDelta; } void ABlasterPlayerController::ReceivedPlayer() { Super::ReceivedPlayer(); if(IsLocalController()) { ServerRequestServerTime(GetWorld()-\u003eGetTimeSeconds()); } } void ABlasterPlayerController::Tick(float DeltaTime) { Super::Tick(DeltaTime); SetHUDTime(); CheckTimeSync(DeltaTime); } void ABlasterPlayerController::CheckTimeSync(float DeltaTime) { TimeSyncRunningTime += DeltaTime; if (IsLocalController() \u0026\u0026 TimeSyncRunningTime \u003e TimeSyncFrequency) { ServerRequestServerTime(GetWorld()-\u003eGetTimeSeconds()); TimeSyncRunningTime = 0.f; } } void ABlasterPlayerController::ServerRequestServerTime_Implementation(float TimeOfClientRequest) { float ServerTimeOfReceipt = GetWorld()-\u003eGetTimeSeconds(); ClientReportServerTime(TimeOfClientRequest, ServerTimeOfReceipt); } void ABlasterPlayerController::ClientReportServerTime_Implementation(float TimeOfClientRequest, float TimeServerReceivedClientRequest) { float RoundTripTime = GetWorld()-\u003eGetTimeSeconds() - TimeOfClientRequest; float CurrentServerTime = TimeServerReceivedClientRequest + (0.5f * RoundTripTime); ClientServerDelta = CurrentServerTime - GetWorld()-\u003eGetTimeSeconds(); } GameMode和MatchState UE中，每个关卡可以设定GameMode，其中，GameModeBase可以设定Player Controller, Pawn等关卡默认内容，也可以通过继承处理与游戏关卡有关的逻辑，比如记录时间等；GameMode继承自GameModeBase，额外包含了MatchState有关内容。\nMatchState命名空间中包含了各种游戏状态，包括在Gamemode.h中的\n1 2 3 4 5 6 7 8 9 10 11 12 namespace MatchState { extern ENGINE_API const FName EnteringMap;\t// We are entering this map, actors are not yet ticking extern ENGINE_API const FName WaitingToStart;\t// Actors are ticking, but the match has not yet started extern ENGINE_API const FName InProgress;\t// Normal gameplay is occurring. Specific games will have their own state machine inside this state extern ENGINE_API const FName WaitingPostMatch;\t// Match has ended so we aren't accepting new players, but actors are still ticking extern ENGINE_API const FName LeavingMap;\t// We are transitioning out of the map to another location extern ENGINE_API const FName Aborted;\t// Match has failed due to network issues or other problems, cannot continue // If a game needs to add additional states, you may need to override HasMatchStarted and HasMatchEnded to deal with the new states // Do not add any states before WaitingToStart or after WaitingPostMatch } 除此之外，我们还可以自定义MatchState，不过，我们只能在WaitingToStart之后WaitingPostMatch之前添加自定义状态。\n自定义的方法如下：\n1 2 3 4 5 6 7 8 9 10 11 // BlasterGameMode.h namespace MatchState { extern BLASTERS_API const FName Cooldown; // Match duration has been reached. Display winner and begin cooldown timer. } // BlasterGameMode.cpp namespace MatchState { const FName Cooldown = FName(\"Cooldown\"); } 由于Gamemode只存在于主机上，因此可以通过调用每个Player Controller中的自定义MatchState变量，通过将controller上的MatchState变量声明为复制，并且添加相应的回调函数，使得每个玩家都获取到相关信息\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // BlasterGameMode.h virtual void OnMatchStateSet() override; // BlasterGameMode.cpp void ABlasterGameMode::OnMatchStateSet() { Super::OnMatchStateSet(); for(FConstPlayerControllerIterator It = GetWorld()-\u003eGetPlayerControllerIterator(); It; ++It) { ABlasterPlayerController* BlasterPlayer = Cast\u003cABlasterPlayerController\u003e(*It); if(BlasterPlayer) { BlasterPlayer-\u003eOnMatchStateSet(MatchState); } } } // BlasterPlayerController.cpp void ABlasterPlayerController::OnMatchStateSet(FName State) { MatchState = State; if(MatchState == MatchState::InProgress) { HandleMatchHasStarted(); } else if(MatchState == MatchState::Cooldown) { HandleCooldown(); } } 以下是客户端中途加入时获取MatchState等GameMode中存储信息的方法，采用ServerRPC和ClientRPC：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 // BlasterPlayerController.h UFUNCTION(Server, Reliable) void ServerCheckMatchState(); UFUNCTION(Client, Reliable) void ClientJoinMidgame(FName StateOfMatch, float Warmup, float Match, float Cooldown, float StartingTime); // BlasterPlayerController.cpp void ABlasterPlayerController::BeginPlay() { Super::BeginPlay(); BlasterHUD = Cast\u003cABlasterHUD\u003e(GetHUD()); ServerCheckMatchState(); } void ABlasterPlayerController::ServerCheckMatchState_Implementation() { ABlasterGameMode* GameMode = Cast\u003cABlasterGameMode\u003e(UGameplayStatics::GetGameMode(this)); if(GameMode) { WarmupTime = GameMode-\u003eWarmupTime; MatchTime = GameMode-\u003eMatchTime; CooldownTime = GameMode-\u003eCooldownTime; LevelStartingTime = GameMode-\u003eLevelStartingTime; MatchState = GameMode-\u003eGetMatchState(); ClientJoinMidgame(MatchState, WarmupTime, MatchTime, CooldownTime, LevelStartingTime); } } void ABlasterPlayerController::ClientJoinMidgame_Implementation(FName StateOfMatch, float Warmup, float Match, float Cooldown, float StartingTime) { WarmupTime = Warmup; MatchTime = Match; LevelStartingTime = StartingTime; MatchState = StateOfMatch; CooldownTime = Cooldown; OnMatchStateSet(MatchState); if(BlasterHUD \u0026\u0026 MatchState == MatchState::WaitingToStart) { BlasterHUD-\u003eAddAnnouncement(); } } GameState 类似于PlayerState，可以创建一个GameState保存一句游戏中的关键信息，比如最高分数，获胜玩家。\n通常GameMode对应GameState，GameModeBase对应GameStateBase.\nGameState和GameMode不同之处在于，GameState可以被复制到客户端，比如记录最高分玩家（可能有多个）的数组，可以通过常用的方法被复制：\n1 2 3 4 5 6 7 8 9 10 11 // BlasterGameMode.h virtual void GetLifetimeReplicatedProps(TArray\u003cFLifetimeProperty\u003e\u0026 OutLifetimeProps) const override; UPROPERTY(Replicated) TArray\u003cABlasterPlayerState*\u003e TopScoringPlayers; // BlasterGameMode.cpp void ABlasterGameState::GetLifetimeReplicatedProps(TArray\u003cFLifetimeProperty\u003e\u0026 OutLifetimeProps) const { Super::GetLifetimeReplicatedProps(OutLifetimeProps); DOREPLIFETIME(ABlasterGameState, TopScoringPlayers); } Ping 可以通过自带的函数获得Ping\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 void ABlasterPlayerController::CheckPing(float DeltaTime) { HighPingRunningTime += DeltaTime; if(HighPingRunningTime \u003e CheckPingFrequency) { if (!PlayerState) PlayerState = GetPlayerState\u003cAPlayerState\u003e(); if(PlayerState) { if(PlayerState-\u003eGetPingInMilliseconds() \u003e HighPingThreshold) { HighPingWarning(); PingAnimationRunningTime = 0.f; } } HighPingRunningTime = 0.f; } bool bHighPingAnimationPlaying = BlasterHUD \u0026\u0026 BlasterHUD-\u003eCharacterOverlay \u0026\u0026 BlasterHUD-\u003eCharacterOverlay-\u003eHighPingAnimation \u0026\u0026 BlasterHUD-\u003eCharacterOverlay-\u003eIsAnimationPlaying(BlasterHUD-\u003eCharacterOverlay-\u003eHighPingAnimation); if(bHighPingAnimationPlaying) { PingAnimationRunningTime += DeltaTime; if(PingAnimationRunningTime \u003e HighPingDuration) { StopHighPingWarning(); } } } 这里的获得Ping的用法有几种：\n1 float APlayerState::GetPingInMilliseconds() 该函数作用是将压缩的Ping乘以4\n以及\n1 uint8 APlayerState::GetCompressedPing() 是获得压缩后的Ping\n以上两种方法获得的Ping精度都相对较差，因此要同步时间还是应该使用RTT估算。\n更低延迟的射击实现（客户端预测技术） 为了让客户端在进行射击的时候可以忽略延迟，可以通过重新修改射击流程以进行实现，下面以霰弹枪为例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 void UCombatComponent::Fire() { if(CanFire()) { if(EquippedWeapon) { CrosshairShootingFactor = .75f; switch(EquippedWeapon-\u003eFireType) { case EFireType::EFT_Projectile: FireProjectileWeapon(); break; case EFireType::EFT_HitScan: FireHitScanWeapon(); break; case EFireType::EFT_Shotgun: FireShotgun(); break; } } StartFireTimer(); } } 1 2 3 4 5 6 7 8 9 10 11 void UCombatComponent::FireShotgun() { AShotgun* Shotgun = Cast\u003cAShotgun\u003e(EquippedWeapon); if(Shotgun) { TArray\u003cFVector_NetQuantize\u003e HitTargets; Shotgun-\u003eShotgunTraceEndWithScatter(HitTarget, HitTargets); ShotgunLocalFire(HitTargets); ServerShotgunFire(HitTargets); } } 以上两个函数，都在本地进行执行，Shotgun-\u003eShotgunTraceEndWithScatter(HitTarget, HitTargets);的目的是为了获取霰弹枪的所有射击方向，从而让本地生成弹丸方向。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 void AShotgun::ShotgunTraceEndWithScatter(const FVector\u0026 HitTarget, TArray\u003cFVector_NetQuantize\u003e\u0026 HitTargets) { const USkeletalMeshSocket* MuzzleFlashSocket = GetWeaponMesh()-\u003eGetSocketByName(\"MuzzleFlash\"); if(MuzzleFlashSocket == nullptr) return; const FTransform SocketTransform = MuzzleFlashSocket-\u003eGetSocketTransform(GetWeaponMesh()); const FVector TraceStart = SocketTransform.GetLocation(); const FVector ToTargetNormalized = (HitTarget - TraceStart).GetSafeNormal(); const FVector SphereCenter = TraceStart + ToTargetNormalized * DistanceToSphere; for(uint32 i = 0; i \u003c NumberOfPellets; i++) { const FVector RandVec = UKismetMathLibrary::RandomUnitVector() * FMath::FRandRange(0.f, SphereRadius); const FVector EndLoc = SphereCenter + RandVec; FVector ToEndLoc = EndLoc - TraceStart; ToEndLoc = TraceStart + ToEndLoc * TRACE_LENGTH / ToEndLoc.Size(); HitTargets.Add(ToEndLoc); } } 最后的ServerShotgunFire(HitTargets);的作用就是让服务端执行多播函数，注意在多播函数中，已经执行了LocalFire函数的本机（包括服务端）不需要再执行。\n1 2 3 4 5 6 7 8 9 10 void UCombatComponent::ServerShotgunFire_Implementation(const TArray\u003cFVector_NetQuantize\u003e\u0026 TraceHitTargets) { MulticastShotgunFire(TraceHitTargets); } void UCombatComponent::MulticastShotgunFire_Implementation(const TArray\u003cFVector_NetQuantize\u003e\u0026 TraceHitTargets) { if(Character \u0026\u0026 Character-\u003eIsLocallyControlled()) return; ShotgunLocalFire(TraceHitTargets); } ShotgunLocalFire(HitTargets);的作用是执行实际的射击内容，包括动画、子弹效果和造成伤害，其中，只有主机才有权限造成实际伤害\n1 2 3 4 5 6 7 8 9 10 11 void UCombatComponent::ShotgunLocalFire(const TArray\u003cFVector_NetQuantize\u003e\u0026 TraceHitTargets) { AShotgun* Shotgun = Cast\u003cAShotgun\u003e(EquippedWeapon); if(Shotgun == nullptr || Character == nullptr) return; if(CombatState == ECombatState::ECS_Reloading || CombatState == ECombatState::ECS_Unoccupied) { Character-\u003ePlayFireMontage(bAiming); Shotgun-\u003eFireShotgun(TraceHitTargets); CombatState = ECombatState::ECS_Unoccupied; } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 void AShotgun::FireShotgun(const TArray\u003cFVector_NetQuantize\u003e\u0026 HitTargets) { AWeapon::Fire(FVector()); APawn* OwnerPawn = Cast\u003cAPawn\u003e(GetOwner()); if(OwnerPawn == nullptr) return; AController* InstigatorController = OwnerPawn-\u003eGetController(); const USkeletalMeshSocket* MuzzleFlashSocket = GetWeaponMesh()-\u003eGetSocketByName(\"MuzzleFlash\"); if(MuzzleFlashSocket) { const FTransform SocketTransform = MuzzleFlashSocket-\u003eGetSocketTransform(GetWeaponMesh()); const FVector Start = SocketTransform.GetLocation(); // Maps hit character to number of times hit TMap\u003cABlasterCharacter*, uint32\u003e HitMap; for(FVector_NetQuantize HitTarget : HitTargets) { FHitResult FireHit; WeaponTraceHit(Start, HitTarget, FireHit); ABlasterCharacter* BlasterCharacter = Cast\u003cABlasterCharacter\u003e(FireHit.GetActor()); if(BlasterCharacter) { if(HitMap.Contains(BlasterCharacter)) { HitMap[BlasterCharacter]++; } else { HitMap.Emplace(BlasterCharacter, 1); } if(ImpactParticles) { UGameplayStatics::SpawnEmitterAtLocation( GetWorld(), ImpactParticles, FireHit.ImpactPoint, FireHit.ImpactNormal.Rotation() ); } if(HitSound) { UGameplayStatics::PlaySoundAtLocation( this, HitSound, FireHit.ImpactPoint, .5f, FMath::FRandRange(-.5f, .5f) ); } } } for(auto HitPair : HitMap) { if(HitPair.Key \u0026\u0026 HasAuthority() \u0026\u0026 InstigatorController) { UGameplayStatics::ApplyDamage( HitPair.Key, // Character that was hit Damage * HitPair.Value, // Multiply Damage by number of times hit InstigatorController, this, UDamageType::StaticClass() ); } } } } 客户端预测在HUD上的实现 为了让客户端在射击的时候可以立即观察到HUD上子弹的变化，而不是等到服务器回传才看到变化，需要使用客户端预测技术。\n以下是具体实现：\n当用户点击开火的时候，首先调用CombatComponent(角色上的一个Actor Component)：\n1 2 3 4 5 6 7 8 9 void UCombatComponent::FireProjectileWeapon() { if (EquippedWeapon) { HitTarget = EquippedWeapon-\u003ebUseScatter ? EquippedWeapon-\u003eTraceEndWithScatter(HitTarget) : HitTarget; LocalFire(HitTarget); ServerFire(HitTarget, EquippedWeapon-\u003eFireDelay); } } 其中ServerFire是一个Server的可靠带验证函数：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 UFUNCTION(Server, Reliable, WithValidation) void ServerFire(const FVector_NetQuantize\u0026 TraceHitTarget, float FireDelay); UFUNCTION(NetMulticast, Reliable) void MulticastFire(const FVector_NetQuantize\u0026 TraceHitTarget); void UCombatComponent::ServerFire_Implementation(const FVector_NetQuantize\u0026 TraceHitTarget, float FireDelay) { MulticastFire(TraceHitTarget); } bool UCombatComponent::ServerFire_Validate(const FVector_NetQuantize\u0026 TraceHitTarget, float FireDelay) { if (EquippedWeapon) { bool bNearlyEqual = FMath::IsNearlyEqual(EquippedWeapon-\u003eFireDelay, FireDelay, 0.001f); return bNearlyEqual; } return true; } 这里验证的目的是为了FireDelay数据没有被篡改。确保多播函数对非本地的客户端或者服务器调用LocalFire\n1 2 3 4 5 void UCombatComponent::MulticastFire_Implementation(const FVector_NetQuantize\u0026 TraceHitTarget) { if (Character \u0026\u0026 Character-\u003eIsLocallyControlled()) return; LocalFire(TraceHitTarget); } LocalCastFire中，调用角色动画以及调用武器的Fire函数：\n1 2 3 4 5 6 7 8 9 10 11 12 void UCombatComponent::LocalFire(const FVector_NetQuantize\u0026 TraceHitTarget) { if (EquippedWeapon == nullptr || Character == nullptr) { return; } if (CombatState == ECombatState::ECS_Unoccupied) { Character-\u003ePlayFireMontage(bAiming); EquippedWeapon-\u003eFire(TraceHitTarget); } } 武器的Fire函数是普通函数，该函数执行播放动画，消耗弹药量（SpendRound）等函数，具体的伤害实现是由子类实现的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 virtual void Fire(const FVector\u0026 HitTarget); void AWeapon::Fire(const FVector\u0026 HitTarget) { if(FireAnimation) { WeaponMesh-\u003ePlayAnimation(FireAnimation, false); } if(CasingClass) { const USkeletalMeshSocket* AmmoEjectSocket = WeaponMesh-\u003eGetSocketByName(FName(\"AmmoEject\")); if(AmmoEjectSocket) { FTransform SocketTransform = AmmoEjectSocket-\u003eGetSocketTransform(WeaponMesh); UWorld* World = GetWorld(); if(World) { World-\u003eSpawnActor\u003cACasing\u003e( CasingClass, SocketTransform.GetLocation(), SocketTransform.GetRotation().Rotator() ); } } } SpendRound(); } SpendRound中，对于客户端，相关的操作包括修改弹药量、更新HUD，对于本机客户端，还要增加当前状态的编号；对于服务端，除了更新弹药和HUD，还要将更新的结果返回客户端，让本机客户端修正HUD\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 void AWeapon::SpendRound() { Ammo = FMath::Clamp(Ammo - 1, 0, MagCapacity); SetHUDAmmo(); if (HasAuthority()) { ClientUpdateAmmo(Ammo); } else if (BlasterOwnerCharacter \u0026\u0026 BlasterOwnerCharacter-\u003eIsLocallyControlled()) { ++Sequence; } } void AWeapon::ClientUpdateAmmo_Implementation(int32 ServerAmmo) { if(HasAuthority()) return; Ammo = ServerAmmo; --Sequence; Ammo -= Sequence; SetHUDAmmo(); } 以上的程序解决了用户在延迟较高的时候不能够及时发射子弹的问题，但是依然存在以下问题：\n假如客户端和服务端的消耗子弹数量不一致，在HUD上以及实际的弹药中会被修正，但是已经发射出去的子弹不会被消除，也包括造成的相关伤害也不会被修正。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 sequenceDiagram autonumber actor Player as 玩家输入 participant OC as 本机客户端(Owner) participant CC as 其他客户端 participant SV as 服务器 participant CCmp as UCombatComponent participant Wpn as AWeapon participant Char as Character participant HUD as HUD Player-\u003e\u003eOC: 点击开火 OC-\u003e\u003eCCmp: FireProjectileWeapon() alt EquippedWeapon 存在 CCmp-\u003e\u003eCCmp: bUseScatter ? TraceEndWithScatter : HitTarget CCmp-\u003e\u003eCCmp: LocalFire(HitTarget) CCmp-\u003e\u003eChar: PlayFireMontage(bAiming) CCmp-\u003e\u003eWpn: Fire(HitTarget) Wpn-\u003e\u003eWpn: WeaponMesh-\u003ePlayAnimation() Wpn-\u003e\u003eWpn: Spawn Casing (AmmoEject Socket) Wpn-\u003e\u003eWpn: SpendRound() Note over OC,HUD: （本机立刻看到开火与HUD变化，降低高延迟体感） CCmp-\u003e\u003eSV: ServerFire(HitTarget, FireDelay) [Server,Reliable,WithValidation] SV-\u003e\u003eSV: ServerFire_Validate(FireDelay≈EquippedWeapon-\u003eFireDelay?) alt 校验通过 SV-\u003e\u003eOC: MulticastFire(HitTarget) [NetMulticast,Reliable] SV-\u003e\u003eCC: MulticastFire(HitTarget) note over OC: IsLocallyControlled()==true → 跳过本机重复播放 alt CC 端 CC-\u003e\u003eCC: MulticastFire_Implementation() CC-\u003e\u003eCC: LocalFire(HitTarget) CC-\u003e\u003eChar: PlayFireMontage() CC-\u003e\u003eWpn: Fire(HitTarget) Wpn-\u003e\u003eWpn: WeaponMesh-\u003ePlayAnimation() Wpn-\u003e\u003eWpn: Spawn Casing Wpn-\u003e\u003eWpn: SpendRound() end else 校验失败 SV--\u003e\u003eOC: 拒绝(不多播) end else 无武器 CCmp--\u003e\u003eOC: 返回(不处理) end 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 flowchart LR %% ---------- Local Client ---------- subgraph LC[Local Client] A[\"Click Fire\"] --\u003e B[\"CombatComponent::FireProjectileWeapon()\"] B --\u003e|\"bUseScatter\"| BS[\"HitTarget = TraceEndWithScatter(HitTarget)\"] BS --\u003e C[\"LocalFire(HitTarget)\"] B --\u003e|\"else\"| C B --\u003e D[\"ServerFire(HitTarget, FireDelay)\"] C --\u003e C1[\"Character::PlayFireMontage(bAiming)\"] C --\u003e C2[\"EquippedWeapon::Fire(HitTarget)\"] C2 --\u003e W1[\"AWeapon::Fire()\"] W1 --\u003e W1a[\"PlayAnimation(FireAnimation)\"] W1 --\u003e W1b[\"Spawn Casing if CasingClass\"] W1 --\u003e W2[\"SpendRound()\"] W2 --\u003e W2a[\"Ammo--, Clamp, SetHUDAmmo\"] W2 --\u003e|\"Client and LocallyControlled\"| W2b[\"++Sequence\"] end %% ---------- Server ---------- subgraph SV[Server] D --\u003e V[\"ServerFire_Validate\"] V --\u003e|\"Not NearlyEqual(FireDelay)\"| RJ[\"Reject\"] V --\u003e|\"NearlyEqual\"| IMPL[\"ServerFire_Implementation\"] IMPL --\u003e MCast[\"MulticastFire(HitTarget)\"] MCast --\u003e MS[\"MulticastFire_Implementation\"] MS --\u003e|\"IsLocallyControlled\"| RET[\"return\"] end %% ---------- Remote Clients ---------- subgraph RC[Remote Clients] MCast --\u003e RM0[\"MulticastFire_Implementation\"] RM0 --\u003e RM1[\"LocalFire(HitTarget)\"] RM1 --\u003e RM2[\"Character::PlayFireMontage(bAiming)\"] RM1 --\u003e RM3[\"EquippedWeapon::Fire(HitTarget)\"] RM3 --\u003e RM4[\"SpendRound()\"] RM4 --\u003e RM5[\"Ammo--, Clamp, SetHUDAmmo\"] end %% ---------- Ammo/HUD Sync ---------- subgraph Sync[Ammo/HUD Sync] W2 --\u003e|\"Server Authority\"| RPC[\"ClientUpdateAmmo(Ammo)\"] RPC --\u003e CU[\"AWeapon::ClientUpdateAmmo_Implementation\"] CU --\u003e CU1[\"Ammo = ServerAmmo; --Sequence; Ammo -= Sequence; SetHUDAmmo\"] end 服务器回滚（延迟补偿技术） 在存在延迟的情况下，当客户端击中了某个对象时，在服务器上实际并未击中。为了让高延迟玩家在击中对方时拥有比较好的体验，可以引入服务器回滚技术。\n服务器回滚技术在主机端存储所有角色（的碰撞箱）的短时间内的历史记录，客户端在击中对象之后，将击中对象的信息，击中时间（客户端估计的服务器时间）等信息发送给服务器（使用Server RPC）； 服务器使用一个双向链表（UE中的TDoubleLinkedList\u003c\u003e）存储每个玩家在某个时间的信息，并且将玩家显示的击中时间和对应的碰撞箱子进行匹配（我认为在服务器帧率够高的情况下可以不进行插值以简化计算），选择两个最接近的帧进行插值，得到这个时间所对应的Box。 将现在的Box替换成回滚的Box，进行射线检测，如果击中则判定造成伤害，没有击中则不造成伤害。（这里根据不同部位造成的不同伤害进行多次判定，比如只将头部的Box设置为有碰撞进行检测，然后再将所有Box进行检测） 将现在的Box替换回来，取消掉碰撞检测。 服务器回滚的优点在于当玩家延迟较高时，不会产生客户端看上去击中，但是实际没有命中的现象，缺点在于当客户端玩家延迟过高时，其他玩家会发现自己进入掩体后仍然会受到伤害，这明显降低了其他玩家的体验，所以需要进行权衡。\n一种解决方案是服务器控制存储的历史记录的范围，当客户端传来的命中纪录超出该范围后就不进行回滚，这时玩家需要根据根据自己的延迟进行预判射击。\n下面是实现例子：\n首先是存储每一帧的数据结构：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 USTRUCT(BlueprintType) struct FBoxInformation { GENERATED_BODY() UPROPERTY() FVector Location; UPROPERTY() FRotator Rotation; UPROPERTY() FVector BoxExtent; }; USTRUCT(BlueprintType) struct FFramePackage { GENERATED_BODY() UPROPERTY() float Time; UPROPERTY() TMap\u003cFName, FBoxInformation\u003e HitBoxInfo; }; 然后是返回的命中结果（区分爆头和普通命中）\n1 2 3 4 5 6 7 8 9 10 11 USTRUCT(BlueprintType) struct FServerSideRewindResult { GENERATED_BODY() UPROPERTY() bool bHitConfirmed; UPROPERTY() bool bHeadShot; }; 接下来是相应的实现，放在一个Actor Component中：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 void ULagCompensationComponent::ServerScoreRequest_Implementation(ABlasterCharacter* HitCharacter, const FVector_NetQuantize\u0026 TraceStart, const FVector_NetQuantize\u0026 HitLocation, float HitTime, class AWeapon* DamageCauser) { FServerSideRewindResult Confirm = ServerSideRewind(HitCharacter, TraceStart, HitLocation, HitTime); if (Character \u0026\u0026 HitCharacter \u0026\u0026 DamageCauser \u0026\u0026 Confirm.bHitConfirmed) { UGameplayStatics::ApplyDamage( HitCharacter, DamageCauser-\u003eGetDamage(), Character-\u003eController, DamageCauser, UDamageType::StaticClass() ); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 FServerSideRewindResult ULagCompensationComponent::ServerSideRewind(class ABlasterCharacter* HitCharacter, const FVector_NetQuantize\u0026 TraceStart, const FVector_NetQuantize\u0026 HitLocation, float HitTime) { bool bReturn = HitCharacter == nullptr || HitCharacter-\u003eGetLagCompensation() == nullptr || HitCharacter-\u003eGetLagCompensation()-\u003eFrameHistory.GetHead() == nullptr || HitCharacter-\u003eGetLagCompensation()-\u003eFrameHistory.GetTail() == nullptr; if (bReturn) return FServerSideRewindResult(); // Frame package that we check to verify a hit FFramePackage FrameToCheck; bool bShouldInterpolate = true; // Frame history of the HitCharacter const TDoubleLinkedList\u003cFFramePackage\u003e\u0026 History = HitCharacter-\u003eGetLagCompensation()-\u003eFrameHistory; const float OldestHistoryTime = History.GetTail()-\u003eGetValue().Time; const float NewestHistoryTime = History.GetHead()-\u003eGetValue().Time; if (OldestHistoryTime \u003e HitTime) { // too far back - too laggy to do SSR return FServerSideRewindResult(); } if (OldestHistoryTime == HitTime) { FrameToCheck = History.GetTail()-\u003eGetValue(); bShouldInterpolate = false; } if (NewestHistoryTime \u003c= HitTime) { FrameToCheck = History.GetHead()-\u003eGetValue(); bShouldInterpolate = false; } TDoubleLinkedList\u003cFFramePackage\u003e::TDoubleLinkedListNode* Younger = History.GetHead(); TDoubleLinkedList\u003cFFramePackage\u003e::TDoubleLinkedListNode* Older = Younger; while (Older-\u003eGetValue().Time \u003e HitTime) // is Older still younger than HitTime? { // March back until: OlderTime \u003c HitTime \u003c YoungerTime if (Older-\u003eGetNextNode() == nullptr) break; Older = Older-\u003eGetNextNode(); if (Older-\u003eGetValue().Time \u003e HitTime) { Younger = Older; } } if (Older-\u003eGetValue().Time == HitTime) // highly unlikely, but we found our frame to check { FrameToCheck = Older-\u003eGetValue(); bShouldInterpolate = false; } if (bShouldInterpolate) { // Interpolate between Younger and Older FrameToCheck = InterpBetweenFrames(Older-\u003eGetValue(), Younger-\u003eGetValue(), HitTime); } return ConfirmHit(FrameToCheck, HitCharacter, TraceStart, HitLocation); } FFramePackage ULagCompensationComponent::InterpBetweenFrames(const FFramePackage\u0026 OlderFrame, const FFramePackage\u0026 YoungerFrame, float HitTime) { const float Distance = YoungerFrame.Time - OlderFrame.Time; const float InterpFraction = FMath::Clamp((HitTime - OlderFrame.Time) / Distance, 0.f, 1.f); FFramePackage InterpFramePackage; InterpFramePackage.Time = HitTime; for (auto\u0026 YoungerPair : YoungerFrame.HitBoxInfo) { const FName\u0026 BoxInfoName = YoungerPair.Key; const FBoxInformation\u0026 OlderBox = OlderFrame.HitBoxInfo[BoxInfoName]; const FBoxInformation\u0026 YoungerBox = YoungerFrame.HitBoxInfo[BoxInfoName]; FBoxInformation InterpBoxInfo; InterpBoxInfo.Location = FMath::Lerp(OlderBox.Location, YoungerBox.Location, InterpFraction); // 用Quat插值Rotation FQuat QuatA = OlderBox.Rotation.Quaternion(); FQuat QuatB = YoungerBox.Rotation.Quaternion(); InterpBoxInfo.Rotation = FQuat::Slerp(QuatA, QuatB, InterpFraction).Rotator(); InterpBoxInfo.BoxExtent = YoungerBox.BoxExtent; InterpFramePackage.HitBoxInfo.Add(BoxInfoName, InterpBoxInfo); } return InterpFramePackage; } 以下是检查命中的代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 FServerSideRewindResult ULagCompensationComponent::ConfirmHit(const FFramePackage\u0026 Package, ABlasterCharacter* HitCharacter, const FVector_NetQuantize\u0026 TraceStart, const FVector_NetQuantize\u0026 HitLocation) { if (HitCharacter == nullptr) return FServerSideRewindResult(); FFramePackage CurrentFrame; CacheBoxPositions(HitCharacter, CurrentFrame); MoveBoxes(HitCharacter, Package); EnableCharacterMeshCollision(HitCharacter, ECollisionEnabled::NoCollision); // Enable collision for the head first UBoxComponent* HeadBox = HitCharacter-\u003eHitCollisionBoxes[FName(\"head\")]; HeadBox-\u003eSetCollisionEnabled(ECollisionEnabled::QueryAndPhysics); HeadBox-\u003eSetCollisionResponseToChannel(ECollisionChannel::ECC_Visibility, ECollisionResponse::ECR_Block); FHitResult ConfirmHitResult; const FVector TraceEnd = TraceStart + (HitLocation - TraceStart) * 1.25f; UWorld* World = GetWorld(); if (World) { World-\u003eLineTraceSingleByChannel( ConfirmHitResult, TraceStart, TraceEnd, ECollisionChannel::ECC_Visibility ); if (ConfirmHitResult.bBlockingHit) // we hit the head, return early { ResetHitBoxes(HitCharacter, CurrentFrame); EnableCharacterMeshCollision(HitCharacter, ECollisionEnabled::QueryAndPhysics); return FServerSideRewindResult{true, true}; } else // didn't hit head, check the rest of the boxes { for (auto\u0026 HitBoxPair : HitCharacter-\u003eHitCollisionBoxes) { if (HitBoxPair.Value != nullptr) { HitBoxPair.Value-\u003eSetCollisionEnabled(ECollisionEnabled::QueryAndPhysics); HitBoxPair.Value-\u003eSetCollisionResponseToChannel(ECollisionChannel::ECC_Visibility, ECollisionResponse::ECR_Block); } } World-\u003eLineTraceSingleByChannel( ConfirmHitResult, TraceStart, TraceEnd, ECollisionChannel::ECC_Visibility ); if (ConfirmHitResult.bBlockingHit) { ResetHitBoxes(HitCharacter, CurrentFrame); EnableCharacterMeshCollision(HitCharacter, ECollisionEnabled::QueryAndPhysics); return FServerSideRewindResult{true, false}; } } } ResetHitBoxes(HitCharacter, CurrentFrame); EnableCharacterMeshCollision(HitCharacter, ECollisionEnabled::QueryAndPhysics); return FServerSideRewindResult{false, false}; } 下面是工具函数：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 void ULagCompensationComponent::CacheBoxPositions(ABlasterCharacter* HitCharacter, FFramePackage\u0026 OutFramePackage) { if (HitCharacter == nullptr) return; for (auto\u0026 HitBoxPair : HitCharacter-\u003eHitCollisionBoxes) { if (HitBoxPair.Value != nullptr) { FBoxInformation BoxInfo; BoxInfo.Location = HitBoxPair.Value-\u003eGetComponentLocation(); BoxInfo.Rotation = HitBoxPair.Value-\u003eGetComponentRotation(); BoxInfo.BoxExtent = HitBoxPair.Value-\u003eGetScaledBoxExtent(); OutFramePackage.HitBoxInfo.Add(HitBoxPair.Key, BoxInfo); } } } void ULagCompensationComponent::MoveBoxes(ABlasterCharacter* HitCharacter, const FFramePackage\u0026 Package) { if (HitCharacter == nullptr) return; for (auto\u0026 HitBoxPair : HitCharacter-\u003eHitCollisionBoxes) { if (HitBoxPair.Value != nullptr) { HitBoxPair.Value-\u003eSetWorldLocation(Package.HitBoxInfo[HitBoxPair.Key].Location); HitBoxPair.Value-\u003eSetWorldRotation(Package.HitBoxInfo[HitBoxPair.Key].Rotation); HitBoxPair.Value-\u003eSetBoxExtent(Package.HitBoxInfo[HitBoxPair.Key].BoxExtent); } } } void ULagCompensationComponent::ResetHitBoxes(ABlasterCharacter* HitCharacter, const FFramePackage\u0026 Package) { if (HitCharacter == nullptr) return; for (auto\u0026 HitBoxPair : HitCharacter-\u003eHitCollisionBoxes) { if (HitBoxPair.Value != nullptr) { HitBoxPair.Value-\u003eSetWorldLocation(Package.HitBoxInfo[HitBoxPair.Key].Location); HitBoxPair.Value-\u003eSetWorldRotation(Package.HitBoxInfo[HitBoxPair.Key].Rotation); HitBoxPair.Value-\u003eSetBoxExtent(Package.HitBoxInfo[HitBoxPair.Key].BoxExtent); HitBoxPair.Value-\u003eSetCollisionEnabled(ECollisionEnabled::NoCollision); } } } 服务器回滚技术在投射类武器的实现 假如需要对发射的子弹使用服务器回滚技术来提升玩家体验，我们需要两种ProjectTile：复制的和不复制的.\n修正：对于上图中Server-Not Locally Controlled的情况，在武器使用SSR技术的时候，也需要发射SSR的子弹，并在击中目标时进行条件判断自己是否通过造成伤害。\n限制服务器回滚 假设根据变量float HighPingThreshold = 50.f;来修改是否限制服务器回滚，超过该限制则禁用，否则打开服务器回滚\n设置武器回调函数 ​\t由于是否使用服务器回滚技术目前是绑定武器的，所以首先要将武器是否使用回滚技术设置为复制变量，并且设置为复制到武器拥有者\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 UPROPERTY(Replicated, EditAnywhere) bool bUseServerSideRewind = false; UFUNCTION() void OnPingTooHigh(bool bPingTooHigh); void AWeapon::GetLifetimeReplicatedProps(TArray\u003cclass FLifetimeProperty\u003e\u0026 OutLifetimeProps) const { Super::GetLifetimeReplicatedProps(OutLifetimeProps); DOREPLIFETIME(AWeapon, WeaponState); DOREPLIFETIME_CONDITION(AWeapon, bUseServerSideRewind, COND_OwnerOnly); } void AWeapon::OnPingTooHigh(bool bPingTooHigh) { bUseServerSideRewind = !bPingTooHigh; } 设置Controller代理以及广播条件 1 2 3 4 5 6 7 8 9 10 11 DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FHighPingDelegate, bool, bPingTooHigh); UCLASS() class BLASTERS_API ABlasterPlayerController : public APlayerController { GENERATED_BODY() FHighPingDelegate HighPingDelegate; UFUNCTION(Server, Reliable) void ServerReportPingStatus(bool bHighPing); } 在装备或者丢下武器时，绑定或者解绑回调函数\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 void AWeapon::OnEquipped() { ShowPickUpWidget(false); AreaSphere-\u003eSetCollisionEnabled(ECollisionEnabled::NoCollision); WeaponMesh-\u003eSetSimulatePhysics(false); WeaponMesh-\u003eSetEnableGravity(false); WeaponMesh-\u003eSetCollisionEnabled(ECollisionEnabled::NoCollision); if(WeaponType == EWeaponType::EWT_SubmachineGun) { WeaponMesh-\u003eSetCollisionEnabled(ECollisionEnabled::QueryAndPhysics); WeaponMesh-\u003eSetEnableGravity(true); WeaponMesh-\u003eSetCollisionResponseToAllChannels(ECollisionResponse::ECR_Ignore); } EnableCustomDepth(false); BlasterOwnerCharacter = BlasterOwnerCharacter == nullptr ? Cast\u003cABlasterCharacter\u003e(GetOwner()) : BlasterOwnerCharacter; if (BlasterOwnerCharacter \u0026\u0026 bUseServerSideRewind) { BlasterOwnerController = BlasterOwnerController == nullptr ? Cast\u003cABlasterPlayerController\u003e(BlasterOwnerCharacter-\u003eController) : BlasterOwnerController; if (BlasterOwnerController \u0026\u0026 HasAuthority() \u0026\u0026 !BlasterOwnerController-\u003eHighPingDelegate.IsBound()) { BlasterOwnerController-\u003eHighPingDelegate.AddDynamic(this, \u0026AWeapon::OnPingTooHigh); } } } void AWeapon::OnEquippedSecondary() { ShowPickUpWidget(false); AreaSphere-\u003eSetCollisionEnabled(ECollisionEnabled::NoCollision); WeaponMesh-\u003eSetSimulatePhysics(false); WeaponMesh-\u003eSetEnableGravity(false); WeaponMesh-\u003eSetCollisionEnabled(ECollisionEnabled::NoCollision); if(WeaponType == EWeaponType::EWT_SubmachineGun) { WeaponMesh-\u003eSetCollisionEnabled(ECollisionEnabled::QueryAndPhysics); WeaponMesh-\u003eSetEnableGravity(true); WeaponMesh-\u003eSetCollisionResponseToAllChannels(ECollisionResponse::ECR_Ignore); } EnableCustomDepth(true); if(WeaponMesh) { WeaponMesh-\u003eSetCustomDepthStencilValue(CUSTOM_DEPTH_TAN); WeaponMesh-\u003eMarkRenderStateDirty(); } BlasterOwnerCharacter = BlasterOwnerCharacter == nullptr ? Cast\u003cABlasterCharacter\u003e(GetOwner()) : BlasterOwnerCharacter; if (BlasterOwnerCharacter) { BlasterOwnerController = BlasterOwnerController == nullptr ? Cast\u003cABlasterPlayerController\u003e(BlasterOwnerCharacter-\u003eController) : BlasterOwnerController; if (BlasterOwnerController \u0026\u0026 HasAuthority() \u0026\u0026 BlasterOwnerController-\u003eHighPingDelegate.IsBound()) { BlasterOwnerController-\u003eHighPingDelegate.RemoveDynamic(this, \u0026AWeapon::OnPingTooHigh); } } } void AWeapon::OnDropped() { if(HasAuthority()) { AreaSphere-\u003eSetCollisionEnabled(ECollisionEnabled::QueryOnly); } WeaponMesh-\u003eSetSimulatePhysics(true); WeaponMesh-\u003eSetEnableGravity(true); WeaponMesh-\u003eSetCollisionEnabled(ECollisionEnabled::QueryAndPhysics); WeaponMesh-\u003eSetCollisionResponseToAllChannels(ECollisionResponse::ECR_Block); WeaponMesh-\u003eSetCollisionResponseToChannel(ECollisionChannel::ECC_Pawn, ECollisionResponse::ECR_Ignore); WeaponMesh-\u003eSetCollisionResponseToChannel(ECollisionChannel::ECC_Camera, ECollisionResponse::ECR_Ignore); WeaponMesh-\u003eSetCustomDepthStencilValue(CUSTOM_DEPTH_BLUE); WeaponMesh-\u003eMarkRenderStateDirty(); EnableCustomDepth(true); BlasterOwnerCharacter = BlasterOwnerCharacter == nullptr ? Cast\u003cABlasterCharacter\u003e(GetOwner()) : BlasterOwnerCharacter; if (BlasterOwnerCharacter) { BlasterOwnerController = BlasterOwnerController == nullptr ? Cast\u003cABlasterPlayerController\u003e(BlasterOwnerCharacter-\u003eController) : BlasterOwnerController; if (BlasterOwnerController \u0026\u0026 HasAuthority() \u0026\u0026 BlasterOwnerController-\u003eHighPingDelegate.IsBound()) { BlasterOwnerController-\u003eHighPingDelegate.RemoveDynamic(this, \u0026AWeapon::OnPingTooHigh); } } } 此外每隔固定时间也要进行Ping检查，并且调用Server RPC来进行广播\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 void ABlasterPlayerController::CheckPing(float DeltaTime) { if (HasAuthority()) { return; } HighPingRunningTime += DeltaTime; if (HighPingRunningTime \u003e CheckPingFrequency) { if (!PlayerState) { PlayerState = GetPlayerState\u003cAPlayerState\u003e(); } if (PlayerState) { if (PlayerState-\u003eGetPingInMilliseconds() \u003e HighPingThreshold) { HighPingWarning(); PingAnimationRunningTime = 0.f; ServerReportPingStatus(true); } else { ServerReportPingStatus(false); } } HighPingRunningTime = 0.f; } bool bHighPingAnimationPlaying = BlasterHUD \u0026\u0026 BlasterHUD-\u003eCharacterOverlay \u0026\u0026 BlasterHUD-\u003eCharacterOverlay-\u003eHighPingAnimation \u0026\u0026 BlasterHUD-\u003eCharacterOverlay-\u003eIsAnimationPlaying(BlasterHUD-\u003eCharacterOverlay-\u003eHighPingAnimation); if (bHighPingAnimationPlaying) { PingAnimationRunningTime += DeltaTime; if (PingAnimationRunningTime \u003e HighPingDuration) { StopHighPingWarning(); } } } void ABlasterPlayerController::ServerReportPingStatus_Implementation(bool bHighPing) { HighPingDelegate.Broadcast(bHighPing); } ",
  "wordCount" : "6294",
  "inLanguage": "en",
  "datePublished": "2025-05-19T18:02:04+08:00",
  "dateModified": "2025-05-19T18:02:04+08:00",
  "author":{
    "@type": "Person",
    "name": "李睿杰"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://wstfdxfh.github.io/posts/unrealengine/unrealonline/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "李睿杰的博客",
    "logo": {
      "@type": "ImageObject",
      "url": "https://wstfdxfh.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://wstfdxfh.github.io/" accesskey="h" title="李睿杰的博客 (Alt + H)">李睿杰的博客</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://wstfdxfh.github.io/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://wstfdxfh.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://wstfdxfh.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://wstfdxfh.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://wstfdxfh.github.io/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://wstfdxfh.github.io/posts/unrealengine/">UnrealEngine</a></div>
    <h1 class="post-title entry-hint-parent">
      UnrealOnline
    </h1>
    <div class="post-meta"><span title='2025-05-19 18:02:04 +0800 CST'>May 19, 2025</span>&nbsp;·&nbsp;30 min&nbsp;·&nbsp;6294 words&nbsp;·&nbsp;李睿杰

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ae%80%e4%bb%8b" aria-label="简介">简介</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%ae%be%e7%bd%ae" aria-label="配置文件设置">配置文件设置</a></li>
                <li>
                    <a href="#%e6%8f%92%e4%bb%b6%e5%88%9b%e5%bb%ba" aria-label="插件创建">插件创建</a></li>
                <li>
                    <a href="#%e7%9b%ae%e5%bd%95%e7%b1%bb%e4%bb%a3%e7%a0%81" aria-label="目录类代码">目录类代码</a><ul>
                        
                <li>
                    <a href="#%e6%8c%89%e9%92%ae%e7%bb%91%e5%ae%9a" aria-label="按钮绑定">按钮绑定</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0%e5%a3%b0%e6%98%8e%e6%b3%a8%e6%84%8f" aria-label="回调函数声明注意">回调函数声明注意</a></li>
                <li>
                    <a href="#onlinesubsystem%e4%bb%a3%e7%a0%81" aria-label="OnlineSubSystem代码">OnlineSubSystem代码</a></li>
                <li>
                    <a href="#%e6%97%a0%e7%bc%9d%e4%bc%a0%e9%80%81" aria-label="无缝传送">无缝传送</a></li>
                <li>
                    <a href="#%e6%89%93%e5%8d%b0networkrole" aria-label="打印NetworkRole">打印NetworkRole</a></li>
                <li>
                    <a href="#%e5%8f%98%e9%87%8f%e5%a4%8d%e5%88%b6" aria-label="变量复制">变量复制</a></li>
                <li>
                    <a href="#%e5%a4%84%e7%90%86%e5%a4%8d%e5%88%b6%e8%bf%87%e7%a8%8b%e4%b8%ad%e7%9a%84%e5%8e%8b%e7%bc%a9%e5%af%bc%e8%87%b4%e7%9a%84%e8%8c%83%e5%9b%b4%e5%8f%98%e5%8c%96%e9%97%ae%e9%a2%98" aria-label="处理复制过程中的压缩导致的范围变化问题">处理复制过程中的压缩导致的范围变化问题</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%b0%84%e5%87%bb%e5%8a%9f%e8%83%bd" aria-label="实现射击功能">实现射击功能</a></li>
                <li>
                    <a href="#%e6%92%ad%e6%94%be%e5%8a%a8%e7%94%bbmontage" aria-label="播放动画Montage">播放动画Montage</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%87%bb%e6%9d%80%e8%ae%a1%e5%88%86" aria-label="实现击杀计分">实现击杀计分</a></li>
                <li>
                    <a href="#%e5%87%bb%e6%9d%80%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0%e4%b8%8e%e9%87%8d%e7%94%9f" aria-label="击杀回调函数与重生">击杀回调函数与重生</a></li>
                <li>
                    <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%90%8c%e6%ad%a5%e5%80%92%e8%ae%a1%e6%97%b6" aria-label="客户端服务器同步倒计时">客户端服务器同步倒计时</a></li>
                <li>
                    <a href="#gamemode%e5%92%8cmatchstate" aria-label="GameMode和MatchState">GameMode和MatchState</a></li>
                <li>
                    <a href="#gamestate" aria-label="GameState">GameState</a></li>
                <li>
                    <a href="#ping" aria-label="Ping">Ping</a></li>
                <li>
                    <a href="#%e6%9b%b4%e4%bd%8e%e5%bb%b6%e8%bf%9f%e7%9a%84%e5%b0%84%e5%87%bb%e5%ae%9e%e7%8e%b0%e5%ae%a2%e6%88%b7%e7%ab%af%e9%a2%84%e6%b5%8b%e6%8a%80%e6%9c%af" aria-label="更低延迟的射击实现（客户端预测技术）">更低延迟的射击实现（客户端预测技术）</a></li>
                <li>
                    <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e9%a2%84%e6%b5%8b%e5%9c%a8hud%e4%b8%8a%e7%9a%84%e5%ae%9e%e7%8e%b0" aria-label="客户端预测在HUD上的实现">客户端预测在HUD上的实现</a></li>
                <li>
                    <a href="#%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%9b%9e%e6%bb%9a%e5%bb%b6%e8%bf%9f%e8%a1%a5%e5%81%bf%e6%8a%80%e6%9c%af" aria-label="服务器回滚（延迟补偿技术）">服务器回滚（延迟补偿技术）</a><ul>
                        
                <li>
                    <a href="#%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%9b%9e%e6%bb%9a%e6%8a%80%e6%9c%af%e5%9c%a8%e6%8a%95%e5%b0%84%e7%b1%bb%e6%ad%a6%e5%99%a8%e7%9a%84%e5%ae%9e%e7%8e%b0" aria-label="服务器回滚技术在投射类武器的实现">服务器回滚技术在投射类武器的实现</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%99%90%e5%88%b6%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%9b%9e%e6%bb%9a" aria-label="限制服务器回滚">限制服务器回滚</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="简介">简介<a hidden class="anchor" aria-hidden="true" href="#简介">#</a></h2>
<p>相关课程：</p>
<p><a href="https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/">https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/</a></p>
<p>这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。</p>
<p>效果如下：</p>
<!-- raw HTML omitted -->
<p>在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。</p>
<h2 id="配置文件设置">配置文件设置<a hidden class="anchor" aria-hidden="true" href="#配置文件设置">#</a></h2>
<p>在<code>DefaultEngine.ini</code>中，添加以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[/Script/Engine.GameEngine]</span>
</span></span><span class="line"><span class="cl"><span class="na">+NetDriverDefinitions</span><span class="o">=</span><span class="s">(DefName=&#34;GameNetDriver&#34;,DriverClassName=&#34;OnlineSubsystemSteam.SteamNetDriver&#34;,DriverClassNameFallback=&#34;OnlineSubsystemUtils.IpNetDriver&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[OnlineSubsystem]</span>
</span></span><span class="line"><span class="cl"><span class="na">DefaultPlatformService</span><span class="o">=</span><span class="s">Steam</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[OnlineSubsystemSteam]</span>
</span></span><span class="line"><span class="cl"><span class="na">bEnabled</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">SteamDevAppId</span><span class="o">=</span><span class="s">480</span>
</span></span><span class="line"><span class="cl"><span class="na">bInitServerOnClient</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[/Script/OnlineSubsystemSteam.SteamNetDriver]</span>
</span></span><span class="line"><span class="cl"><span class="na">NetConnectionClassName</span><span class="o">=</span><span class="s">&#34;OnlineSubsystemSteam.SteamNetConnection&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>480是一个公用的游戏id</p>
<p>在<code>DefaultGame.ini</code>中添加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[/Script/Engine.GameSession]</span>
</span></span><span class="line"><span class="cl"><span class="na">MaxPlayers</span><span class="o">=</span><span class="s">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>规定了最大玩家数量。</p>
<h2 id="插件创建">插件创建<a hidden class="anchor" aria-hidden="true" href="#插件创建">#</a></h2>
<p>在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：</p>
<p><img alt="image-20250519182751415" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250519182751415.png"></p>
<p>例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。</p>
<p>在创建插件时，选择<code>Blank</code>模板，创建后在<code>MultiplayerSessions.uplugin</code>中添加依赖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">...</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Modules&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;MultiplayerSessions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;Runtime&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;LoadingPhase&#34;</span><span class="p">:</span> <span class="s2">&#34;Default&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">],</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Plugins&#34;</span><span class="p">:[</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;OnlineSubsystem&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Enabled&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;OnlineSubsystemSteam&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Enabled&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>MultiplayerSessions.Build.cs</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnrealBuildTool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">MultiplayerSessions</span> <span class="p">:</span> <span class="n">ModuleRules</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">MultiplayerSessions</span><span class="p">(</span><span class="n">ReadOnlyTargetRules</span> <span class="n">Target</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">PCHUsage</span> <span class="p">=</span> <span class="n">ModuleRules</span><span class="p">.</span><span class="n">PCHUsageMode</span><span class="p">.</span><span class="n">UseExplicitOrSharedPCHs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">PublicIncludePaths</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">PrivateIncludePaths</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">PublicDependencyModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]{</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Core&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;OnlineSubsystem&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;OnlineSubsystemSteam&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;UMG&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Slate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;SlateCore&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">PrivateDependencyModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]{</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;CoreUObject&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Engine&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Slate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;SlateCore&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">DynamicallyLoadedModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]{});</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="目录类代码">目录类代码<a hidden class="anchor" aria-hidden="true" href="#目录类代码">#</a></h2>
<p>创建一个menuC++类，并在此基础上创建一个蓝图</p>
<p>对应蓝图实现如下：</p>
<!-- raw HTML omitted -->
<p>初始关卡蓝图如下：</p>
<!-- raw HTML omitted -->
<p><code>Menu.h</code>代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CoreMinimal.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Blueprint/UserWidget.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Interfaces/OnlineSessionInterface.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Menu.generated.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">UCLASS</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MULTIPLAYERSESSIONS_API</span> <span class="nl">UMenu</span> <span class="p">:</span> <span class="k">public</span> <span class="n">UUserWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">MenuSetup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">       <span class="n">int32</span> <span class="n">NumberOfPublicConnections</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">FString</span> <span class="n">TypeOfMatch</span> <span class="o">=</span> <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;FreeForAll&#34;</span><span class="p">)),</span> <span class="n">FString</span> <span class="n">LobbyPath</span> <span class="o">=</span> <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;/Game/ThirdPerson/Maps/Lobby&#34;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Initialize</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当退出关卡加入大厅时调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">NativeDestruct</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 回调函数，绑定在FMultiplayerOnCreateSessionComplete上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">OnFindSessions</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;&amp;</span> <span class="n">SessionResults</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">OnJoinSession</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">OnDestroySession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">OnStartSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 必须和Editor中名称完全一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">BindWidget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">UButton</span><span class="o">*</span> <span class="n">HostButton</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">BindWidget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">UButton</span><span class="o">*</span> <span class="n">JoinButton</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">HostButtonClicked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">JoinButtonClicked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">MenuTearDown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">UMultiplayerSessionsSubsystem</span><span class="o">*</span> <span class="n">MultiplayerSessionsSubsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">int32</span>   <span class="n">NumPublicConnections</span><span class="p">{</span><span class="mi">4</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">FString</span> <span class="n">MatchType</span><span class="p">{</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;FreeForAll&#34;</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl">    <span class="n">FString</span> <span class="n">PathToLobby</span><span class="p">{</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="按钮绑定">按钮绑定<a hidden class="anchor" aria-hidden="true" href="#按钮绑定">#</a></h3>
<p>对于蓝图中名称和头文件中完全一致的UI控件，可以使用<code>UPROPERTY(meta=(BindWidget))</code>进行自动绑定，这样当蓝图中的按钮被点击时，cpp中的同名称按钮也会被触发，由于<code>UMenu::Initialize</code>函数添加了<code>HostButton-&gt;OnClicked.AddDynamic(this, &amp;ThisClass::HostButtonClicked);</code>绑定，因此会触发相应的回调函数。</p>
<h2 id="回调函数声明注意">回调函数声明注意<a hidden class="anchor" aria-hidden="true" href="#回调函数声明注意">#</a></h2>
<p>这里回调函数中，有部分包含了<code>UFUNCTION</code>声明，有的没有，其中包含了的使用的是动态回调，而没有的则使用普通回调，不能被蓝图使用，这种差别的原因是<code>TArray&lt;&gt;</code>或者<code>EOnJoinSessionCompleteResult::Type</code>的类型不被UE的反射系统支持，而bool则原生支持，所以调用的时候可以使用动态代理的回调。要令上述类型支持动态回调，方法之一是将这些类型作为一个声明了<code>UCLASS</code>,<code>USTRUCT</code>的成员，并且使用<code>UPROPERTY</code>标记，这样可以将类作为参数间接访问相关类型。</p>
<p><code>Menu.cpp</code>代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Menu.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Components/Button.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;MultiplayerSessionsSubsystem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSessionSettings.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSubsystemUtils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">MenuSetup</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumberOfPublicConnections</span><span class="p">,</span> <span class="n">FString</span> <span class="n">TypeOfMatch</span><span class="p">,</span> <span class="n">FString</span> <span class="n">LobbyPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PathToLobby</span> <span class="o">=</span> <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;%s?listen&#34;</span><span class="p">),</span> <span class="o">*</span><span class="n">LobbyPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">NumPublicConnections</span> <span class="o">=</span> <span class="n">NumberOfPublicConnections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">MatchType</span> <span class="o">=</span> <span class="n">TypeOfMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">AddToViewport</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetVisibility</span><span class="p">(</span><span class="n">ESlateVisibility</span><span class="o">::</span><span class="n">Visible</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetIsFocusable</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">World</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">World</span><span class="o">-&gt;</span><span class="n">GetFirstPlayerController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FInputModeUIOnly</span> <span class="n">InputModeData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">InputModeData</span><span class="p">.</span><span class="n">SetWidgetToFocus</span><span class="p">(</span><span class="n">TakeWidget</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">			<span class="n">InputModeData</span><span class="p">.</span><span class="n">SetLockMouseToViewportBehavior</span><span class="p">(</span><span class="n">EMouseLockMode</span><span class="o">::</span><span class="n">DoNotLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetInputMode</span><span class="p">(</span><span class="n">InputModeData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetShowMouseCursor</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">UGameInstance</span><span class="o">*</span> <span class="n">GameInstance</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">GameInstance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span> <span class="o">=</span> <span class="n">GameInstance</span><span class="o">-&gt;</span><span class="n">GetSubsystem</span><span class="o">&lt;</span><span class="n">UMultiplayerSessionsSubsystem</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">AddUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnFindSessions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">AddUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnJoinSession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnDestroySession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnStartSessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnStartSession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">Initialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// AddToViewport不放在该函数的原因是此时尚未完成全部初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Super</span><span class="o">::</span><span class="n">Initialize</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">HostButton</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">HostButton</span><span class="o">-&gt;</span><span class="n">OnClicked</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">HostButtonClicked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">JoinButton</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">OnClicked</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">JoinButtonClicked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">NativeDestruct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">MenuTearDown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">NativeDestruct</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">World</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">World</span><span class="o">-&gt;</span><span class="n">ServerTravel</span><span class="p">(</span><span class="n">PathToLobby</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">HostButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnFindSessions</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;&amp;</span> <span class="n">SessionResults</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">Result</span> <span class="p">:</span> <span class="n">SessionResults</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FString</span> <span class="n">SettingsValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">SessionSettings</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">&#34;MatchType&#34;</span><span class="p">),</span> <span class="n">SettingsValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">SettingsValue</span> <span class="o">==</span> <span class="n">MatchType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">JoinSession</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bWasSuccessful</span> <span class="o">||</span> <span class="n">SessionResults</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnJoinSession</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">IOnlineSubsystem</span><span class="o">*</span> <span class="n">Subsystem</span> <span class="o">=</span> <span class="n">Online</span><span class="o">::</span><span class="n">GetSubsystem</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Subsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">IOnlineSessionPtr</span> <span class="n">SessionInterface</span> <span class="o">=</span> <span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">GetSessionInterface</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FString</span> <span class="n">Address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">GetResolvedConnectString</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">,</span> <span class="n">Address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">ClientTravel</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">TRAVEL_Absolute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Result</span><span class="o">!=</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Success</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">HostButtonClicked</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">HostButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">CreateSession</span><span class="p">(</span><span class="n">NumPublicConnections</span><span class="p">,</span> <span class="n">MatchType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">JoinButtonClicked</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">FindSessions</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">MenuTearDown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">RemoveFromParent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">World</span><span class="o">-&gt;</span><span class="n">GetFirstPlayerController</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FInputModeGameOnly</span> <span class="n">InputModeData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetInputMode</span><span class="p">(</span><span class="n">InputModeData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetShowMouseCursor</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>该代码的注意点如下：</p>
<ol>
<li><code>Initialize</code>函数在创建UI时进行调用，只进行按钮的代理绑定操作，其他初始操作（比如<code>AddToViewport</code>）放到自定义函数；</li>
<li><code>MenuSetup</code>中，调整了一些UI设置，并且获取了<code>UMultiplayerSessionsSubsystem</code>，并且获取其中的代理进行了回调函数的绑定，注意动态回调和非动态的函数区别。</li>
<li>在相关按钮被按下后，按钮被设置为不可用，直到回调中返回结果后才可以再次点击，这是为了防止多次调用内容。</li>
<li><code>UMenu::NativeDestruct</code>函数被调用时，表示用户被移动到其他地图，本地图被移除。</li>
</ol>
<h2 id="onlinesubsystem代码">OnlineSubSystem代码<a hidden class="anchor" aria-hidden="true" href="#onlinesubsystem代码">#</a></h2>
<p><code>MultiplayerSessionsSubsystem.h</code>继承<code>UGameInstanceSubsystem</code>，特点为：</p>
<ol>
<li>是一个单例类</li>
<li>和<code>GameInstance</code>拥有相同的生命周期，游戏开始时创建，结束时销毁</li>
<li>通过继承<code>UGameInstanceSubsystem</code>，而非<code>UGameInstance</code>，可以使具体功能实现解耦</li>
</ol>
<p>实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CoreMinimal.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Subsystems/GameInstanceSubsystem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Interfaces/OnlineSessionInterface.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;MultiplayerSessionsSubsystem.generated.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Delcaring our own custom delegates for the Menu class to bind callbacks to
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnCreateSessionComplete</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLARE_MULTICAST_DELEGATE_TwoParams</span><span class="p">(</span><span class="n">FMultiplayerOnFindSessionsComplete</span><span class="p">,</span> <span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;&amp;</span> <span class="n">SessionResults</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLARE_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnJoinSessionComplete</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnDestroySessionComplete</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnStartSessionComplete</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UCLASS</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MULTIPLAYERSESSIONS_API</span> <span class="nl">UMultiplayerSessionsSubsystem</span> <span class="p">:</span> <span class="k">public</span> <span class="n">UGameInstanceSubsystem</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">UMultiplayerSessionsSubsystem</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// To handle session functionality. The Menu class will call these
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="nf">CreateSession</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumPublicConnections</span><span class="p">,</span> <span class="n">FString</span> <span class="n">MatchType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">FindSessions</span><span class="p">(</span><span class="n">int32</span> <span class="n">MaxSearchResults</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">JoinSession</span><span class="p">(</span><span class="k">const</span> <span class="n">FOnlineSessionSearchResult</span><span class="o">&amp;</span> <span class="n">SessionResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">DestroySession</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">StartSession</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Our own custom delegates for the Menu class to bind callbacks to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FMultiplayerOnCreateSessionComplete</span> <span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FMultiplayerOnFindSessionsComplete</span> <span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FMultiplayerOnJoinSessionComplete</span> <span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FMultiplayerOnDestroySessionComplete</span> <span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FMultiplayerOnStartSessionComplete</span> <span class="n">MultiplayerOnStartSessionComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Internal callbacks for the delegates we&#39;ll add to the Online Session Interface delegate list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// These don&#39;t need to be called outside this class.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="n">OnCreateSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">OnFindSessionsComplete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">OnJoinSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">OnDestroySessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">OnStartSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">IOnlineSessionPtr</span> <span class="n">SessionInterface</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">TSharedPtr</span><span class="o">&lt;</span><span class="n">FOnlineSessionSettings</span><span class="o">&gt;</span> <span class="n">LastSessionSettings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">TSharedPtr</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearch</span><span class="o">&gt;</span> <span class="n">LastSessionSearch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// To add to the Online Session Interface delegate list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// We&#39;ll bind our MultiplayerSessionsSubsystem internal callbacks to these.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FOnCreateSessionCompleteDelegate</span> <span class="n">CreateSessionCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FOnFindSessionsCompleteDelegate</span> <span class="n">FindSessionsCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FOnJoinSessionCompleteDelegate</span> <span class="n">JoinSessionCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FOnDestroySessionCompleteDelegate</span> <span class="n">DestroySessionCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FOnStartSessionCompleteDelegate</span> <span class="n">StartSessionCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">StartSessionCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bCreateSessionOnDestroy</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">int32</span> <span class="n">LastNumPublicConnections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FString</span> <span class="n">LastMatchType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意点如下：</p>
<ol>
<li>代码开始通过宏定义了若干个自定义的代理，这些代理有些是动态多播代理，有些是普通多播代理，原因在于参数的限制。声明代理后需要在类内部进行实例的声明；</li>
<li>在这里声明若干自定义代理的目的是为了让menu的函数可以在各种session任务完成后执行相应的回调函数，同时本类不需要知道具体的实现，实现类之间的解耦；</li>
<li>这里将<code>CreateSession</code>等函数声明为<code>public</code>函数，方便menu直接调用</li>
<li><code>private</code>部分声明了多种代理，用于绑定当相关Session操作完成后会进行回调的函数，和上面的自定义回调进行对比，前面的用于令其他类绑定对应的回调函数，通知者为当前类；当前的代理用来给Session Interface进行绑定，通知者为Interface；</li>
<li>将代理绑定到Session Interface后，返回对应的Handle，这个Handle可以后续将代理进行解绑。</li>
</ol>
<p><img alt="image-20250519215739251" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250519215739251.png"></p>
<p><code>MultiplayerSessionsSubsystem.cpp</code>实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;MultiplayerSessionsSubsystem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSubsystem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSessionSettings.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSubsystemUtils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Online/OnlineSessionNames.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">UMultiplayerSessionsSubsystem</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">CreateSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnCreateSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnCreateSessionComplete</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="n">FindSessionsCompleteDelegate</span><span class="p">(</span><span class="n">FOnFindSessionsCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnFindSessionsComplete</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="n">JoinSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnJoinSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnJoinSessionComplete</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="n">DestroySessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnDestroySessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnDestroySessionComplete</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="n">StartSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnStartSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnStartSessionComplete</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">IOnlineSubsystem</span><span class="o">*</span> <span class="n">Subsystem</span> <span class="o">=</span> <span class="n">Online</span><span class="o">::</span><span class="n">GetSubsystem</span><span class="p">(</span><span class="n">UObject</span><span class="o">::</span><span class="n">GetWorld</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Subsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span> <span class="o">=</span> <span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">GetSessionInterface</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">CreateSession</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumPublicConnections</span><span class="p">,</span> <span class="n">FString</span> <span class="n">MatchType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">ExistingSession</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">GetNamedSession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">ExistingSession</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">bCreateSessionOnDestroy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">LastNumPublicConnections</span> <span class="o">=</span> <span class="n">NumPublicConnections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">LastMatchType</span> <span class="o">=</span> <span class="n">MatchType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DestroySession</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Store the delegate in a FDelegateHandle so we can later remove it from the delegate list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">CreateSessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span> <span class="o">=</span> <span class="n">MakeShareable</span><span class="p">(</span><span class="k">new</span> <span class="n">FOnlineSessionSettings</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bIsLANMatch</span> <span class="o">=</span> <span class="n">Online</span><span class="o">::</span><span class="n">GetSubsystem</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">GetSubsystemName</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;NULL&#34;</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">NumPublicConnections</span> <span class="o">=</span> <span class="n">NumPublicConnections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bAllowJoinInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bAllowJoinViaPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bShouldAdvertise</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bUsesPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bUseLobbiesIfAvailable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">&#34;MatchType&#34;</span><span class="p">),</span> <span class="n">MatchType</span><span class="p">,</span> <span class="n">EOnlineDataAdvertisementType</span><span class="o">::</span><span class="n">ViaOnlineServiceAndPing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">BuildUniqueId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">CreateSession</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">NAME_GameSession</span><span class="p">,</span> <span class="o">*</span><span class="n">LastSessionSettings</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Broadcast our own custom delegate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">FindSessions</span><span class="p">(</span><span class="n">int32</span> <span class="n">MaxSearchResults</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">FindSessionsCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSearch</span> <span class="o">=</span> <span class="n">MakeShareable</span><span class="p">(</span><span class="k">new</span> <span class="n">FOnlineSessionSearch</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">MaxSearchResults</span> <span class="o">=</span> <span class="n">MaxSearchResults</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">bIsLanQuery</span> <span class="o">=</span> <span class="n">Online</span><span class="o">::</span><span class="n">GetSubsystem</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">GetSubsystemName</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;NULL&#34;</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">QuerySettings</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">SEARCH_PRESENCE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">EOnlineComparisonOp</span><span class="o">::</span><span class="n">Equals</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">FindSessions</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">LastSessionSearch</span><span class="p">.</span><span class="n">ToSharedRef</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">JoinSession</span><span class="p">(</span><span class="k">const</span> <span class="n">FOnlineSessionSearchResult</span><span class="o">&amp;</span> <span class="n">SessionResult</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 相较原版本修改的地方
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FOnlineSessionSearchResult</span> <span class="n">Result</span> <span class="o">=</span> <span class="n">SessionResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span> <span class="o">||</span> <span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">UnknownError</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">JoinSessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">SessionSettings</span><span class="p">.</span><span class="n">bUseLobbiesIfAvailable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">SessionSettings</span><span class="p">.</span><span class="n">bUsesPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">JoinSession</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">NAME_GameSession</span><span class="p">,</span> <span class="n">Result</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">UnknownError</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">DestroySession</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DestroySessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">DestroySession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">OnCreateSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">OnFindSessionsComplete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">SearchResults</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">SearchResults</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">OnJoinSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">OnDestroySessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">bWasSuccessful</span> <span class="o">&amp;&amp;</span> <span class="n">bCreateSessionOnDestroy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">bCreateSessionOnDestroy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">CreateSession</span><span class="p">(</span><span class="n">LastNumPublicConnections</span><span class="p">,</span> <span class="n">LastMatchType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先，这里和官方实现的主要差别在：<code>UMultiplayerSessionsSubsystem::JoinSession</code>部分，在其中，使用了拷贝的<code>FOnlineSessionSearchResult</code>类型，并且重新进行了一些设定，进行设定后，在测试的版本中可以顺利加入游戏，否则不能。</p>
<p>接下来对代码内容进行说明：</p>
<ol>
<li>在构造函数中，对各种Delegate进行了初始化，注意到这里的回调函数都是非动态的；</li>
<li><code>CreateSession</code>的实现中，如果当前还有未删除的session，就保存当前的参数，执行<code>DestroySession</code>，并在实现后的回调函数中进行判断并再次创建Session，如果直接在<code>CreateSession</code>中删除并创建，会导致Destroy还未成功就进行创建，导致创建失败。</li>
<li><code>NAME_GameSession</code>是一个宏，在这里作为session的固定名字；</li>
<li>在Session操作开始时，将代理进行绑定，而当操作成功的回调或者操作失败时，就通过Handle清除对应的代理，防止重复触发；</li>
<li>对于自定义代理，需要在操作成功或者失败时进行广播（Broadcast）操作</li>
</ol>
<h2 id="无缝传送">无缝传送<a hidden class="anchor" aria-hidden="true" href="#无缝传送">#</a></h2>
<p><strong>非无缝传送（Non-Seamless Travel）</strong></p>
<ul>
<li>客户端断开与服务器的连接</li>
<li>客户端重新连接到同一个服务器</li>
</ul>
<p><strong>非无缝传送发生的情况：</strong></p>
<ul>
<li>第一次加载地图时</li>
<li>第一次连接到服务器时</li>
<li>结束一场多人游戏并开始新游戏时</li>
</ul>
<p><strong>无缝传送（Seamless Travel）</strong></p>
<ul>
<li>带来更流畅的游戏体验</li>
<li>避免任何重新连接问题（例如玩家在切换地图时被踢出）</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 在GameMode中启用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">bUseSeamlessTravel</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>需要一个过渡地图（transition map）</strong>，用于在主地图切换时承载玩家状态</li>
<li><strong>在任何时刻必须有地图被加载</strong>，以保证传送过程不中断，系统正常运行，同时可以不同时加载两个大型地图</li>
</ul>
<p><strong>多人游戏中的关卡切换（Travel in Multiplayer）</strong>
<strong>1. <code>UWorld::ServerTravel</code></strong></p>
<ul>
<li><strong>仅限服务器端调用</strong></li>
<li>将服务器跳转至一个新关卡</li>
<li>所有已连接的客户端都会跟随切换</li>
<li>服务器会调用 <code>APlayerController::ClientTravel</code></li>
</ul>
<p><strong>2. <code>APlayerController::ClientTravel</code></strong></p>
<ul>
<li><strong>当客户端调用时</strong>：连接到一个新的服务器</li>
<li><strong>当服务器调用时</strong>：使特定玩家切换到一个新地图</li>
</ul>
<p>接下来以大厅实现的<code>LobbyGameMode</code>为例，说明实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// .h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UCLASS</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BLASTERS_API</span> <span class="nl">ALobbyGameMode</span> <span class="p">:</span> <span class="k">public</span> <span class="n">AGameMode</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">virtual</span> <span class="kt">void</span> <span class="n">PostLogin</span><span class="p">(</span><span class="n">APlayerController</span><span class="o">*</span> <span class="n">NewPlayer</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// .cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ALobbyGameMode</span><span class="o">::</span><span class="n">PostLogin</span><span class="p">(</span><span class="n">APlayerController</span><span class="o">*</span> <span class="n">NewPlayer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">PostLogin</span><span class="p">(</span><span class="n">NewPlayer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">int32</span> <span class="n">NumberOfPlayers</span> <span class="o">=</span> <span class="n">GameState</span><span class="p">.</span><span class="n">Get</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">PlayerArray</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">NumberOfPlayers</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">World</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">bUseSeamlessTravel</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">World</span><span class="o">-&gt;</span><span class="n">ServerTravel</span><span class="p">(</span><span class="n">FString</span><span class="p">(</span><span class="s">&#34;/Game/Maps/BlasterMap?listen&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>随后可以在此基础上新建一个蓝图GameMode，并且设置默认角色等内容。</p>
<p>同时，需要设置一个过渡关卡，新建空关卡并且在设置中设置Transition Level为本关卡</p>
<p><img alt="image-20250610101805604" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250610101805604.png"></p>
<h2 id="打印networkrole">打印NetworkRole<a hidden class="anchor" aria-hidden="true" href="#打印networkrole">#</a></h2>
<p>对于Pawn和character，它们在服务端和客户端中的网络角色会有不同，分为</p>
<table>
  <thead>
      <tr>
          <th>角色类型</th>
          <th>控制权</th>
          <th>所在位置</th>
          <th>用途</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ROLE_Authority</td>
          <td>服务器</td>
          <td>服务器</td>
          <td>控制游戏逻辑，广播状态</td>
      </tr>
      <tr>
          <td>ROLE_AutonomousProxy</td>
          <td>客户端</td>
          <td>本地玩家客户端</td>
          <td>接收输入，发送请求到服务器</td>
      </tr>
      <tr>
          <td>ROLE_SimulatedProxy</td>
          <td>客户端</td>
          <td>其他客户端玩家</td>
          <td>显示服务器同步的玩家动作</td>
      </tr>
      <tr>
          <td>ROLE_None</td>
          <td>无</td>
          <td>本地（非网络参与）</td>
          <td>本地临时对象、不同步</td>
      </tr>
  </tbody>
</table>
<p>为了在玩家头顶显示不同段中所有玩家的Role，首先设计一个UserWidget（包括C++以及对应蓝图），随后将这些蓝图附加在角色上，同时在角色的C++类中也要创建</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// .h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span> <span class="n">BlueprintReadOnly</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">AllowPrivateAccess</span><span class="o">=</span><span class="s">&#34;true&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UWidgetComponent</span><span class="o">*</span> <span class="n">OverheadWidget</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// .cpp 构造函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">OverheadWidget</span> <span class="o">=</span> <span class="n">CreateDefaultSubobject</span><span class="o">&lt;</span><span class="n">UWidgetComponent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;OverheadWidget&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">OverheadWidget</span><span class="o">-&gt;</span><span class="n">SetupAttachment</span><span class="p">(</span><span class="n">RootComponent</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>随后在Widget中进行相关的代码实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// .h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UCLASS</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BLASTERS_API</span> <span class="nl">UOverheadWidget</span> <span class="p">:</span> <span class="k">public</span> <span class="n">UUserWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">BindWidget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">class</span> <span class="nc">UTextBlock</span><span class="o">*</span> <span class="n">DisplayText</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">SetDisplayText</span><span class="p">(</span><span class="n">FString</span> <span class="n">TextToDisplay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">ShowPlayerRole</span><span class="p">(</span><span class="n">APawn</span><span class="o">*</span> <span class="n">InPawn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">virtual</span> <span class="kt">void</span> <span class="n">NativeDestruct</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// .cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">UOverheadWidget</span><span class="o">::</span><span class="n">SetDisplayText</span><span class="p">(</span><span class="n">FString</span> <span class="n">TextToDisplay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">DisplayText</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DisplayText</span><span class="o">-&gt;</span><span class="n">SetText</span><span class="p">(</span><span class="n">FText</span><span class="o">::</span><span class="n">FromString</span><span class="p">(</span><span class="n">TextToDisplay</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UOverheadWidget</span><span class="o">::</span><span class="n">ShowPlayerRole</span><span class="p">(</span><span class="n">APawn</span><span class="o">*</span> <span class="n">InPawn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">InPawn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ENetRole RemoteRole = InPawn-&gt;GetRemoteRole();
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ENetRole</span> <span class="n">LocalRole</span> <span class="o">=</span> <span class="n">InPawn</span><span class="o">-&gt;</span><span class="n">GetLocalRole</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">FString</span>  <span class="n">Role</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span><span class="p">(</span><span class="n">LocalRole</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">ENetRole</span><span class="o">::</span><span class="nl">ROLE_Authority</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">Role</span> <span class="o">=</span> <span class="n">FString</span><span class="p">(</span><span class="s">&#34;Authority&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">ENetRole</span><span class="o">::</span><span class="nl">ROLE_AutonomousProxy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">Role</span> <span class="o">=</span> <span class="n">FString</span><span class="p">(</span><span class="s">&#34;AutonomousProxy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">ENetRole</span><span class="o">::</span><span class="nl">ROLE_SimulatedProxy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">Role</span> <span class="o">=</span> <span class="n">FString</span><span class="p">(</span><span class="s">&#34;SimulatedProxy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">ENetRole</span><span class="o">::</span><span class="nl">ROLE_None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">Role</span> <span class="o">=</span> <span class="n">FString</span><span class="p">(</span><span class="s">&#34;None&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">SetDisplayText</span><span class="p">(</span><span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;Local Role: %s&#34;</span><span class="p">),</span> <span class="o">*</span><span class="n">Role</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UOverheadWidget</span><span class="o">::</span><span class="n">NativeDestruct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">RemoveFromParent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">NativeDestruct</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后在蓝图中实现</p>
<p><img alt="image-20250610184312853" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250610184312853.png"></p>
<p><img alt="image-20250610184252210" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250610184252210.png"></p>
<h2 id="变量复制">变量复制<a hidden class="anchor" aria-hidden="true" href="#变量复制">#</a></h2>
<p>接下来以bIsAiming这个和角色动画有关的变量说明如何将变量传递到服务器和客户端</p>
<p>为了编译管理和武器装备有关的变量，设置一个CombatComponent，因为其中的变量需要复制到客户端，所以创建的时候需要设置该组件可复制</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// CombatComponent.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">BLASTERS_API</span> <span class="nl">UCombatComponent</span> <span class="p">:</span> <span class="k">public</span> <span class="n">UActorComponent</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// CombatComponent.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">bAiming</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">VisibleAnywhere</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UCombatComponent</span><span class="o">*</span> <span class="n">Combat</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">ABlasterCharacter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Combat</span> <span class="o">=</span> <span class="n">CreateDefaultSubobject</span><span class="o">&lt;</span><span class="n">UCombatComponent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;CombatComponent&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">Combat</span><span class="o">-&gt;</span><span class="n">SetIsReplicated</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过<code>SetIsReplicated(true)</code>，该组件下的相关内容就可以标记为可复制.</p>
<p>将输入关联到函数中，并且由函数修改相关变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">SetupPlayerInputComponent</span><span class="p">(</span><span class="n">UInputComponent</span><span class="o">*</span> <span class="n">PlayerInputComponent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">SetupPlayerInputComponent</span><span class="p">(</span><span class="n">PlayerInputComponent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">PlayerInputComponent</span><span class="o">-&gt;</span><span class="n">BindAction</span><span class="p">(</span><span class="s">&#34;Aim&#34;</span><span class="p">,</span> <span class="n">IE_Pressed</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">AimButtonPressed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">PlayerInputComponent</span><span class="o">-&gt;</span><span class="n">BindAction</span><span class="p">(</span><span class="s">&#34;Aim&#34;</span><span class="p">,</span> <span class="n">IE_Released</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">AimButtonReleased</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">AimButtonPressed</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Combat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Combat</span><span class="o">-&gt;</span><span class="n">SetAiming</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">AimButtonReleased</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Combat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Combat</span><span class="o">-&gt;</span><span class="n">SetAiming</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>该方法确保了只有在实际装备武器的时候才执行相关变量修改命令，对应的函数如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// .h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">SetAiming</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bIsAiming</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ServerSetAiming</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bIsAiming</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// .cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">SetAiming</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bIsAiming</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 这里首先进行设置是为了保证客户端可以立即获得反馈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">bAiming</span> <span class="o">=</span> <span class="n">bIsAiming</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 客户端和服务端调用都在服务端执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ServerSetAiming</span><span class="p">(</span><span class="n">bIsAiming</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">Character</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Character</span><span class="o">-&gt;</span><span class="n">GetCharacterMovement</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MaxWalkSpeed</span> <span class="o">=</span> <span class="n">bIsAiming</span> <span class="o">?</span> <span class="nl">AimWalkSpeed</span> <span class="p">:</span> <span class="n">BaseWalkSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">ServerSetAiming_Implementation</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bIsAiming</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">bAiming</span> <span class="o">=</span> <span class="n">bIsAiming</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">Character</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Character</span><span class="o">-&gt;</span><span class="n">GetCharacterMovement</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MaxWalkSpeed</span> <span class="o">=</span> <span class="n">bIsAiming</span> <span class="o">?</span> <span class="nl">AimWalkSpeed</span> <span class="p">:</span> <span class="n">BaseWalkSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中在声明中的Server表示该行为只在服务器端执行，如果在客户端调用了该函数也会变为在服务端执行；</p>
<p>Reliable表示该函数是可靠，并且相对于同一个Actor是有序执行的。</p>
<p>同时，需要重写<code>GetLifetimeReplicatedProps</code>函数来指定变量复制时的行为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// .h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span><span class="o">:</span>	
</span></span><span class="line"><span class="cl">	<span class="k">virtual</span> <span class="kt">void</span> <span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">FLifetimeProperty</span><span class="o">&gt;&amp;</span> <span class="n">OutLifetimeProps</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// .cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">FLifetimeProperty</span><span class="o">&gt;&amp;</span> <span class="n">OutLifetimeProps</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">OutLifetimeProps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DOREPLIFETIME</span><span class="p">(</span><span class="n">UCombatComponent</span><span class="p">,</span> <span class="n">EquippedWeapon</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DOREPLIFETIME</span><span class="p">(</span><span class="n">UCombatComponent</span><span class="p">,</span> <span class="n">bAiming</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上的<code>DOREPLIFETIME</code>表示进行无条件复制，再比如<code>ABlasterCharacter::GetLifetimeReplicatedProps</code> 中的<code>DOREPLIFETIME_CONDITION(ABlasterCharacter, OverlappingWeapon, COND_OwnerOnly);</code>表示只复制给Owner.</p>
<p>同时，OnRep类的函数还可以传递参数，表示上一次复制的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">ReplicatedUsing</span> <span class="o">=</span> <span class="n">OnRep_OverlappingWeapon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AWeapon</span><span class="o">*</span> <span class="n">OverlappingWeapon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">OnRep_OverlappingWeapon</span><span class="p">(</span><span class="n">AWeapon</span><span class="o">*</span> <span class="n">LastWeapon</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">OnRep_OverlappingWeapon</span><span class="p">(</span><span class="n">AWeapon</span><span class="o">*</span> <span class="n">LastWeapon</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">OverlappingWeapon</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">OverlappingWeapon</span><span class="o">-&gt;</span><span class="n">ShowPickUpWidget</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">LastWeapon</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">LastWeapon</span><span class="o">-&gt;</span><span class="n">ShowPickUpWidget</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="处理复制过程中的压缩导致的范围变化问题">处理复制过程中的压缩导致的范围变化问题<a hidden class="anchor" aria-hidden="true" href="#处理复制过程中的压缩导致的范围变化问题">#</a></h2>
<p>对于如Rotator中的变量，UE引擎在进行复制的时候，会对其中的浮点数进行压缩，在这个过程中，可能会发生预料之外的情况，比如将一个小于0的角度映射为接近360度的角度，在这种情况下，我们需要再代码中重新将相关范围调整回负数.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">AO_Pitch</span> <span class="o">=</span> <span class="n">GetBaseAimRotation</span><span class="p">().</span><span class="n">Pitch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 在传输过程中，角度会被缩放到[0, 360]之间，因此需要将其转换为原本设定的区间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="p">(</span><span class="n">AO_Pitch</span> <span class="o">&gt;</span> <span class="mf">90.f</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IsLocallyControlled</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">InRange</span><span class="p">(</span><span class="mf">270.f</span><span class="p">,</span> <span class="mf">360.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">OutRange</span><span class="p">(</span><span class="o">-</span><span class="mf">90.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">AO_Pitch</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">GetMappedRangeValueClamped</span><span class="p">(</span><span class="n">InRange</span><span class="p">,</span> <span class="n">OutRange</span><span class="p">,</span> <span class="n">AO_Pitch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="实现射击功能">实现射击功能<a hidden class="anchor" aria-hidden="true" href="#实现射击功能">#</a></h2>
<p>对于多人游戏中的设计功能，主要有以下几项需要实现：</p>
<ol>
<li>射击时，需要记录发射者屏幕的中心点，并且以此为目标位置发射子弹</li>
<li>发射时，需要有枪口火焰动画，还需要子弹轨迹、抛射弹壳动画等</li>
</ol>
<p>对于第一种，必须由服务器进行执行，并且使用多播在各台机器上执行</p>
<p>实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// CombatComponent.h
</span></span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">FireButtonPressed</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bPressed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UFUNCTION</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">ServerFire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UFUNCTION</span><span class="p">(</span><span class="n">NetMulticast</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">MulticastFire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">TraceUnderCrosshairs</span><span class="p">(</span><span class="n">FHitResult</span><span class="o">&amp;</span> <span class="n">TraceHitResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">class</span> <span class="nc">ABlasterCharacter</span><span class="o">*</span> <span class="n">Character</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">(</span><span class="n">ReplicatedUsing</span><span class="o">=</span><span class="n">OnRep_EquippedWeapon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">AWeapon</span><span class="o">*</span> <span class="n">EquippedWeapon</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bAiming</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bFireButtonPressed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// CombatComponent.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">FireButtonPressed</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bPressed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">bFireButtonPressed</span> <span class="o">=</span> <span class="n">bPressed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">bFireButtonPressed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FHitResult</span> <span class="n">HitResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">TraceUnderCrosshairs</span><span class="p">(</span><span class="n">HitResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">ServerFire</span><span class="p">(</span><span class="n">HitResult</span><span class="p">.</span><span class="n">ImpactPoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">TraceUnderCrosshairs</span><span class="p">(</span><span class="n">FHitResult</span><span class="o">&amp;</span> <span class="n">TraceHitResult</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FVector2D</span> <span class="n">ViewportSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">GEngine</span> <span class="o">&amp;&amp;</span> <span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">GameViewport</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">GEngine</span><span class="o">-&gt;</span><span class="n">GameViewport</span><span class="o">-&gt;</span><span class="n">GetViewportSize</span><span class="p">(</span><span class="n">ViewportSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">FVector2D</span> <span class="nf">CrosshairLocation</span><span class="p">(</span><span class="n">ViewportSize</span><span class="p">.</span><span class="n">X</span> <span class="o">/</span> <span class="mf">2.f</span><span class="p">,</span> <span class="n">ViewportSize</span><span class="p">.</span><span class="n">Y</span> <span class="o">/</span> <span class="mf">2.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">FVector</span>   <span class="n">CrosshairWorldPosition</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FVector</span>   <span class="n">CrosshairWorldDirection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span>      <span class="n">bScreenToWorld</span> <span class="o">=</span> <span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">DeprojectScreenToWorld</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">GetPlayerController</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="n">CrosshairLocation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">CrosshairWorldPosition</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">CrosshairWorldDirection</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">bScreenToWorld</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FVector</span> <span class="n">Start</span> <span class="o">=</span> <span class="n">CrosshairWorldPosition</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">FVector</span> <span class="n">End</span> <span class="o">=</span> <span class="n">Start</span> <span class="o">+</span> <span class="n">CrosshairWorldDirection</span> <span class="o">*</span> <span class="n">TRACE_LENGTH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">LineTraceSingleByChannel</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="n">TraceHitResult</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">Start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">End</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">ECC_Visibility</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">TraceHitResult</span><span class="p">.</span><span class="n">bBlockingHit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">TraceHitResult</span><span class="p">.</span><span class="n">ImpactPoint</span> <span class="o">=</span> <span class="n">End</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">ServerFire_Implementation</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">MulticastFire</span><span class="p">(</span><span class="n">TraceHitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">MulticastFire_Implementation</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">EquippedWeapon</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">Character</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Character</span><span class="o">-&gt;</span><span class="n">PlayFireMontage</span><span class="p">(</span><span class="n">bAiming</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">EquippedWeapon</span><span class="o">-&gt;</span><span class="n">Fire</span><span class="p">(</span><span class="n">TraceHitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>多播函数的作用是：如果在服务端运行，则会在服务端和客户端所有机器上调用（如果在客户端，那么只在调用的机器上执行），这种通过多播执行了播放开火动画的功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">Fire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector</span><span class="o">&amp;</span> <span class="n">HitTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">FireAnimation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">PlayAnimation</span><span class="p">(</span><span class="n">FireAnimation</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">CasingClass</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">USkeletalMeshSocket</span><span class="o">*</span> <span class="n">AmmoEjectSocket</span> <span class="o">=</span> <span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">GetSocketByName</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">&#34;AmmoEject&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">AmmoEjectSocket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FTransform</span> <span class="n">SocketTransform</span> <span class="o">=</span> <span class="n">AmmoEjectSocket</span><span class="o">-&gt;</span><span class="n">GetSocketTransform</span><span class="p">(</span><span class="n">WeaponMesh</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">World</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">World</span><span class="o">-&gt;</span><span class="n">SpawnActor</span><span class="o">&lt;</span><span class="n">ACasing</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">					<span class="n">CasingClass</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">SocketTransform</span><span class="p">.</span><span class="n">GetLocation</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">					<span class="n">SocketTransform</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">().</span><span class="n">Rotator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个函数的作用也是在多播中被调用，执行抛射弹壳等效果动画。</p>
<p>同时，实际进行设计的武器继承了该类，并且重写了<code>Fire</code>函数，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AProjectileWeapon</span><span class="o">::</span><span class="n">Fire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector</span><span class="o">&amp;</span> <span class="n">HitTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">Fire</span><span class="p">(</span><span class="n">HitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">HasAuthority</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">APawn</span><span class="o">*</span> <span class="n">InstigatorPawn</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetOwner</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">USkeletalMeshSocket</span><span class="o">*</span> <span class="n">MuzzleFlashSocket</span> <span class="o">=</span> <span class="n">GetWeaponMesh</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSocketByName</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">&#34;MuzzleFlash&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MuzzleFlashSocket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FTransform</span> <span class="n">SocketTransform</span> <span class="o">=</span> <span class="n">MuzzleFlashSocket</span><span class="o">-&gt;</span><span class="n">GetSocketTransform</span><span class="p">(</span><span class="n">GetWeaponMesh</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// From muzzle flash socket to hit location from TraceUnderCrosshairs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">FVector</span>  <span class="n">ToTarget</span> <span class="o">=</span> <span class="n">HitTarget</span> <span class="o">-</span> <span class="n">SocketTransform</span><span class="p">.</span><span class="n">GetLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">FRotator</span> <span class="n">TargetRotation</span> <span class="o">=</span> <span class="n">ToTarget</span><span class="p">.</span><span class="n">Rotation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">ProjectileClass</span> <span class="o">&amp;&amp;</span> <span class="n">InstigatorPawn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FActorSpawnParameters</span> <span class="n">SpawnParameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">SpawnParameters</span><span class="p">.</span><span class="n">Owner</span> <span class="o">=</span> <span class="n">GetOwner</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">SpawnParameters</span><span class="p">.</span><span class="n">Instigator</span> <span class="o">=</span> <span class="n">InstigatorPawn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">				<span class="n">World</span><span class="o">-&gt;</span><span class="n">SpawnActor</span><span class="o">&lt;</span><span class="n">AProjectile</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ProjectileClass</span><span class="p">,</span> <span class="n">SocketTransform</span><span class="p">.</span><span class="n">GetLocation</span><span class="p">(),</span> <span class="n">TargetRotation</span><span class="p">,</span> <span class="n">SpawnParameters</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>该函数只在服务端上执行有效功能：发射弹丸</p>
<h2 id="播放动画montage">播放动画Montage<a hidden class="anchor" aria-hidden="true" href="#播放动画montage">#</a></h2>
<p>首先创建一个动画Montage
<img alt="image-20250706212113975" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250706212113975.png"></p>
<p>创建一个新的Anim Slot，并修改Default Slot</p>
<p>在动画蓝图中应用Slot</p>
<p><img alt="image-20250706212224985" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250706212224985.png"></p>
<p>随后在代码中设置相关的函数和Montange</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">EditAnywhere</span><span class="p">,</span> <span class="n">Category</span> <span class="o">=</span> <span class="n">Combat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">UAnimMontage</span><span class="o">*</span> <span class="n">ElimMontage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">PlayElimMontage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">PlayElimMontage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">UAnimInstance</span><span class="o">*</span> <span class="n">AnimInstance</span> <span class="o">=</span> <span class="n">GetMesh</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetAnimInstance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">AnimInstance</span> <span class="o">&amp;&amp;</span> <span class="n">ElimMontage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">AnimInstance</span><span class="o">-&gt;</span><span class="n">Montage_Play</span><span class="p">(</span><span class="n">ElimMontage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>要实现同时在客户端和主机播放动画，需要使用多播。</p>
<p>首先，片段角色是否死亡，以及是否播放动画位置在主机端，但是实际调用播放动画函数需要在所有段上执行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Elim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">NetMulticast</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">MulticastElim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">Elim</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Combat</span> <span class="o">&amp;&amp;</span> <span class="n">Combat</span><span class="o">-&gt;</span><span class="n">EquippedWeapon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Combat</span><span class="o">-&gt;</span><span class="n">EquippedWeapon</span><span class="o">-&gt;</span><span class="n">Dropped</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">MulticastElim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">GetWorldTimerManager</span><span class="p">().</span><span class="n">SetTimer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">ElimTimer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">ElimTimerFinished</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">ElimDelay</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">MulticastElim_Implementation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">bElimmed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">PlayElimMontage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">DissolveMaterialInstance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DynamicDissolveMaterialInstance</span> <span class="o">=</span> <span class="n">UMaterialInstanceDynamic</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">DissolveMaterialInstance</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">GetMesh</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetMaterial</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DynamicDissolveMaterialInstance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">DynamicDissolveMaterialInstance</span><span class="o">-&gt;</span><span class="n">SetScalarParameterValue</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;Dissolve&#34;</span><span class="p">),</span> <span class="mf">0.55f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">DynamicDissolveMaterialInstance</span><span class="o">-&gt;</span><span class="n">SetScalarParameterValue</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;Glow&#34;</span><span class="p">),</span> <span class="mf">200.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">StartDissolve</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Disable character movement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">GetCharacterMovement</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DisableMovement</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">GetCharacterMovement</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">StopMovementImmediately</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">BlasterPlayerController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DisableInput</span><span class="p">(</span><span class="n">BlasterPlayerController</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Disable collision
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">GetCapsuleComponent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">NoCollision</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">GetMesh</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">NoCollision</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Spawn elim bot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">ElimBotEffect</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FVector</span> <span class="nf">ElimBotSpawnPoint</span><span class="p">(</span><span class="n">GetActorLocation</span><span class="p">().</span><span class="n">X</span><span class="p">,</span> <span class="n">GetActorLocation</span><span class="p">().</span><span class="n">Y</span><span class="p">,</span> <span class="n">GetActorLocation</span><span class="p">().</span><span class="n">Z</span> <span class="o">+</span> <span class="mf">200.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">ElimBotComponent</span> <span class="o">=</span> <span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">SpawnEmitterAtLocation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="n">GetWorld</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="n">ElimBotEffect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">ElimBotSpawnPoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">GetActorRotation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ElimBotSound</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">SpawnSoundAtLocation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">ElimBotSound</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">GetActorLocation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>除此之外，也可以在变量被改变的时候播放动画，实现在所有机器上播放的效果，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterCharacter.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">ReceiveDamage</span><span class="p">(</span><span class="n">AActor</span><span class="o">*</span> <span class="n">DamagedActor</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Damage</span><span class="p">,</span> <span class="k">const</span> <span class="n">UDamageType</span><span class="o">*</span> <span class="n">DamageType</span><span class="p">,</span> <span class="k">class</span> <span class="nc">AController</span><span class="o">*</span> <span class="n">InstigatorController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">AActor</span><span class="o">*</span> <span class="n">DamageCauser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Health</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">Health</span> <span class="o">-</span> <span class="n">Damage</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="n">MaxHealth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UpdateHUDHealth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">PlayHitReactMontage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Health</span> <span class="o">&lt;=</span> <span class="mf">0.f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ABlasterGameMode</span><span class="o">*</span> <span class="n">BlasterGameMode</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetAuthGameMode</span><span class="o">&lt;</span><span class="n">ABlasterGameMode</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">BlasterGameMode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">BlasterPlayerController</span> <span class="o">=</span> <span class="n">BlasterPlayerController</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span> <span class="o">:</span> <span class="n">BlasterPlayerController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">ABlasterPlayerController</span><span class="o">*</span> <span class="n">AttackerController</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">InstigatorController</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">BlasterGameMode</span><span class="o">-&gt;</span><span class="n">PlayerEliminated</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">BlasterPlayerController</span><span class="p">,</span> <span class="n">AttackerController</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">OnRep_Health</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">UpdateHUDHealth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">PlayHitReactMontage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="实现击杀计分">实现击杀计分<a hidden class="anchor" aria-hidden="true" href="#实现击杀计分">#</a></h2>
<p>当服务器上角色生命值小于0时，会调用<code>BlasterGameMode-&gt;PlayerEliminated(this, BlasterPlayerController, AttackerController);</code>方法，之所以不直接在角色上调用是因为之后可能会删除角色</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterGameMode</span><span class="o">::</span><span class="n">PlayerEliminated</span><span class="p">(</span><span class="n">ABlasterCharacter</span><span class="o">*</span>        <span class="n">ElimmedCharacter</span><span class="p">,</span> <span class="n">ABlasterPlayerController</span><span class="o">*</span> <span class="n">VictimController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">ABlasterPlayerController</span><span class="o">*</span> <span class="n">AttackerController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">AttackerController</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">AttackerController</span><span class="o">-&gt;</span><span class="n">PlayerState</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">VictimController</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">VictimController</span><span class="o">-&gt;</span><span class="n">PlayerState</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ABlasterPlayerState</span><span class="o">*</span> <span class="n">AttackerPlayerState</span> <span class="o">=</span> <span class="n">AttackerController</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerState</span><span class="o">&gt;</span><span class="p">(</span><span class="n">AttackerController</span><span class="o">-&gt;</span><span class="n">PlayerState</span><span class="p">)</span> <span class="o">:</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ABlasterPlayerState</span><span class="o">*</span> <span class="n">VictimPlayerState</span> <span class="o">=</span> <span class="n">VictimController</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerState</span><span class="o">&gt;</span><span class="p">(</span><span class="n">VictimController</span><span class="o">-&gt;</span><span class="n">PlayerState</span><span class="p">)</span> <span class="o">:</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">AttackerPlayerState</span> <span class="o">&amp;&amp;</span> <span class="n">AttackerPlayerState</span> <span class="o">!=</span> <span class="n">VictimPlayerState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">AttackerPlayerState</span><span class="o">-&gt;</span><span class="n">AddToScore</span><span class="p">(</span><span class="mf">1.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">VictimPlayerState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">VictimPlayerState</span><span class="o">-&gt;</span><span class="n">AddToDefeats</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">ElimmedCharacter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ElimmedCharacter</span><span class="o">-&gt;</span><span class="n">Elim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerState</span><span class="o">::</span><span class="n">AddToScore</span><span class="p">(</span><span class="kt">float</span> <span class="n">ScoreAmount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetScore</span><span class="p">(</span><span class="n">GetScore</span><span class="p">()</span> <span class="o">+</span> <span class="n">ScoreAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">Character</span> <span class="o">=</span> <span class="n">Character</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetPawn</span><span class="p">())</span> <span class="o">:</span> <span class="n">Character</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Character</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Controller</span> <span class="o">=</span> <span class="n">Controller</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Character</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">)</span> <span class="o">:</span> <span class="n">Controller</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SetHUDScore</span><span class="p">(</span><span class="n">GetScore</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerState</span><span class="o">::</span><span class="n">AddToDefeats</span><span class="p">(</span><span class="n">int32</span> <span class="n">DefeatsAmount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Defeats</span> <span class="o">+=</span> <span class="n">DefeatsAmount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Character</span> <span class="o">=</span> <span class="n">Character</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetPawn</span><span class="p">())</span> <span class="o">:</span> <span class="n">Character</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Character</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Controller</span> <span class="o">=</span> <span class="n">Controller</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Character</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">)</span> <span class="o">:</span> <span class="n">Controller</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SetHUDDefeats</span><span class="p">(</span><span class="n">Defeats</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码中的Score是PlayerState自带的复制变量，而Defeats是自定义变量，需要手动声明复制以及实现OnRep函数，而Score在复制时的操作也可以进行重写</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerState</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLifetimeProperty</span><span class="o">&gt;&amp;</span> <span class="n">OutLifetimeProps</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">OutLifetimeProps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DOREPLIFETIME</span><span class="p">(</span><span class="n">ABlasterPlayerState</span><span class="p">,</span> <span class="n">Defeats</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerState</span><span class="o">::</span><span class="n">OnRep_Score</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">OnRep_Score</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">Character</span> <span class="o">=</span> <span class="n">Character</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetPawn</span><span class="p">())</span> <span class="o">:</span> <span class="n">Character</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Character</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Controller</span> <span class="o">=</span> <span class="n">Controller</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Character</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">)</span> <span class="o">:</span> <span class="n">Controller</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SetHUDScore</span><span class="p">(</span><span class="n">GetScore</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerState</span><span class="o">::</span><span class="n">OnRep_Defeats</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Character</span> <span class="o">=</span> <span class="n">Character</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetPawn</span><span class="p">())</span> <span class="o">:</span> <span class="n">Character</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Character</span> <span class="o">&amp;&amp;</span> <span class="n">Character</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Controller</span> <span class="o">=</span> <span class="n">Controller</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Character</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">)</span> <span class="o">:</span> <span class="n">Controller</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">Controller</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Controller</span><span class="o">-&gt;</span><span class="n">SetHUDDefeats</span><span class="p">(</span><span class="n">Defeats</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="击杀回调函数与重生">击杀回调函数与重生<a hidden class="anchor" aria-hidden="true" href="#击杀回调函数与重生">#</a></h2>
<p>在角色死亡后，一般不会离开重生，因此需要调用回调函数（见播放动画Montage），回调函数中会进行重生相关实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterCharacter</span><span class="o">::</span><span class="n">ElimTimerFinished</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ABlasterGameMode</span><span class="o">*</span> <span class="n">BlasterGameMode</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetAuthGameMode</span><span class="o">&lt;</span><span class="n">ABlasterGameMode</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">BlasterGameMode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BlasterGameMode</span><span class="o">-&gt;</span><span class="n">RequestRespawn</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">Controller</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterGameMode</span><span class="o">::</span><span class="n">RequestRespawn</span><span class="p">(</span><span class="n">ACharacter</span><span class="o">*</span> <span class="n">ElimmedCharacter</span><span class="p">,</span> <span class="n">AController</span><span class="o">*</span> <span class="n">ElimmedController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">ElimmedCharacter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ElimmedCharacter</span><span class="o">-&gt;</span><span class="n">Reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">ElimmedCharacter</span><span class="o">-&gt;</span><span class="n">Destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">ElimmedController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">TArray</span><span class="o">&lt;</span><span class="n">AActor</span><span class="o">*&gt;</span> <span class="n">PlayerStarts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">GetAllActorsOfClass</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">APlayerStart</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">(),</span> <span class="n">PlayerStarts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">int32</span> <span class="n">Selection</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">RandRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PlayerStarts</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">RestartPlayerAtPlayerStart</span><span class="p">(</span><span class="n">ElimmedController</span><span class="p">,</span> <span class="n">PlayerStarts</span><span class="p">[</span><span class="n">Selection</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="客户端服务器同步倒计时">客户端服务器同步倒计时<a hidden class="anchor" aria-hidden="true" href="#客户端服务器同步倒计时">#</a></h2>
<p>在服务器和客户端上，都可以通过<code> GetWorld()-&gt;GetTimeSeconds()</code>获得时间，以此可以获得倒计时</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SetHUDMatchCountdown(MatchTime - GetWorld()-&gt;GetTimeSeconds());
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是，由于服务器和客户端加载时间不同，即使不存在网络延迟，倒计时也不一致</p>
<p>解决的方法是：</p>
<ol>
<li>客户端向服务器发送请求服务器时间的请求，参数为客户端当前时间；</li>
<li>服务器调用客户端上的函数，参数为当前时间和客户端传来的时间</li>
<li>客户端根据参数中的客户端时间，可以估算出RTT时间，以一半的RTT加上服务器的时间，可以估算当前服务器时间</li>
</ol>
<p>实际操作中，客户端在游戏开始时和间隔若干秒时间调用一次操作，以保证和服务器的时间同步，具体实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterPlayerController.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">float</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">GetServerTime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">HasAuthority</span><span class="p">())</span> <span class="k">return</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTimeSeconds</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTimeSeconds</span><span class="p">()</span> <span class="o">+</span> <span class="n">ClientServerDelta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">ReceivedPlayer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">ReceivedPlayer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">IsLocalController</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ServerRequestServerTime</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTimeSeconds</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">Tick</span><span class="p">(</span><span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">Tick</span><span class="p">(</span><span class="n">DeltaTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetHUDTime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">CheckTimeSync</span><span class="p">(</span><span class="n">DeltaTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">CheckTimeSync</span><span class="p">(</span><span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">TimeSyncRunningTime</span> <span class="o">+=</span> <span class="n">DeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">IsLocalController</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">TimeSyncRunningTime</span> <span class="o">&gt;</span> <span class="n">TimeSyncFrequency</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ServerRequestServerTime</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTimeSeconds</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="n">TimeSyncRunningTime</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">ServerRequestServerTime_Implementation</span><span class="p">(</span><span class="kt">float</span> <span class="n">TimeOfClientRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">float</span> <span class="n">ServerTimeOfReceipt</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTimeSeconds</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">ClientReportServerTime</span><span class="p">(</span><span class="n">TimeOfClientRequest</span><span class="p">,</span> <span class="n">ServerTimeOfReceipt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">ClientReportServerTime_Implementation</span><span class="p">(</span><span class="kt">float</span> <span class="n">TimeOfClientRequest</span><span class="p">,</span> <span class="kt">float</span> <span class="n">TimeServerReceivedClientRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">float</span> <span class="n">RoundTripTime</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTimeSeconds</span><span class="p">()</span> <span class="o">-</span> <span class="n">TimeOfClientRequest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">float</span> <span class="n">CurrentServerTime</span> <span class="o">=</span> <span class="n">TimeServerReceivedClientRequest</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5f</span> <span class="o">*</span> <span class="n">RoundTripTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">ClientServerDelta</span> <span class="o">=</span> <span class="n">CurrentServerTime</span> <span class="o">-</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTimeSeconds</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gamemode和matchstate">GameMode和MatchState<a hidden class="anchor" aria-hidden="true" href="#gamemode和matchstate">#</a></h2>
<p>UE中，每个关卡可以设定GameMode，其中，GameModeBase可以设定Player Controller, Pawn等关卡默认内容，也可以通过继承处理与游戏关卡有关的逻辑，比如记录时间等；GameMode继承自GameModeBase，额外包含了MatchState有关内容。</p>
<p>MatchState命名空间中包含了各种游戏状态，包括在Gamemode.h中的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">MatchState</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">extern</span> <span class="n">ENGINE_API</span> <span class="k">const</span> <span class="n">FName</span> <span class="n">EnteringMap</span><span class="p">;</span>			<span class="c1">// We are entering this map, actors are not yet ticking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">extern</span> <span class="n">ENGINE_API</span> <span class="k">const</span> <span class="n">FName</span> <span class="n">WaitingToStart</span><span class="p">;</span>		<span class="c1">// Actors are ticking, but the match has not yet started
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">extern</span> <span class="n">ENGINE_API</span> <span class="k">const</span> <span class="n">FName</span> <span class="n">InProgress</span><span class="p">;</span>			<span class="c1">// Normal gameplay is occurring. Specific games will have their own state machine inside this state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">extern</span> <span class="n">ENGINE_API</span> <span class="k">const</span> <span class="n">FName</span> <span class="n">WaitingPostMatch</span><span class="p">;</span>		<span class="c1">// Match has ended so we aren&#39;t accepting new players, but actors are still ticking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">extern</span> <span class="n">ENGINE_API</span> <span class="k">const</span> <span class="n">FName</span> <span class="n">LeavingMap</span><span class="p">;</span>			<span class="c1">// We are transitioning out of the map to another location
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">extern</span> <span class="n">ENGINE_API</span> <span class="k">const</span> <span class="n">FName</span> <span class="n">Aborted</span><span class="p">;</span>				<span class="c1">// Match has failed due to network issues or other problems, cannot continue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If a game needs to add additional states, you may need to override HasMatchStarted and HasMatchEnded to deal with the new states
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Do not add any states before WaitingToStart or after WaitingPostMatch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>除此之外，我们还可以自定义MatchState，不过，我们只能在WaitingToStart之后WaitingPostMatch之前添加自定义状态。</p>
<p>自定义的方法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterGameMode.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">namespace</span> <span class="n">MatchState</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">extern</span> <span class="n">BLASTERS_API</span> <span class="k">const</span> <span class="n">FName</span> <span class="n">Cooldown</span><span class="p">;</span> <span class="c1">// Match duration has been reached. Display winner and begin cooldown timer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterGameMode.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">namespace</span> <span class="n">MatchState</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">FName</span> <span class="n">Cooldown</span> <span class="o">=</span> <span class="n">FName</span><span class="p">(</span><span class="s">&#34;Cooldown&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于Gamemode只存在于主机上，因此可以通过调用每个Player Controller中的自定义MatchState变量，通过将controller上的MatchState变量声明为复制，并且添加相应的回调函数，使得每个玩家都获取到相关信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterGameMode.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">virtual</span> <span class="kt">void</span> <span class="nf">OnMatchStateSet</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterGameMode.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ABlasterGameMode</span><span class="o">::</span><span class="n">OnMatchStateSet</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">OnMatchStateSet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="n">FConstPlayerControllerIterator</span> <span class="n">It</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetPlayerControllerIterator</span><span class="p">();</span> <span class="n">It</span><span class="p">;</span> <span class="o">++</span><span class="n">It</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ABlasterPlayerController</span><span class="o">*</span> <span class="n">BlasterPlayer</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">It</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">BlasterPlayer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">BlasterPlayer</span><span class="o">-&gt;</span><span class="n">OnMatchStateSet</span><span class="p">(</span><span class="n">MatchState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterPlayerController.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">OnMatchStateSet</span><span class="p">(</span><span class="n">FName</span> <span class="n">State</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">MatchState</span> <span class="o">=</span> <span class="n">State</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MatchState</span> <span class="o">==</span> <span class="n">MatchState</span><span class="o">::</span><span class="n">InProgress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">HandleMatchHasStarted</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">MatchState</span> <span class="o">==</span> <span class="n">MatchState</span><span class="o">::</span><span class="n">Cooldown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">HandleCooldown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以下是客户端中途加入时获取MatchState等GameMode中存储信息的方法，采用ServerRPC和ClientRPC：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterPlayerController.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ServerCheckMatchState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">Client</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ClientJoinMidgame</span><span class="p">(</span><span class="n">FName</span> <span class="n">StateOfMatch</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Warmup</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Match</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Cooldown</span><span class="p">,</span> <span class="kt">float</span> <span class="n">StartingTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterPlayerController.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">BeginPlay</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">BeginPlay</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">BlasterHUD</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterHUD</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetHUD</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="n">ServerCheckMatchState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">ServerCheckMatchState_Implementation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ABlasterGameMode</span><span class="o">*</span> <span class="n">GameMode</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterGameMode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">GetGameMode</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">GameMode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">WarmupTime</span> <span class="o">=</span> <span class="n">GameMode</span><span class="o">-&gt;</span><span class="n">WarmupTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">MatchTime</span> <span class="o">=</span> <span class="n">GameMode</span><span class="o">-&gt;</span><span class="n">MatchTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">CooldownTime</span> <span class="o">=</span> <span class="n">GameMode</span><span class="o">-&gt;</span><span class="n">CooldownTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">LevelStartingTime</span> <span class="o">=</span> <span class="n">GameMode</span><span class="o">-&gt;</span><span class="n">LevelStartingTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">MatchState</span> <span class="o">=</span> <span class="n">GameMode</span><span class="o">-&gt;</span><span class="n">GetMatchState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">ClientJoinMidgame</span><span class="p">(</span><span class="n">MatchState</span><span class="p">,</span> <span class="n">WarmupTime</span><span class="p">,</span> <span class="n">MatchTime</span><span class="p">,</span> <span class="n">CooldownTime</span><span class="p">,</span> <span class="n">LevelStartingTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">ClientJoinMidgame_Implementation</span><span class="p">(</span><span class="n">FName</span> <span class="n">StateOfMatch</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Warmup</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Match</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Cooldown</span><span class="p">,</span> <span class="kt">float</span> <span class="n">StartingTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WarmupTime</span> <span class="o">=</span> <span class="n">Warmup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">MatchTime</span> <span class="o">=</span> <span class="n">Match</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LevelStartingTime</span> <span class="o">=</span> <span class="n">StartingTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">MatchState</span> <span class="o">=</span> <span class="n">StateOfMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">CooldownTime</span> <span class="o">=</span> <span class="n">Cooldown</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">OnMatchStateSet</span><span class="p">(</span><span class="n">MatchState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">BlasterHUD</span> <span class="o">&amp;&amp;</span> <span class="n">MatchState</span> <span class="o">==</span> <span class="n">MatchState</span><span class="o">::</span><span class="n">WaitingToStart</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">AddAnnouncement</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gamestate">GameState<a hidden class="anchor" aria-hidden="true" href="#gamestate">#</a></h2>
<p>类似于PlayerState，可以创建一个GameState保存一句游戏中的关键信息，比如最高分数，获胜玩家。</p>
<p>通常GameMode对应GameState，GameModeBase对应GameStateBase.</p>
<p>GameState和GameMode不同之处在于，GameState可以被复制到客户端，比如记录最高分玩家（可能有多个）的数组，可以通过常用的方法被复制：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// BlasterGameMode.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">virtual</span> <span class="kt">void</span> <span class="nf">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLifetimeProperty</span><span class="o">&gt;&amp;</span> <span class="n">OutLifetimeProps</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">TArray</span><span class="o">&lt;</span><span class="n">ABlasterPlayerState</span><span class="o">*&gt;</span> <span class="n">TopScoringPlayers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BlasterGameMode.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ABlasterGameState</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FLifetimeProperty</span><span class="o">&gt;&amp;</span> <span class="n">OutLifetimeProps</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">OutLifetimeProps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DOREPLIFETIME</span><span class="p">(</span><span class="n">ABlasterGameState</span><span class="p">,</span> <span class="n">TopScoringPlayers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ping">Ping<a hidden class="anchor" aria-hidden="true" href="#ping">#</a></h2>
<p>可以通过自带的函数获得Ping</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">CheckPing</span><span class="p">(</span><span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">HighPingRunningTime</span> <span class="o">+=</span> <span class="n">DeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">HighPingRunningTime</span> <span class="o">&gt;</span> <span class="n">CheckPingFrequency</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PlayerState</span><span class="p">)</span> <span class="n">PlayerState</span> <span class="o">=</span> <span class="n">GetPlayerState</span><span class="o">&lt;</span><span class="n">APlayerState</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">PlayerState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">PlayerState</span><span class="o">-&gt;</span><span class="n">GetPingInMilliseconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">HighPingThreshold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">HighPingWarning</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">				<span class="n">PingAnimationRunningTime</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">HighPingRunningTime</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bHighPingAnimationPlaying</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">	<span class="n">BlasterHUD</span> <span class="o">&amp;&amp;</span> <span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">CharacterOverlay</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">CharacterOverlay</span><span class="o">-&gt;</span><span class="n">HighPingAnimation</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">	<span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">CharacterOverlay</span><span class="o">-&gt;</span><span class="n">IsAnimationPlaying</span><span class="p">(</span><span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">CharacterOverlay</span><span class="o">-&gt;</span><span class="n">HighPingAnimation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">bHighPingAnimationPlaying</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">PingAnimationRunningTime</span> <span class="o">+=</span> <span class="n">DeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">PingAnimationRunningTime</span> <span class="o">&gt;</span> <span class="n">HighPingDuration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">StopHighPingWarning</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的获得Ping的用法有几种：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">float APlayerState::GetPingInMilliseconds()
</span></span></code></pre></td></tr></table>
</div>
</div><p>该函数作用是将压缩的Ping乘以4</p>
<p>以及</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">uint8 APlayerState::GetCompressedPing()
</span></span></code></pre></td></tr></table>
</div>
</div><p>是获得压缩后的Ping</p>
<p>以上两种方法获得的Ping精度都相对较差，因此要同步时间还是应该使用RTT估算。</p>
<h2 id="更低延迟的射击实现客户端预测技术">更低延迟的射击实现（客户端预测技术）<a hidden class="anchor" aria-hidden="true" href="#更低延迟的射击实现客户端预测技术">#</a></h2>
<p>为了让客户端在进行射击的时候可以忽略延迟，可以通过重新修改射击流程以进行实现，下面以霰弹枪为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">Fire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">CanFire</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">EquippedWeapon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">CrosshairShootingFactor</span> <span class="o">=</span> <span class="mf">.75f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">switch</span><span class="p">(</span><span class="n">EquippedWeapon</span><span class="o">-&gt;</span><span class="n">FireType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">EFireType</span><span class="o">::</span><span class="nl">EFT_Projectile</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">FireProjectileWeapon</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">EFireType</span><span class="o">::</span><span class="nl">EFT_HitScan</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">FireHitScanWeapon</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="n">EFireType</span><span class="o">::</span><span class="nl">EFT_Shotgun</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="n">FireShotgun</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">StartFireTimer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">FireShotgun</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">AShotgun</span><span class="o">*</span> <span class="n">Shotgun</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">AShotgun</span><span class="o">&gt;</span><span class="p">(</span><span class="n">EquippedWeapon</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Shotgun</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">TArray</span><span class="o">&lt;</span><span class="n">FVector_NetQuantize</span><span class="o">&gt;</span> <span class="n">HitTargets</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Shotgun</span><span class="o">-&gt;</span><span class="n">ShotgunTraceEndWithScatter</span><span class="p">(</span><span class="n">HitTarget</span><span class="p">,</span> <span class="n">HitTargets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">ShotgunLocalFire</span><span class="p">(</span><span class="n">HitTargets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">ServerShotgunFire</span><span class="p">(</span><span class="n">HitTargets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上两个函数，都在本地进行执行，<code>Shotgun-&gt;ShotgunTraceEndWithScatter(HitTarget, HitTargets);</code>的目的是为了获取霰弹枪的所有射击方向，从而让本地生成弹丸方向。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AShotgun</span><span class="o">::</span><span class="n">ShotgunTraceEndWithScatter</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector</span><span class="o">&amp;</span> <span class="n">HitTarget</span><span class="p">,</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FVector_NetQuantize</span><span class="o">&gt;&amp;</span> <span class="n">HitTargets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">USkeletalMeshSocket</span><span class="o">*</span> <span class="n">MuzzleFlashSocket</span> <span class="o">=</span> <span class="n">GetWeaponMesh</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSocketByName</span><span class="p">(</span><span class="s">&#34;MuzzleFlash&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MuzzleFlashSocket</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">FTransform</span> <span class="n">SocketTransform</span> <span class="o">=</span> <span class="n">MuzzleFlashSocket</span><span class="o">-&gt;</span><span class="n">GetSocketTransform</span><span class="p">(</span><span class="n">GetWeaponMesh</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">FVector</span>    <span class="n">TraceStart</span> <span class="o">=</span> <span class="n">SocketTransform</span><span class="p">.</span><span class="n">GetLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">FVector</span>    <span class="n">ToTargetNormalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">HitTarget</span> <span class="o">-</span> <span class="n">TraceStart</span><span class="p">).</span><span class="n">GetSafeNormal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">FVector</span>    <span class="n">SphereCenter</span> <span class="o">=</span> <span class="n">TraceStart</span> <span class="o">+</span> <span class="n">ToTargetNormalized</span> <span class="o">*</span> <span class="n">DistanceToSphere</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="n">uint32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NumberOfPellets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">FVector</span> <span class="n">RandVec</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">RandomUnitVector</span><span class="p">()</span> <span class="o">*</span> <span class="n">FMath</span><span class="o">::</span><span class="n">FRandRange</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="n">SphereRadius</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">FVector</span> <span class="n">EndLoc</span> <span class="o">=</span> <span class="n">SphereCenter</span> <span class="o">+</span> <span class="n">RandVec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">FVector</span>       <span class="n">ToEndLoc</span> <span class="o">=</span> <span class="n">EndLoc</span> <span class="o">-</span> <span class="n">TraceStart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">ToEndLoc</span> <span class="o">=</span> <span class="n">TraceStart</span> <span class="o">+</span> <span class="n">ToEndLoc</span> <span class="o">*</span> <span class="n">TRACE_LENGTH</span> <span class="o">/</span> <span class="n">ToEndLoc</span><span class="p">.</span><span class="n">Size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">HitTargets</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ToEndLoc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后的<code>ServerShotgunFire(HitTargets);</code>的作用就是让服务端执行多播函数，注意在多播函数中，已经执行了LocalFire函数的本机（包括服务端）不需要再执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">ServerShotgunFire_Implementation</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FVector_NetQuantize</span><span class="o">&gt;&amp;</span> <span class="n">TraceHitTargets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">MulticastShotgunFire</span><span class="p">(</span><span class="n">TraceHitTargets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">MulticastShotgunFire_Implementation</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FVector_NetQuantize</span><span class="o">&gt;&amp;</span> <span class="n">TraceHitTargets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Character</span> <span class="o">&amp;&amp;</span> <span class="n">Character</span><span class="o">-&gt;</span><span class="n">IsLocallyControlled</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ShotgunLocalFire</span><span class="p">(</span><span class="n">TraceHitTargets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ShotgunLocalFire(HitTargets);</code>的作用是执行实际的射击内容，包括动画、子弹效果和造成伤害，其中，只有主机才有权限造成实际伤害</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">ShotgunLocalFire</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FVector_NetQuantize</span><span class="o">&gt;&amp;</span> <span class="n">TraceHitTargets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">AShotgun</span><span class="o">*</span> <span class="n">Shotgun</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">AShotgun</span><span class="o">&gt;</span><span class="p">(</span><span class="n">EquippedWeapon</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Shotgun</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">Character</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">CombatState</span> <span class="o">==</span> <span class="n">ECombatState</span><span class="o">::</span><span class="n">ECS_Reloading</span> <span class="o">||</span> <span class="n">CombatState</span> <span class="o">==</span> <span class="n">ECombatState</span><span class="o">::</span><span class="n">ECS_Unoccupied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Character</span><span class="o">-&gt;</span><span class="n">PlayFireMontage</span><span class="p">(</span><span class="n">bAiming</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Shotgun</span><span class="o">-&gt;</span><span class="n">FireShotgun</span><span class="p">(</span><span class="n">TraceHitTargets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">CombatState</span> <span class="o">=</span> <span class="n">ECombatState</span><span class="o">::</span><span class="n">ECS_Unoccupied</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AShotgun</span><span class="o">::</span><span class="n">FireShotgun</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FVector_NetQuantize</span><span class="o">&gt;&amp;</span> <span class="n">HitTargets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">AWeapon</span><span class="o">::</span><span class="n">Fire</span><span class="p">(</span><span class="n">FVector</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="n">APawn</span><span class="o">*</span> <span class="n">OwnerPawn</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetOwner</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">OwnerPawn</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">AController</span><span class="o">*</span> <span class="n">InstigatorController</span> <span class="o">=</span> <span class="n">OwnerPawn</span><span class="o">-&gt;</span><span class="n">GetController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">USkeletalMeshSocket</span><span class="o">*</span> <span class="n">MuzzleFlashSocket</span> <span class="o">=</span> <span class="n">GetWeaponMesh</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSocketByName</span><span class="p">(</span><span class="s">&#34;MuzzleFlash&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MuzzleFlashSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">FTransform</span> <span class="n">SocketTransform</span> <span class="o">=</span> <span class="n">MuzzleFlashSocket</span><span class="o">-&gt;</span><span class="n">GetSocketTransform</span><span class="p">(</span><span class="n">GetWeaponMesh</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">FVector</span>    <span class="n">Start</span> <span class="o">=</span> <span class="n">SocketTransform</span><span class="p">.</span><span class="n">GetLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Maps hit character to number of times hit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">TMap</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">*</span><span class="p">,</span> <span class="n">uint32</span><span class="o">&gt;</span> <span class="n">HitMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span><span class="p">(</span><span class="n">FVector_NetQuantize</span> <span class="nl">HitTarget</span> <span class="p">:</span> <span class="n">HitTargets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FHitResult</span> <span class="n">FireHit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">WeaponTraceHit</span><span class="p">(</span><span class="n">Start</span><span class="p">,</span> <span class="n">HitTarget</span><span class="p">,</span> <span class="n">FireHit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">ABlasterCharacter</span><span class="o">*</span> <span class="n">BlasterCharacter</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">FireHit</span><span class="p">.</span><span class="n">GetActor</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">BlasterCharacter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span><span class="p">(</span><span class="n">HitMap</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">BlasterCharacter</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">HitMap</span><span class="p">[</span><span class="n">BlasterCharacter</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">else</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">HitMap</span><span class="p">.</span><span class="n">Emplace</span><span class="p">(</span><span class="n">BlasterCharacter</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span><span class="p">(</span><span class="n">ImpactParticles</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">SpawnEmitterAtLocation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">						<span class="n">GetWorld</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">						<span class="n">ImpactParticles</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="n">FireHit</span><span class="p">.</span><span class="n">ImpactPoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="n">FireHit</span><span class="p">.</span><span class="n">ImpactNormal</span><span class="p">.</span><span class="n">Rotation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">					<span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span><span class="p">(</span><span class="n">HitSound</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">PlaySoundAtLocation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">						<span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="n">HitSound</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="n">FireHit</span><span class="p">.</span><span class="n">ImpactPoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="mf">.5f</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="n">FMath</span><span class="o">::</span><span class="n">FRandRange</span><span class="p">(</span><span class="o">-</span><span class="mf">.5f</span><span class="p">,</span> <span class="mf">.5f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="nl">HitPair</span> <span class="p">:</span> <span class="n">HitMap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">HitPair</span><span class="p">.</span><span class="n">Key</span> <span class="o">&amp;&amp;</span> <span class="n">HasAuthority</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">InstigatorController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">ApplyDamage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">					<span class="n">HitPair</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="c1">// Character that was hit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Damage</span> <span class="o">*</span> <span class="n">HitPair</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="c1">// Multiply Damage by number of times hit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">InstigatorController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">UDamageType</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="客户端预测在hud上的实现">客户端预测在HUD上的实现<a hidden class="anchor" aria-hidden="true" href="#客户端预测在hud上的实现">#</a></h2>
<p>为了让客户端在射击的时候可以立即观察到HUD上子弹的变化，而不是等到服务器回传才看到变化，需要使用客户端预测技术。</p>
<p>以下是具体实现：</p>
<p>当用户点击开火的时候，首先调用CombatComponent(角色上的一个Actor Component)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">FireProjectileWeapon</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">EquippedWeapon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">HitTarget</span> <span class="o">=</span> <span class="n">EquippedWeapon</span><span class="o">-&gt;</span><span class="n">bUseScatter</span> <span class="o">?</span> <span class="n">EquippedWeapon</span><span class="o">-&gt;</span><span class="n">TraceEndWithScatter</span><span class="p">(</span><span class="n">HitTarget</span><span class="p">)</span> <span class="o">:</span> <span class="n">HitTarget</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="n">LocalFire</span><span class="p">(</span><span class="n">HitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">ServerFire</span><span class="p">(</span><span class="n">HitTarget</span><span class="p">,</span> <span class="n">EquippedWeapon</span><span class="o">-&gt;</span><span class="n">FireDelay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中ServerFire是一个Server的可靠带验证函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">,</span> <span class="n">WithValidation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ServerFire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">,</span> <span class="kt">float</span> <span class="n">FireDelay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UFUNCTION</span><span class="p">(</span><span class="n">NetMulticast</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">MulticastFire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">ServerFire_Implementation</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">,</span> <span class="kt">float</span> <span class="n">FireDelay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">MulticastFire</span><span class="p">(</span><span class="n">TraceHitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">ServerFire_Validate</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">,</span> <span class="kt">float</span> <span class="n">FireDelay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">EquippedWeapon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">bNearlyEqual</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">IsNearlyEqual</span><span class="p">(</span><span class="n">EquippedWeapon</span><span class="o">-&gt;</span><span class="n">FireDelay</span><span class="p">,</span> <span class="n">FireDelay</span><span class="p">,</span> <span class="mf">0.001f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">bNearlyEqual</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里验证的目的是为了FireDelay数据没有被篡改。确保多播函数对非本地的客户端或者服务器调用LocalFire</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">MulticastFire_Implementation</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">Character</span> <span class="o">&amp;&amp;</span> <span class="n">Character</span><span class="o">-&gt;</span><span class="n">IsLocallyControlled</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LocalFire</span><span class="p">(</span><span class="n">TraceHitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>LocalCastFire中，调用角色动画以及调用武器的Fire函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UCombatComponent</span><span class="o">::</span><span class="n">LocalFire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceHitTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">EquippedWeapon</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">Character</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">CombatState</span> <span class="o">==</span> <span class="n">ECombatState</span><span class="o">::</span><span class="n">ECS_Unoccupied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Character</span><span class="o">-&gt;</span><span class="n">PlayFireMontage</span><span class="p">(</span><span class="n">bAiming</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">EquippedWeapon</span><span class="o">-&gt;</span><span class="n">Fire</span><span class="p">(</span><span class="n">TraceHitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>武器的Fire函数是普通函数，该函数执行播放动画，消耗弹药量（SpendRound）等函数，具体的伤害实现是由子类实现的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">virtual</span> <span class="kt">void</span> <span class="nf">Fire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector</span><span class="o">&amp;</span> <span class="n">HitTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">Fire</span><span class="p">(</span><span class="k">const</span> <span class="n">FVector</span><span class="o">&amp;</span> <span class="n">HitTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">FireAnimation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">PlayAnimation</span><span class="p">(</span><span class="n">FireAnimation</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">CasingClass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">USkeletalMeshSocket</span><span class="o">*</span> <span class="n">AmmoEjectSocket</span> <span class="o">=</span> <span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">GetSocketByName</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">&#34;AmmoEject&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">AmmoEjectSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FTransform</span> <span class="n">SocketTransform</span> <span class="o">=</span> <span class="n">AmmoEjectSocket</span><span class="o">-&gt;</span><span class="n">GetSocketTransform</span><span class="p">(</span><span class="n">WeaponMesh</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">World</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">World</span><span class="o">-&gt;</span><span class="n">SpawnActor</span><span class="o">&lt;</span><span class="n">ACasing</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">					<span class="n">CasingClass</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="n">SocketTransform</span><span class="p">.</span><span class="n">GetLocation</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">					<span class="n">SocketTransform</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">().</span><span class="n">Rotator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">				<span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">SpendRound</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>SpendRound中，对于客户端，相关的操作包括修改弹药量、更新HUD，对于本机客户端，还要增加当前状态的编号；对于服务端，除了更新弹药和HUD，还要将更新的结果返回客户端，让本机客户端修正HUD</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">SpendRound</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Ammo</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">Ammo</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MagCapacity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetHUDAmmo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">HasAuthority</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ClientUpdateAmmo</span><span class="p">(</span><span class="n">Ammo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">BlasterOwnerCharacter</span> <span class="o">&amp;&amp;</span> <span class="n">BlasterOwnerCharacter</span><span class="o">-&gt;</span><span class="n">IsLocallyControlled</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">++</span><span class="n">Sequence</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">ClientUpdateAmmo_Implementation</span><span class="p">(</span><span class="n">int32</span> <span class="n">ServerAmmo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">HasAuthority</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Ammo</span> <span class="o">=</span> <span class="n">ServerAmmo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">--</span><span class="n">Sequence</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Ammo</span> <span class="o">-=</span> <span class="n">Sequence</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetHUDAmmo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上的程序解决了用户在延迟较高的时候不能够及时发射子弹的问题，但是依然存在以下问题：</p>
<p>假如客户端和服务端的消耗子弹数量不一致，在HUD上以及实际的弹药中会被修正，但是已经发射出去的子弹不会被消除，也包括造成的相关伤害也不会被修正。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sequenceDiagram
</span></span><span class="line"><span class="cl">    autonumber
</span></span><span class="line"><span class="cl">    actor Player as 玩家输入
</span></span><span class="line"><span class="cl">    participant OC as 本机客户端(Owner)
</span></span><span class="line"><span class="cl">    participant CC as 其他客户端
</span></span><span class="line"><span class="cl">    participant SV as 服务器
</span></span><span class="line"><span class="cl">    participant CCmp as UCombatComponent
</span></span><span class="line"><span class="cl">    participant Wpn as AWeapon
</span></span><span class="line"><span class="cl">    participant Char as Character
</span></span><span class="line"><span class="cl">    participant HUD as HUD
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Player-&gt;&gt;OC: 点击开火
</span></span><span class="line"><span class="cl">OC-&gt;&gt;CCmp: FireProjectileWeapon()
</span></span><span class="line"><span class="cl">alt EquippedWeapon 存在
</span></span><span class="line"><span class="cl">    CCmp-&gt;&gt;CCmp: bUseScatter ? TraceEndWithScatter : HitTarget
</span></span><span class="line"><span class="cl">    CCmp-&gt;&gt;CCmp: LocalFire(HitTarget)
</span></span><span class="line"><span class="cl">    CCmp-&gt;&gt;Char: PlayFireMontage(bAiming)
</span></span><span class="line"><span class="cl">    CCmp-&gt;&gt;Wpn: Fire(HitTarget)
</span></span><span class="line"><span class="cl">    Wpn-&gt;&gt;Wpn: WeaponMesh-&gt;PlayAnimation()
</span></span><span class="line"><span class="cl">    Wpn-&gt;&gt;Wpn: Spawn Casing (AmmoEject Socket)
</span></span><span class="line"><span class="cl">    Wpn-&gt;&gt;Wpn: SpendRound()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Note over OC,HUD: （本机立刻看到开火与HUD变化，降低高延迟体感）
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    CCmp-&gt;&gt;SV: ServerFire(HitTarget, FireDelay) [Server,Reliable,WithValidation]
</span></span><span class="line"><span class="cl">    SV-&gt;&gt;SV: ServerFire_Validate(FireDelay≈EquippedWeapon-&gt;FireDelay?)
</span></span><span class="line"><span class="cl">    alt 校验通过
</span></span><span class="line"><span class="cl">        SV-&gt;&gt;OC: MulticastFire(HitTarget) [NetMulticast,Reliable]
</span></span><span class="line"><span class="cl">        SV-&gt;&gt;CC: MulticastFire(HitTarget)
</span></span><span class="line"><span class="cl">        note over OC: IsLocallyControlled()==true → 跳过本机重复播放
</span></span><span class="line"><span class="cl">        alt CC 端
</span></span><span class="line"><span class="cl">            CC-&gt;&gt;CC: MulticastFire_Implementation()
</span></span><span class="line"><span class="cl">            CC-&gt;&gt;CC: LocalFire(HitTarget)
</span></span><span class="line"><span class="cl">            CC-&gt;&gt;Char: PlayFireMontage()
</span></span><span class="line"><span class="cl">            CC-&gt;&gt;Wpn: Fire(HitTarget)
</span></span><span class="line"><span class="cl">            Wpn-&gt;&gt;Wpn: WeaponMesh-&gt;PlayAnimation()
</span></span><span class="line"><span class="cl">            Wpn-&gt;&gt;Wpn: Spawn Casing
</span></span><span class="line"><span class="cl">            Wpn-&gt;&gt;Wpn: SpendRound()
</span></span><span class="line"><span class="cl">        end
</span></span><span class="line"><span class="cl">    else 校验失败
</span></span><span class="line"><span class="cl">        SV--&gt;&gt;OC: 拒绝(不多播)
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">else 无武器
</span></span><span class="line"><span class="cl">    CCmp--&gt;&gt;OC: 返回(不处理)
</span></span><span class="line"><span class="cl">end
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flowchart LR
</span></span><span class="line"><span class="cl">  %% ---------- Local Client ----------
</span></span><span class="line"><span class="cl">  subgraph LC[Local Client]
</span></span><span class="line"><span class="cl">    A[&#34;Click Fire&#34;] --&gt; B[&#34;CombatComponent::FireProjectileWeapon()&#34;]
</span></span><span class="line"><span class="cl">    B --&gt;|&#34;bUseScatter&#34;| BS[&#34;HitTarget = TraceEndWithScatter(HitTarget)&#34;]
</span></span><span class="line"><span class="cl">    BS --&gt; C[&#34;LocalFire(HitTarget)&#34;]
</span></span><span class="line"><span class="cl">    B --&gt;|&#34;else&#34;| C
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    B --&gt; D[&#34;ServerFire(HitTarget, FireDelay)&#34;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    C --&gt; C1[&#34;Character::PlayFireMontage(bAiming)&#34;]
</span></span><span class="line"><span class="cl">    C --&gt; C2[&#34;EquippedWeapon::Fire(HitTarget)&#34;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    C2 --&gt; W1[&#34;AWeapon::Fire()&#34;]
</span></span><span class="line"><span class="cl">    W1 --&gt; W1a[&#34;PlayAnimation(FireAnimation)&#34;]
</span></span><span class="line"><span class="cl">    W1 --&gt; W1b[&#34;Spawn Casing if CasingClass&#34;]
</span></span><span class="line"><span class="cl">    W1 --&gt; W2[&#34;SpendRound()&#34;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    W2 --&gt; W2a[&#34;Ammo--, Clamp, SetHUDAmmo&#34;]
</span></span><span class="line"><span class="cl">    W2 --&gt;|&#34;Client and LocallyControlled&#34;| W2b[&#34;++Sequence&#34;]
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  %% ---------- Server ----------
</span></span><span class="line"><span class="cl">  subgraph SV[Server]
</span></span><span class="line"><span class="cl">    D --&gt; V[&#34;ServerFire_Validate&#34;]
</span></span><span class="line"><span class="cl">    V --&gt;|&#34;Not NearlyEqual(FireDelay)&#34;| RJ[&#34;Reject&#34;]
</span></span><span class="line"><span class="cl">    V --&gt;|&#34;NearlyEqual&#34;| IMPL[&#34;ServerFire_Implementation&#34;]
</span></span><span class="line"><span class="cl">    IMPL --&gt; MCast[&#34;MulticastFire(HitTarget)&#34;]
</span></span><span class="line"><span class="cl">    MCast --&gt; MS[&#34;MulticastFire_Implementation&#34;]
</span></span><span class="line"><span class="cl">    MS --&gt;|&#34;IsLocallyControlled&#34;| RET[&#34;return&#34;]
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  %% ---------- Remote Clients ----------
</span></span><span class="line"><span class="cl">  subgraph RC[Remote Clients]
</span></span><span class="line"><span class="cl">    MCast --&gt; RM0[&#34;MulticastFire_Implementation&#34;]
</span></span><span class="line"><span class="cl">    RM0 --&gt; RM1[&#34;LocalFire(HitTarget)&#34;]
</span></span><span class="line"><span class="cl">    RM1 --&gt; RM2[&#34;Character::PlayFireMontage(bAiming)&#34;]
</span></span><span class="line"><span class="cl">    RM1 --&gt; RM3[&#34;EquippedWeapon::Fire(HitTarget)&#34;]
</span></span><span class="line"><span class="cl">    RM3 --&gt; RM4[&#34;SpendRound()&#34;]
</span></span><span class="line"><span class="cl">    RM4 --&gt; RM5[&#34;Ammo--, Clamp, SetHUDAmmo&#34;]
</span></span><span class="line"><span class="cl">  end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  %% ---------- Ammo/HUD Sync ----------
</span></span><span class="line"><span class="cl">  subgraph Sync[Ammo/HUD Sync]
</span></span><span class="line"><span class="cl">    W2 --&gt;|&#34;Server Authority&#34;| RPC[&#34;ClientUpdateAmmo(Ammo)&#34;]
</span></span><span class="line"><span class="cl">    RPC --&gt; CU[&#34;AWeapon::ClientUpdateAmmo_Implementation&#34;]
</span></span><span class="line"><span class="cl">    CU --&gt; CU1[&#34;Ammo = ServerAmmo; --Sequence; Ammo -= Sequence; SetHUDAmmo&#34;]
</span></span><span class="line"><span class="cl">  end
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="服务器回滚延迟补偿技术">服务器回滚（延迟补偿技术）<a hidden class="anchor" aria-hidden="true" href="#服务器回滚延迟补偿技术">#</a></h2>
<p>在存在延迟的情况下，当客户端击中了某个对象时，在服务器上实际并未击中。为了让高延迟玩家在击中对方时拥有比较好的体验，可以引入服务器回滚技术。</p>
<ul>
<li>服务器回滚技术在主机端存储所有角色（的碰撞箱）的短时间内的历史记录，客户端在击中对象之后，将击中对象的信息，击中时间（客户端估计的服务器时间）等信息发送给服务器（使用Server RPC）；</li>
<li>服务器使用一个双向链表（UE中的<code>TDoubleLinkedList&lt;&gt;</code>）存储每个玩家在某个时间的信息，并且将玩家显示的击中时间和对应的碰撞箱子进行匹配（我认为在服务器帧率够高的情况下可以不进行插值以简化计算），选择两个最接近的帧进行插值，得到这个时间所对应的Box。</li>
<li>将现在的Box替换成回滚的Box，进行射线检测，如果击中则判定造成伤害，没有击中则不造成伤害。（这里根据不同部位造成的不同伤害进行多次判定，比如只将头部的Box设置为有碰撞进行检测，然后再将所有Box进行检测）</li>
<li>将现在的Box替换回来，取消掉碰撞检测。</li>
</ul>
<p>服务器回滚的优点在于当玩家延迟较高时，不会产生客户端看上去击中，但是实际没有命中的现象，缺点在于当客户端玩家延迟过高时，其他玩家会发现自己进入掩体后仍然会受到伤害，这明显降低了其他玩家的体验，所以需要进行权衡。</p>
<p>一种解决方案是服务器控制存储的历史记录的范围，当客户端传来的命中纪录超出该范围后就不进行回滚，这时玩家需要根据根据自己的延迟进行预判射击。</p>
<p><img alt="image-20250805110619272" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250805110619272.png"></p>
<p>下面是实现例子：</p>
<p>首先是存储每一帧的数据结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FBoxInformation</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">FVector</span> <span class="n">Location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">FRotator</span> <span class="n">Rotation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">FVector</span> <span class="n">BoxExtent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FFramePackage</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="kt">float</span> <span class="n">Time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">TMap</span><span class="o">&lt;</span><span class="n">FName</span><span class="p">,</span> <span class="n">FBoxInformation</span><span class="o">&gt;</span> <span class="n">HitBoxInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后是返回的命中结果（区分爆头和普通命中）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FServerSideRewindResult</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bHitConfirmed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bHeadShot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来是相应的实现，放在一个Actor Component中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ULagCompensationComponent</span><span class="o">::</span><span class="n">ServerScoreRequest_Implementation</span><span class="p">(</span><span class="n">ABlasterCharacter</span><span class="o">*</span> <span class="n">HitCharacter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">HitLocation</span><span class="p">,</span> <span class="kt">float</span> <span class="n">HitTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                  <span class="k">class</span> <span class="nc">AWeapon</span><span class="o">*</span> <span class="n">DamageCauser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FServerSideRewindResult</span> <span class="n">Confirm</span> <span class="o">=</span> <span class="n">ServerSideRewind</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">TraceStart</span><span class="p">,</span> <span class="n">HitLocation</span><span class="p">,</span> <span class="n">HitTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">Character</span> <span class="o">&amp;&amp;</span> <span class="n">HitCharacter</span> <span class="o">&amp;&amp;</span> <span class="n">DamageCauser</span> <span class="o">&amp;&amp;</span> <span class="n">Confirm</span><span class="p">.</span><span class="n">bHitConfirmed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">ApplyDamage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="n">HitCharacter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">DamageCauser</span><span class="o">-&gt;</span><span class="n">GetDamage</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="n">Character</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">DamageCauser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">UDamageType</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FServerSideRewindResult</span> <span class="n">ULagCompensationComponent</span><span class="o">::</span><span class="n">ServerSideRewind</span><span class="p">(</span><span class="k">class</span> <span class="nc">ABlasterCharacter</span><span class="o">*</span> <span class="n">HitCharacter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                    <span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                    <span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">HitLocation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                    <span class="kt">float</span> <span class="n">HitTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bReturn</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">		<span class="n">HitCharacter</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">		<span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">GetLagCompensation</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">		<span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">GetLagCompensation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">FrameHistory</span><span class="p">.</span><span class="n">GetHead</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">		<span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">GetLagCompensation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">FrameHistory</span><span class="p">.</span><span class="n">GetTail</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">bReturn</span><span class="p">)</span> <span class="k">return</span> <span class="n">FServerSideRewindResult</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Frame package that we check to verify a hit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FFramePackage</span> <span class="n">FrameToCheck</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bShouldInterpolate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Frame history of the HitCharacter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">const</span> <span class="n">TDoubleLinkedList</span><span class="o">&lt;</span><span class="n">FFramePackage</span><span class="o">&gt;&amp;</span> <span class="n">History</span> <span class="o">=</span> <span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">GetLagCompensation</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">FrameHistory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">float</span> <span class="n">OldestHistoryTime</span> <span class="o">=</span> <span class="n">History</span><span class="p">.</span><span class="n">GetTail</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">().</span><span class="n">Time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">float</span> <span class="n">NewestHistoryTime</span> <span class="o">=</span> <span class="n">History</span><span class="p">.</span><span class="n">GetHead</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">().</span><span class="n">Time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">OldestHistoryTime</span> <span class="o">&gt;</span> <span class="n">HitTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// too far back - too laggy to do SSR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nf">FServerSideRewindResult</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">OldestHistoryTime</span> <span class="o">==</span> <span class="n">HitTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FrameToCheck</span> <span class="o">=</span> <span class="n">History</span><span class="p">.</span><span class="n">GetTail</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">bShouldInterpolate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">NewestHistoryTime</span> <span class="o">&lt;=</span> <span class="n">HitTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FrameToCheck</span> <span class="o">=</span> <span class="n">History</span><span class="p">.</span><span class="n">GetHead</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">bShouldInterpolate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">TDoubleLinkedList</span><span class="o">&lt;</span><span class="n">FFramePackage</span><span class="o">&gt;::</span><span class="n">TDoubleLinkedListNode</span><span class="o">*</span> <span class="n">Younger</span> <span class="o">=</span> <span class="n">History</span><span class="p">.</span><span class="n">GetHead</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">TDoubleLinkedList</span><span class="o">&lt;</span><span class="n">FFramePackage</span><span class="o">&gt;::</span><span class="n">TDoubleLinkedListNode</span><span class="o">*</span> <span class="n">Older</span> <span class="o">=</span> <span class="n">Younger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">Older</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">().</span><span class="n">Time</span> <span class="o">&gt;</span> <span class="n">HitTime</span><span class="p">)</span> <span class="c1">// is Older still younger than HitTime?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// March back until: OlderTime &lt; HitTime &lt; YoungerTime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">Older</span><span class="o">-&gt;</span><span class="n">GetNextNode</span><span class="p">()</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Older</span> <span class="o">=</span> <span class="n">Older</span><span class="o">-&gt;</span><span class="n">GetNextNode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">Older</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">().</span><span class="n">Time</span> <span class="o">&gt;</span> <span class="n">HitTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Younger</span> <span class="o">=</span> <span class="n">Older</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">Older</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">().</span><span class="n">Time</span> <span class="o">==</span> <span class="n">HitTime</span><span class="p">)</span> <span class="c1">// highly unlikely, but we found our frame to check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FrameToCheck</span> <span class="o">=</span> <span class="n">Older</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">bShouldInterpolate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">bShouldInterpolate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Interpolate between Younger and Older
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">FrameToCheck</span> <span class="o">=</span> <span class="n">InterpBetweenFrames</span><span class="p">(</span><span class="n">Older</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">(),</span> <span class="n">Younger</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">(),</span> <span class="n">HitTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ConfirmHit</span><span class="p">(</span><span class="n">FrameToCheck</span><span class="p">,</span> <span class="n">HitCharacter</span><span class="p">,</span> <span class="n">TraceStart</span><span class="p">,</span> <span class="n">HitLocation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FFramePackage</span> <span class="n">ULagCompensationComponent</span><span class="o">::</span><span class="n">InterpBetweenFrames</span><span class="p">(</span><span class="k">const</span> <span class="n">FFramePackage</span><span class="o">&amp;</span> <span class="n">OlderFrame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                             <span class="k">const</span> <span class="n">FFramePackage</span><span class="o">&amp;</span> <span class="n">YoungerFrame</span><span class="p">,</span> <span class="kt">float</span> <span class="n">HitTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">float</span> <span class="n">Distance</span> <span class="o">=</span> <span class="n">YoungerFrame</span><span class="p">.</span><span class="n">Time</span> <span class="o">-</span> <span class="n">OlderFrame</span><span class="p">.</span><span class="n">Time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">float</span> <span class="n">InterpFraction</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">((</span><span class="n">HitTime</span> <span class="o">-</span> <span class="n">OlderFrame</span><span class="p">.</span><span class="n">Time</span><span class="p">)</span> <span class="o">/</span> <span class="n">Distance</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">FFramePackage</span> <span class="n">InterpFramePackage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">InterpFramePackage</span><span class="p">.</span><span class="n">Time</span> <span class="o">=</span> <span class="n">HitTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">YoungerPair</span> <span class="p">:</span> <span class="n">YoungerFrame</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">FName</span><span class="o">&amp;</span> <span class="n">BoxInfoName</span> <span class="o">=</span> <span class="n">YoungerPair</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">FBoxInformation</span><span class="o">&amp;</span> <span class="n">OlderBox</span> <span class="o">=</span> <span class="n">OlderFrame</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">[</span><span class="n">BoxInfoName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">FBoxInformation</span><span class="o">&amp;</span> <span class="n">YoungerBox</span> <span class="o">=</span> <span class="n">YoungerFrame</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">[</span><span class="n">BoxInfoName</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">FBoxInformation</span> <span class="n">InterpBoxInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">InterpBoxInfo</span><span class="p">.</span><span class="n">Location</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">OlderBox</span><span class="p">.</span><span class="n">Location</span><span class="p">,</span> <span class="n">YoungerBox</span><span class="p">.</span><span class="n">Location</span><span class="p">,</span> <span class="n">InterpFraction</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 用Quat插值Rotation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">FQuat</span> <span class="n">QuatA</span> <span class="o">=</span> <span class="n">OlderBox</span><span class="p">.</span><span class="n">Rotation</span><span class="p">.</span><span class="n">Quaternion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">FQuat</span> <span class="n">QuatB</span> <span class="o">=</span> <span class="n">YoungerBox</span><span class="p">.</span><span class="n">Rotation</span><span class="p">.</span><span class="n">Quaternion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">InterpBoxInfo</span><span class="p">.</span><span class="n">Rotation</span> <span class="o">=</span> <span class="n">FQuat</span><span class="o">::</span><span class="n">Slerp</span><span class="p">(</span><span class="n">QuatA</span><span class="p">,</span> <span class="n">QuatB</span><span class="p">,</span> <span class="n">InterpFraction</span><span class="p">).</span><span class="n">Rotator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">InterpBoxInfo</span><span class="p">.</span><span class="n">BoxExtent</span> <span class="o">=</span> <span class="n">YoungerBox</span><span class="p">.</span><span class="n">BoxExtent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">InterpFramePackage</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">BoxInfoName</span><span class="p">,</span> <span class="n">InterpBoxInfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">InterpFramePackage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以下是检查命中的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FServerSideRewindResult</span> <span class="n">ULagCompensationComponent</span><span class="o">::</span><span class="n">ConfirmHit</span><span class="p">(</span><span class="k">const</span> <span class="n">FFramePackage</span><span class="o">&amp;</span> <span class="n">Package</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                              <span class="n">ABlasterCharacter</span><span class="o">*</span> <span class="n">HitCharacter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                              <span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">TraceStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                              <span class="k">const</span> <span class="n">FVector_NetQuantize</span><span class="o">&amp;</span> <span class="n">HitLocation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">HitCharacter</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="n">FServerSideRewindResult</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">FFramePackage</span> <span class="n">CurrentFrame</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">CacheBoxPositions</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">CurrentFrame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">MoveBoxes</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">Package</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">EnableCharacterMeshCollision</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">NoCollision</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Enable collision for the head first
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">UBoxComponent</span><span class="o">*</span> <span class="n">HeadBox</span> <span class="o">=</span> <span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">HitCollisionBoxes</span><span class="p">[</span><span class="n">FName</span><span class="p">(</span><span class="s">&#34;head&#34;</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">	<span class="n">HeadBox</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryAndPhysics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">HeadBox</span><span class="o">-&gt;</span><span class="n">SetCollisionResponseToChannel</span><span class="p">(</span><span class="n">ECollisionChannel</span><span class="o">::</span><span class="n">ECC_Visibility</span><span class="p">,</span> <span class="n">ECollisionResponse</span><span class="o">::</span><span class="n">ECR_Block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">FHitResult</span> <span class="n">ConfirmHitResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">FVector</span> <span class="n">TraceEnd</span> <span class="o">=</span> <span class="n">TraceStart</span> <span class="o">+</span> <span class="p">(</span><span class="n">HitLocation</span> <span class="o">-</span> <span class="n">TraceStart</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.25f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">World</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">World</span><span class="o">-&gt;</span><span class="n">LineTraceSingleByChannel</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="n">ConfirmHitResult</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">TraceStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">TraceEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">ECollisionChannel</span><span class="o">::</span><span class="n">ECC_Visibility</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">ConfirmHitResult</span><span class="p">.</span><span class="n">bBlockingHit</span><span class="p">)</span> <span class="c1">// we hit the head, return early
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ResetHitBoxes</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">CurrentFrame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">EnableCharacterMeshCollision</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryAndPhysics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">FServerSideRewindResult</span><span class="p">{</span><span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="c1">// didn&#39;t hit head, check the rest of the boxes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">HitBoxPair</span> <span class="p">:</span> <span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">HitCollisionBoxes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryAndPhysics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetCollisionResponseToChannel</span><span class="p">(</span><span class="n">ECollisionChannel</span><span class="o">::</span><span class="n">ECC_Visibility</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					                                                <span class="n">ECollisionResponse</span><span class="o">::</span><span class="n">ECR_Block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">World</span><span class="o">-&gt;</span><span class="n">LineTraceSingleByChannel</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="n">ConfirmHitResult</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">TraceStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">TraceEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">ECollisionChannel</span><span class="o">::</span><span class="n">ECC_Visibility</span>
</span></span><span class="line"><span class="cl">			<span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">ConfirmHitResult</span><span class="p">.</span><span class="n">bBlockingHit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">ResetHitBoxes</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">CurrentFrame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">EnableCharacterMeshCollision</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryAndPhysics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">FServerSideRewindResult</span><span class="p">{</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ResetHitBoxes</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">CurrentFrame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">EnableCharacterMeshCollision</span><span class="p">(</span><span class="n">HitCharacter</span><span class="p">,</span> <span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryAndPhysics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">FServerSideRewindResult</span><span class="p">{</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面是工具函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ULagCompensationComponent</span><span class="o">::</span><span class="n">CacheBoxPositions</span><span class="p">(</span><span class="n">ABlasterCharacter</span><span class="o">*</span> <span class="n">HitCharacter</span><span class="p">,</span> <span class="n">FFramePackage</span><span class="o">&amp;</span> <span class="n">OutFramePackage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">HitCharacter</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">HitBoxPair</span> <span class="p">:</span> <span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">HitCollisionBoxes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FBoxInformation</span> <span class="n">BoxInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">BoxInfo</span><span class="p">.</span><span class="n">Location</span> <span class="o">=</span> <span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">GetComponentLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">BoxInfo</span><span class="p">.</span><span class="n">Rotation</span> <span class="o">=</span> <span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">GetComponentRotation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">BoxInfo</span><span class="p">.</span><span class="n">BoxExtent</span> <span class="o">=</span> <span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">GetScaledBoxExtent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">OutFramePackage</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">BoxInfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ULagCompensationComponent</span><span class="o">::</span><span class="n">MoveBoxes</span><span class="p">(</span><span class="n">ABlasterCharacter</span><span class="o">*</span> <span class="n">HitCharacter</span><span class="p">,</span> <span class="k">const</span> <span class="n">FFramePackage</span><span class="o">&amp;</span> <span class="n">Package</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">HitCharacter</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">HitBoxPair</span> <span class="p">:</span> <span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">HitCollisionBoxes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetWorldLocation</span><span class="p">(</span><span class="n">Package</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">[</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Key</span><span class="p">].</span><span class="n">Location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetWorldRotation</span><span class="p">(</span><span class="n">Package</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">[</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Key</span><span class="p">].</span><span class="n">Rotation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetBoxExtent</span><span class="p">(</span><span class="n">Package</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">[</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Key</span><span class="p">].</span><span class="n">BoxExtent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ULagCompensationComponent</span><span class="o">::</span><span class="n">ResetHitBoxes</span><span class="p">(</span><span class="n">ABlasterCharacter</span><span class="o">*</span> <span class="n">HitCharacter</span><span class="p">,</span> <span class="k">const</span> <span class="n">FFramePackage</span><span class="o">&amp;</span> <span class="n">Package</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">HitCharacter</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">HitBoxPair</span> <span class="p">:</span> <span class="n">HitCharacter</span><span class="o">-&gt;</span><span class="n">HitCollisionBoxes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetWorldLocation</span><span class="p">(</span><span class="n">Package</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">[</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Key</span><span class="p">].</span><span class="n">Location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetWorldRotation</span><span class="p">(</span><span class="n">Package</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">[</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Key</span><span class="p">].</span><span class="n">Rotation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetBoxExtent</span><span class="p">(</span><span class="n">Package</span><span class="p">.</span><span class="n">HitBoxInfo</span><span class="p">[</span><span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Key</span><span class="p">].</span><span class="n">BoxExtent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">HitBoxPair</span><span class="p">.</span><span class="n">Value</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">NoCollision</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="服务器回滚技术在投射类武器的实现">服务器回滚技术在投射类武器的实现<a hidden class="anchor" aria-hidden="true" href="#服务器回滚技术在投射类武器的实现">#</a></h3>
<p>假如需要对发射的子弹使用服务器回滚技术来提升玩家体验，我们需要两种ProjectTile：复制的和不复制的.</p>
<p><img alt="image-20250808105620969" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250808105620969.png"></p>
<p><strong>修正</strong>：对于上图中Server-Not Locally Controlled的情况，在武器使用SSR技术的时候，也需要发射SSR的子弹，并在击中目标时进行条件判断自己是否通过造成伤害。</p>
<h2 id="限制服务器回滚">限制服务器回滚<a hidden class="anchor" aria-hidden="true" href="#限制服务器回滚">#</a></h2>
<p>假设根据变量<code>float HighPingThreshold = 50.f;</code>来修改是否限制服务器回滚，超过该限制则禁用，否则打开服务器回滚</p>
<ol>
<li>设置武器回调函数</li>
</ol>
<p>​	由于是否使用服务器回滚技术目前是绑定武器的，所以首先要将武器是否使用回滚技术设置为复制变量，并且设置为复制到武器拥有者</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Replicated</span><span class="p">,</span> <span class="n">EditAnywhere</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">bUseServerSideRewind</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">OnPingTooHigh</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bPingTooHigh</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">FLifetimeProperty</span><span class="o">&gt;&amp;</span> <span class="n">OutLifetimeProps</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">GetLifetimeReplicatedProps</span><span class="p">(</span><span class="n">OutLifetimeProps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DOREPLIFETIME</span><span class="p">(</span><span class="n">AWeapon</span><span class="p">,</span> <span class="n">WeaponState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">DOREPLIFETIME_CONDITION</span><span class="p">(</span><span class="n">AWeapon</span><span class="p">,</span> <span class="n">bUseServerSideRewind</span><span class="p">,</span> <span class="n">COND_OwnerOnly</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">OnPingTooHigh</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bPingTooHigh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">bUseServerSideRewind</span> <span class="o">=</span> <span class="o">!</span><span class="n">bPingTooHigh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>设置Controller代理以及广播条件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FHighPingDelegate</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">bPingTooHigh</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UCLASS</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BLASTERS_API</span> <span class="nl">ABlasterPlayerController</span> <span class="p">:</span> <span class="k">public</span> <span class="n">APlayerController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="n">FHighPingDelegate</span> <span class="n">HighPingDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">Server</span><span class="p">,</span> <span class="n">Reliable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">ServerReportPingStatus</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bHighPing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在装备或者丢下武器时，绑定或者解绑回调函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">OnEquipped</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ShowPickUpWidget</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">AreaSphere</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">NoCollision</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetSimulatePhysics</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetEnableGravity</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">NoCollision</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">WeaponType</span> <span class="o">==</span> <span class="n">EWeaponType</span><span class="o">::</span><span class="n">EWT_SubmachineGun</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryAndPhysics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetEnableGravity</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionResponseToAllChannels</span><span class="p">(</span><span class="n">ECollisionResponse</span><span class="o">::</span><span class="n">ECR_Ignore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">EnableCustomDepth</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">BlasterOwnerCharacter</span> <span class="o">=</span> <span class="n">BlasterOwnerCharacter</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetOwner</span><span class="p">())</span> <span class="o">:</span> <span class="n">BlasterOwnerCharacter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">BlasterOwnerCharacter</span> <span class="o">&amp;&amp;</span> <span class="n">bUseServerSideRewind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BlasterOwnerController</span> <span class="o">=</span> <span class="n">BlasterOwnerController</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BlasterOwnerCharacter</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">)</span> <span class="o">:</span> <span class="n">BlasterOwnerController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">BlasterOwnerController</span> <span class="o">&amp;&amp;</span> <span class="n">HasAuthority</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BlasterOwnerController</span><span class="o">-&gt;</span><span class="n">HighPingDelegate</span><span class="p">.</span><span class="n">IsBound</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">BlasterOwnerController</span><span class="o">-&gt;</span><span class="n">HighPingDelegate</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AWeapon</span><span class="o">::</span><span class="n">OnPingTooHigh</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">OnEquippedSecondary</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ShowPickUpWidget</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">AreaSphere</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">NoCollision</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetSimulatePhysics</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetEnableGravity</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">NoCollision</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">WeaponType</span> <span class="o">==</span> <span class="n">EWeaponType</span><span class="o">::</span><span class="n">EWT_SubmachineGun</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryAndPhysics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetEnableGravity</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionResponseToAllChannels</span><span class="p">(</span><span class="n">ECollisionResponse</span><span class="o">::</span><span class="n">ECR_Ignore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">EnableCustomDepth</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">WeaponMesh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCustomDepthStencilValue</span><span class="p">(</span><span class="n">CUSTOM_DEPTH_TAN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">MarkRenderStateDirty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">BlasterOwnerCharacter</span> <span class="o">=</span> <span class="n">BlasterOwnerCharacter</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetOwner</span><span class="p">())</span> <span class="o">:</span> <span class="n">BlasterOwnerCharacter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">BlasterOwnerCharacter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BlasterOwnerController</span> <span class="o">=</span> <span class="n">BlasterOwnerController</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BlasterOwnerCharacter</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">)</span> <span class="o">:</span> <span class="n">BlasterOwnerController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">BlasterOwnerController</span> <span class="o">&amp;&amp;</span> <span class="n">HasAuthority</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">BlasterOwnerController</span><span class="o">-&gt;</span><span class="n">HighPingDelegate</span><span class="p">.</span><span class="n">IsBound</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">BlasterOwnerController</span><span class="o">-&gt;</span><span class="n">HighPingDelegate</span><span class="p">.</span><span class="n">RemoveDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AWeapon</span><span class="o">::</span><span class="n">OnPingTooHigh</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AWeapon</span><span class="o">::</span><span class="n">OnDropped</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">HasAuthority</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">AreaSphere</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryOnly</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetSimulatePhysics</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetEnableGravity</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionEnabled</span><span class="p">(</span><span class="n">ECollisionEnabled</span><span class="o">::</span><span class="n">QueryAndPhysics</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionResponseToAllChannels</span><span class="p">(</span><span class="n">ECollisionResponse</span><span class="o">::</span><span class="n">ECR_Block</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionResponseToChannel</span><span class="p">(</span><span class="n">ECollisionChannel</span><span class="o">::</span><span class="n">ECC_Pawn</span><span class="p">,</span> <span class="n">ECollisionResponse</span><span class="o">::</span><span class="n">ECR_Ignore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCollisionResponseToChannel</span><span class="p">(</span><span class="n">ECollisionChannel</span><span class="o">::</span><span class="n">ECC_Camera</span><span class="p">,</span> <span class="n">ECollisionResponse</span><span class="o">::</span><span class="n">ECR_Ignore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">SetCustomDepthStencilValue</span><span class="p">(</span><span class="n">CUSTOM_DEPTH_BLUE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">WeaponMesh</span><span class="o">-&gt;</span><span class="n">MarkRenderStateDirty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">EnableCustomDepth</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">BlasterOwnerCharacter</span> <span class="o">=</span> <span class="n">BlasterOwnerCharacter</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterCharacter</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GetOwner</span><span class="p">())</span> <span class="o">:</span> <span class="n">BlasterOwnerCharacter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">BlasterOwnerCharacter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BlasterOwnerController</span> <span class="o">=</span> <span class="n">BlasterOwnerController</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">?</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ABlasterPlayerController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BlasterOwnerCharacter</span><span class="o">-&gt;</span><span class="n">Controller</span><span class="p">)</span> <span class="o">:</span> <span class="n">BlasterOwnerController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">BlasterOwnerController</span> <span class="o">&amp;&amp;</span> <span class="n">HasAuthority</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">BlasterOwnerController</span><span class="o">-&gt;</span><span class="n">HighPingDelegate</span><span class="p">.</span><span class="n">IsBound</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">BlasterOwnerController</span><span class="o">-&gt;</span><span class="n">HighPingDelegate</span><span class="p">.</span><span class="n">RemoveDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">AWeapon</span><span class="o">::</span><span class="n">OnPingTooHigh</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此外每隔固定时间也要进行Ping检查，并且调用Server RPC来进行广播</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">CheckPing</span><span class="p">(</span><span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">HasAuthority</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">HighPingRunningTime</span> <span class="o">+=</span> <span class="n">DeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">HighPingRunningTime</span> <span class="o">&gt;</span> <span class="n">CheckPingFrequency</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PlayerState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerState</span> <span class="o">=</span> <span class="n">GetPlayerState</span><span class="o">&lt;</span><span class="n">APlayerState</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">PlayerState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">PlayerState</span><span class="o">-&gt;</span><span class="n">GetPingInMilliseconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">HighPingThreshold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">HighPingWarning</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">				<span class="n">PingAnimationRunningTime</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">ServerReportPingStatus</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">ServerReportPingStatus</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">HighPingRunningTime</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bHighPingAnimationPlaying</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">		<span class="n">BlasterHUD</span> <span class="o">&amp;&amp;</span> <span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">CharacterOverlay</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">		<span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">CharacterOverlay</span><span class="o">-&gt;</span><span class="n">HighPingAnimation</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">		<span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">CharacterOverlay</span><span class="o">-&gt;</span><span class="n">IsAnimationPlaying</span><span class="p">(</span><span class="n">BlasterHUD</span><span class="o">-&gt;</span><span class="n">CharacterOverlay</span><span class="o">-&gt;</span><span class="n">HighPingAnimation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">bHighPingAnimationPlaying</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">PingAnimationRunningTime</span> <span class="o">+=</span> <span class="n">DeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">PingAnimationRunningTime</span> <span class="o">&gt;</span> <span class="n">HighPingDuration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">StopHighPingWarning</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ABlasterPlayerController</span><span class="o">::</span><span class="n">ServerReportPingStatus_Implementation</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bHighPing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">HighPingDelegate</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">bHighPing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://wstfdxfh.github.io/posts/unrealengine/unrealversioncontrol/">
    <span class="title">« Prev</span>
    <br>
    <span>UnrealVersionControl</span>
  </a>
  <a class="next" href="https://wstfdxfh.github.io/posts/unrealengine/unrealdebug/">
    <span class="title">Next »</span>
    <br>
    <span>UnrealDebug</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UnrealOnline on x"
            href="https://x.com/intent/tweet/?text=UnrealOnline&amp;url=https%3a%2f%2fwstfdxfh.github.io%2fposts%2funrealengine%2funrealonline%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UnrealOnline on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwstfdxfh.github.io%2fposts%2funrealengine%2funrealonline%2f&amp;title=UnrealOnline&amp;summary=UnrealOnline&amp;source=https%3a%2f%2fwstfdxfh.github.io%2fposts%2funrealengine%2funrealonline%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UnrealOnline on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fwstfdxfh.github.io%2fposts%2funrealengine%2funrealonline%2f&title=UnrealOnline">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UnrealOnline on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwstfdxfh.github.io%2fposts%2funrealengine%2funrealonline%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UnrealOnline on whatsapp"
            href="https://api.whatsapp.com/send?text=UnrealOnline%20-%20https%3a%2f%2fwstfdxfh.github.io%2fposts%2funrealengine%2funrealonline%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UnrealOnline on telegram"
            href="https://telegram.me/share/url?text=UnrealOnline&amp;url=https%3a%2f%2fwstfdxfh.github.io%2fposts%2funrealengine%2funrealonline%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UnrealOnline on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=UnrealOnline&u=https%3a%2f%2fwstfdxfh.github.io%2fposts%2funrealengine%2funrealonline%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://wstfdxfh.github.io/">李睿杰的博客</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
