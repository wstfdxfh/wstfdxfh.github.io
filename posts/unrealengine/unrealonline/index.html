<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>UnrealOnline | 李睿杰的博客</title>
<meta name="keywords" content="">
<meta name="description" content="简介
相关课程：
https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/
这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。
效果如下：

在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。
配置文件设置
在DefaultEngine.ini中，添加以下内容：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


[/Script/Engine.GameEngine]
&#43;NetDriverDefinitions=(DefName=&#34;GameNetDriver&#34;,DriverClassName=&#34;OnlineSubsystemSteam.SteamNetDriver&#34;,DriverClassNameFallback=&#34;OnlineSubsystemUtils.IpNetDriver&#34;)

[OnlineSubsystem]
DefaultPlatformService=Steam

[OnlineSubsystemSteam]
bEnabled=true
SteamDevAppId=480
bInitServerOnClient=true

[/Script/OnlineSubsystemSteam.SteamNetDriver]
NetConnectionClassName=&#34;OnlineSubsystemSteam.SteamNetConnection&#34;


480是一个公用的游戏id
在DefaultEngine.ini中添加


1
2


[/Script/Engine.GameSession]
MaxPlayers=100


规定了最大玩家数量。
插件创建
在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：

例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。
在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20


{
    ...
	&#34;Modules&#34;: [
		{
			&#34;Name&#34;: &#34;MultiplayerSessions&#34;,
			&#34;Type&#34;: &#34;Runtime&#34;,
			&#34;LoadingPhase&#34;: &#34;Default&#34;
		}
	],
	&#34;Plugins&#34;:[
		{
			&#34;Name&#34;: &#34;OnlineSubsystem&#34;,
			&#34;Enabled&#34;: true
		},
		{
			&#34;Name&#34;: &#34;OnlineSubsystemSteam&#34;,
			&#34;Enabled&#34;: true
		}
	]
}


MultiplayerSessions.Build.cs">
<meta name="author" content="李睿杰">
<link rel="canonical" href="https://wstfdxfh.github.io/posts/unrealengine/unrealonline/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://wstfdxfh.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://wstfdxfh.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://wstfdxfh.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://wstfdxfh.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://wstfdxfh.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://wstfdxfh.github.io/posts/unrealengine/unrealonline/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://wstfdxfh.github.io/posts/unrealengine/unrealonline/">
  <meta property="og:site_name" content="李睿杰的博客">
  <meta property="og:title" content="UnrealOnline">
  <meta property="og:description" content="简介 相关课程：
https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/
这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。
效果如下：
在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。
配置文件设置 在DefaultEngine.ini中，添加以下内容：
1 2 3 4 5 6 7 8 9 10 11 12 13 [/Script/Engine.GameEngine] &#43;NetDriverDefinitions=(DefName=&#34;GameNetDriver&#34;,DriverClassName=&#34;OnlineSubsystemSteam.SteamNetDriver&#34;,DriverClassNameFallback=&#34;OnlineSubsystemUtils.IpNetDriver&#34;) [OnlineSubsystem] DefaultPlatformService=Steam [OnlineSubsystemSteam] bEnabled=true SteamDevAppId=480 bInitServerOnClient=true [/Script/OnlineSubsystemSteam.SteamNetDriver] NetConnectionClassName=&#34;OnlineSubsystemSteam.SteamNetConnection&#34; 480是一个公用的游戏id
在DefaultEngine.ini中添加
1 2 [/Script/Engine.GameSession] MaxPlayers=100 规定了最大玩家数量。
插件创建 在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：
例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。
在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { ... &#34;Modules&#34;: [ { &#34;Name&#34;: &#34;MultiplayerSessions&#34;, &#34;Type&#34;: &#34;Runtime&#34;, &#34;LoadingPhase&#34;: &#34;Default&#34; } ], &#34;Plugins&#34;:[ { &#34;Name&#34;: &#34;OnlineSubsystem&#34;, &#34;Enabled&#34;: true }, { &#34;Name&#34;: &#34;OnlineSubsystemSteam&#34;, &#34;Enabled&#34;: true } ] } MultiplayerSessions.Build.cs">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-19T18:02:04+08:00">
    <meta property="article:modified_time" content="2025-05-19T18:02:04+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="UnrealOnline">
<meta name="twitter:description" content="简介
相关课程：
https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/
这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。
效果如下：

在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。
配置文件设置
在DefaultEngine.ini中，添加以下内容：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13


[/Script/Engine.GameEngine]
&#43;NetDriverDefinitions=(DefName=&#34;GameNetDriver&#34;,DriverClassName=&#34;OnlineSubsystemSteam.SteamNetDriver&#34;,DriverClassNameFallback=&#34;OnlineSubsystemUtils.IpNetDriver&#34;)

[OnlineSubsystem]
DefaultPlatformService=Steam

[OnlineSubsystemSteam]
bEnabled=true
SteamDevAppId=480
bInitServerOnClient=true

[/Script/OnlineSubsystemSteam.SteamNetDriver]
NetConnectionClassName=&#34;OnlineSubsystemSteam.SteamNetConnection&#34;


480是一个公用的游戏id
在DefaultEngine.ini中添加


1
2


[/Script/Engine.GameSession]
MaxPlayers=100


规定了最大玩家数量。
插件创建
在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：

例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。
在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20


{
    ...
	&#34;Modules&#34;: [
		{
			&#34;Name&#34;: &#34;MultiplayerSessions&#34;,
			&#34;Type&#34;: &#34;Runtime&#34;,
			&#34;LoadingPhase&#34;: &#34;Default&#34;
		}
	],
	&#34;Plugins&#34;:[
		{
			&#34;Name&#34;: &#34;OnlineSubsystem&#34;,
			&#34;Enabled&#34;: true
		},
		{
			&#34;Name&#34;: &#34;OnlineSubsystemSteam&#34;,
			&#34;Enabled&#34;: true
		}
	]
}


MultiplayerSessions.Build.cs">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://wstfdxfh.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "UnrealEngine",
      "item": "https://wstfdxfh.github.io/posts/unrealengine/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "UnrealOnline",
      "item": "https://wstfdxfh.github.io/posts/unrealengine/unrealonline/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "UnrealOnline",
  "name": "UnrealOnline",
  "description": "简介 相关课程：\nhttps://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/\n这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。\n效果如下：\n在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。\n配置文件设置 在DefaultEngine.ini中，添加以下内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 [/Script/Engine.GameEngine] +NetDriverDefinitions=(DefName=\u0026#34;GameNetDriver\u0026#34;,DriverClassName=\u0026#34;OnlineSubsystemSteam.SteamNetDriver\u0026#34;,DriverClassNameFallback=\u0026#34;OnlineSubsystemUtils.IpNetDriver\u0026#34;) [OnlineSubsystem] DefaultPlatformService=Steam [OnlineSubsystemSteam] bEnabled=true SteamDevAppId=480 bInitServerOnClient=true [/Script/OnlineSubsystemSteam.SteamNetDriver] NetConnectionClassName=\u0026#34;OnlineSubsystemSteam.SteamNetConnection\u0026#34; 480是一个公用的游戏id\n在DefaultEngine.ini中添加\n1 2 [/Script/Engine.GameSession] MaxPlayers=100 规定了最大玩家数量。\n插件创建 在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：\n例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。\n在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { ... \u0026#34;Modules\u0026#34;: [ { \u0026#34;Name\u0026#34;: \u0026#34;MultiplayerSessions\u0026#34;, \u0026#34;Type\u0026#34;: \u0026#34;Runtime\u0026#34;, \u0026#34;LoadingPhase\u0026#34;: \u0026#34;Default\u0026#34; } ], \u0026#34;Plugins\u0026#34;:[ { \u0026#34;Name\u0026#34;: \u0026#34;OnlineSubsystem\u0026#34;, \u0026#34;Enabled\u0026#34;: true }, { \u0026#34;Name\u0026#34;: \u0026#34;OnlineSubsystemSteam\u0026#34;, \u0026#34;Enabled\u0026#34;: true } ] } MultiplayerSessions.Build.cs\n",
  "keywords": [
    
  ],
  "articleBody": "简介 相关课程：\nhttps://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/\n这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。\n效果如下：\n在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。\n配置文件设置 在DefaultEngine.ini中，添加以下内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 [/Script/Engine.GameEngine] +NetDriverDefinitions=(DefName=\"GameNetDriver\",DriverClassName=\"OnlineSubsystemSteam.SteamNetDriver\",DriverClassNameFallback=\"OnlineSubsystemUtils.IpNetDriver\") [OnlineSubsystem] DefaultPlatformService=Steam [OnlineSubsystemSteam] bEnabled=true SteamDevAppId=480 bInitServerOnClient=true [/Script/OnlineSubsystemSteam.SteamNetDriver] NetConnectionClassName=\"OnlineSubsystemSteam.SteamNetConnection\" 480是一个公用的游戏id\n在DefaultEngine.ini中添加\n1 2 [/Script/Engine.GameSession] MaxPlayers=100 规定了最大玩家数量。\n插件创建 在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：\n例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。\n在创建插件时，选择Blank模板，创建后在MultiplayerSessions.uplugin中添加依赖：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { ... \"Modules\": [ { \"Name\": \"MultiplayerSessions\", \"Type\": \"Runtime\", \"LoadingPhase\": \"Default\" } ], \"Plugins\":[ { \"Name\": \"OnlineSubsystem\", \"Enabled\": true }, { \"Name\": \"OnlineSubsystemSteam\", \"Enabled\": true } ] } MultiplayerSessions.Build.cs\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 using UnrealBuildTool; public class MultiplayerSessions : ModuleRules { public MultiplayerSessions(ReadOnlyTargetRules Target) : base(Target) { PCHUsage = ModuleRules.PCHUsageMode.UseExplicitOrSharedPCHs; PublicIncludePaths.AddRange( new string[] {} ); PrivateIncludePaths.AddRange( new string[] {} ); PublicDependencyModuleNames.AddRange( new string[]{ \"Core\", \"OnlineSubsystem\", \"OnlineSubsystemSteam\", \"UMG\", \"Slate\", \"SlateCore\" } ); PrivateDependencyModuleNames.AddRange( new string[]{ \"CoreUObject\", \"Engine\", \"Slate\", \"SlateCore\", } ); DynamicallyLoadedModuleNames.AddRange(new string[]{}); } } 目录类代码 创建一个menuC++类，并在此基础上创建一个蓝图\n对应蓝图实现如下：\n初始关卡蓝图如下：\nMenu.h代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 #pragma once #include \"CoreMinimal.h\" #include \"Blueprint/UserWidget.h\" #include \"Interfaces/OnlineSessionInterface.h\" #include \"Menu.generated.h\" UCLASS() class MULTIPLAYERSESSIONS_API UMenu : public UUserWidget { GENERATED_BODY() public: UFUNCTION(BlueprintCallable) void MenuSetup( int32 NumberOfPublicConnections = 4, FString TypeOfMatch = FString(TEXT(\"FreeForAll\")), FString LobbyPath = FString(TEXT(\"/Game/ThirdPerson/Maps/Lobby\"))); protected: virtual bool Initialize() override; // 当退出关卡加入大厅时调用 virtual void NativeDestruct() override; // 回调函数，绑定在FMultiplayerOnCreateSessionComplete上 UFUNCTION() void OnCreateSession(bool bWasSuccessful); void OnFindSessions(const TArray\u003cFOnlineSessionSearchResult\u003e\u0026 SessionResults, bool bWasSuccessful); void OnJoinSession(EOnJoinSessionCompleteResult::Type Result); UFUNCTION() void OnDestroySession(bool bWasSuccessful); UFUNCTION() void OnStartSession(bool bWasSuccessful); private: // 必须和Editor中名称完全一致 UPROPERTY(meta=(BindWidget)) class UButton* HostButton; UPROPERTY(meta=(BindWidget)) UButton* JoinButton; UFUNCTION() void HostButtonClicked(); UFUNCTION() void JoinButtonClicked(); void MenuTearDown(); class UMultiplayerSessionsSubsystem* MultiplayerSessionsSubsystem; int32 NumPublicConnections{4}; FString MatchType{TEXT(\"FreeForAll\")}; FString PathToLobby{TEXT(\"\")}; }; 按钮绑定 对于蓝图中名称和头文件中完全一致的UI控件，可以使用UPROPERTY(meta=(BindWidget))进行自动绑定，这样当蓝图中的按钮被点击时，cpp中的同名称按钮也会被触发，由于UMenu::Initialize函数添加了HostButton-\u003eOnClicked.AddDynamic(this, \u0026ThisClass::HostButtonClicked);绑定，因此会触发相应的回调函数。\n回调函数声明注意 这里回调函数中，有部分包含了UFUNCTION声明，有的没有，其中包含了的使用的是动态回调，而没有的则使用普通回调，不能被蓝图使用，这种差别的原因是TArray\u003c\u003e或者EOnJoinSessionCompleteResult::Type的类型不被UE的反射系统支持，而bool则原生支持，所以调用的时候可以使用动态代理的回调。要令上述类型支持动态回调，方法之一是将这些类型作为一个声明了UCLASS,USTRUCT的成员，并且使用UPROPERTY标记，这样可以将类作为参数间接访问相关类型。\nMenu.cpp代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 #include \"Menu.h\" #include \"Components/Button.h\" #include \"MultiplayerSessionsSubsystem.h\" #include \"OnlineSessionSettings.h\" #include \"OnlineSubsystemUtils.h\" void UMenu::MenuSetup(int32 NumberOfPublicConnections, FString TypeOfMatch, FString LobbyPath) { PathToLobby = FString::Printf(TEXT(\"%s?listen\"), *LobbyPath); NumPublicConnections = NumberOfPublicConnections; MatchType = TypeOfMatch; AddToViewport(); SetVisibility(ESlateVisibility::Visible); SetIsFocusable(true); UWorld* World = GetWorld(); if(World) { APlayerController* PlayerController = World-\u003eGetFirstPlayerController(); if(PlayerController) { FInputModeUIOnly InputModeData; InputModeData.SetWidgetToFocus(TakeWidget()); InputModeData.SetLockMouseToViewportBehavior(EMouseLockMode::DoNotLock); PlayerController-\u003eSetInputMode(InputModeData); PlayerController-\u003eSetShowMouseCursor(true); } } UGameInstance* GameInstance = GetGameInstance(); if(GameInstance) { MultiplayerSessionsSubsystem = GameInstance-\u003eGetSubsystem\u003cUMultiplayerSessionsSubsystem\u003e(); } if(MultiplayerSessionsSubsystem) { MultiplayerSessionsSubsystem-\u003eMultiplayerOnCreateSessionComplete.AddDynamic(this, \u0026ThisClass::OnCreateSession); MultiplayerSessionsSubsystem-\u003eMultiplayerOnFindSessionsComplete.AddUObject(this, \u0026ThisClass::OnFindSessions); MultiplayerSessionsSubsystem-\u003eMultiplayerOnJoinSessionComplete.AddUObject(this, \u0026ThisClass::OnJoinSession); MultiplayerSessionsSubsystem-\u003eMultiplayerOnDestroySessionComplete.AddDynamic(this, \u0026ThisClass::OnDestroySession); MultiplayerSessionsSubsystem-\u003eMultiplayerOnStartSessionComplete.AddDynamic(this, \u0026ThisClass::OnStartSession); } } bool UMenu::Initialize() { // AddToViewport不放在该函数的原因是此时尚未完成全部初始化 if(!Super::Initialize()){ return false; } if(HostButton){ HostButton-\u003eOnClicked.AddDynamic(this, \u0026ThisClass::HostButtonClicked); } if(JoinButton) { JoinButton-\u003eOnClicked.AddDynamic(this, \u0026ThisClass::JoinButtonClicked); } return true; } void UMenu::NativeDestruct() { MenuTearDown(); Super::NativeDestruct(); } void UMenu::OnCreateSession(bool bWasSuccessful) { if(bWasSuccessful) { UWorld* World = GetWorld(); if(World) { World-\u003eServerTravel(PathToLobby); } } else { HostButton-\u003eSetIsEnabled(true); } } void UMenu::OnFindSessions(const TArray\u003cFOnlineSessionSearchResult\u003e\u0026 SessionResults, bool bWasSuccessful) { if(!MultiplayerSessionsSubsystem) { return; } for(auto\u0026 Result : SessionResults) { FString SettingsValue; Result.Session.SessionSettings.Get(FName(\"MatchType\"), SettingsValue); if(SettingsValue == MatchType) { MultiplayerSessionsSubsystem-\u003eJoinSession(Result); return; } } if(!bWasSuccessful || SessionResults.Num()==0) { JoinButton-\u003eSetIsEnabled(true); } } void UMenu::OnJoinSession(EOnJoinSessionCompleteResult::Type Result) { IOnlineSubsystem* Subsystem = Online::GetSubsystem(GetWorld()); if(Subsystem) { IOnlineSessionPtr SessionInterface = Subsystem-\u003eGetSessionInterface(); if(SessionInterface.IsValid()) { FString Address; SessionInterface-\u003eGetResolvedConnectString(NAME_GameSession, Address); APlayerController* PlayerController = GetGameInstance()-\u003eGetFirstLocalPlayerController(); if(PlayerController) { PlayerController-\u003eClientTravel(Address, TRAVEL_Absolute); } } } if(Result!=EOnJoinSessionCompleteResult::Success) { JoinButton-\u003eSetIsEnabled(true); } } void UMenu::HostButtonClicked() { HostButton-\u003eSetIsEnabled(false); if(MultiplayerSessionsSubsystem) { MultiplayerSessionsSubsystem-\u003eCreateSession(NumPublicConnections, MatchType); } } void UMenu::JoinButtonClicked() { JoinButton-\u003eSetIsEnabled(false); if(MultiplayerSessionsSubsystem) { MultiplayerSessionsSubsystem-\u003eFindSessions(10000); } } void UMenu::MenuTearDown() { RemoveFromParent(); if(UWorld* World = GetWorld()) { if(APlayerController* PlayerController = World-\u003eGetFirstPlayerController()) { FInputModeGameOnly InputModeData; PlayerController-\u003eSetInputMode(InputModeData); PlayerController-\u003eSetShowMouseCursor(false); } } } 该代码的注意点如下：\nInitialize函数在创建UI时进行调用，只进行按钮的代理绑定操作，其他初始操作（比如AddToViewport）放到自定义函数； MenuSetup中，调整了一些UI设置，并且获取了UMultiplayerSessionsSubsystem，并且获取其中的代理进行了回调函数的绑定，注意动态回调和非动态的函数区别。 在相关按钮被按下后，按钮被设置为不可用，直到回调中返回结果后才可以再次点击，这是为了防止多次调用内容。 UMenu::NativeDestruct函数被调用时，表示用户被移动到其他地图，本地图被移除。 OnlineSubSystem代码 MultiplayerSessionsSubsystem.h继承UGameInstanceSubsystem，特点为：\n是一个单例类 和GameInstance拥有相同的生命周期，游戏开始时创建，结束时销毁 通过继承UGameInstanceSubsystem，而非UGameInstance，可以使具体功能实现解耦 实现如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 #pragma once #include \"CoreMinimal.h\" #include \"Subsystems/GameInstanceSubsystem.h\" #include \"Interfaces/OnlineSessionInterface.h\" #include \"MultiplayerSessionsSubsystem.generated.h\" // // Delcaring our own custom delegates for the Menu class to bind callbacks to // DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnCreateSessionComplete, bool, bWasSuccessful); DECLARE_MULTICAST_DELEGATE_TwoParams(FMultiplayerOnFindSessionsComplete, const TArray\u003cFOnlineSessionSearchResult\u003e\u0026 SessionResults, bool bWasSuccessful); DECLARE_MULTICAST_DELEGATE_OneParam(FMultiplayerOnJoinSessionComplete, EOnJoinSessionCompleteResult::Type Result); DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnDestroySessionComplete, bool, bWasSuccessful); DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FMultiplayerOnStartSessionComplete, bool, bWasSuccessful); UCLASS() class MULTIPLAYERSESSIONS_API UMultiplayerSessionsSubsystem : public UGameInstanceSubsystem { GENERATED_BODY() public: UMultiplayerSessionsSubsystem(); // // To handle session functionality. The Menu class will call these // void CreateSession(int32 NumPublicConnections, FString MatchType); void FindSessions(int32 MaxSearchResults); void JoinSession(const FOnlineSessionSearchResult\u0026 SessionResult); void DestroySession(); void StartSession(); // // Our own custom delegates for the Menu class to bind callbacks to // FMultiplayerOnCreateSessionComplete MultiplayerOnCreateSessionComplete; FMultiplayerOnFindSessionsComplete MultiplayerOnFindSessionsComplete; FMultiplayerOnJoinSessionComplete MultiplayerOnJoinSessionComplete; FMultiplayerOnDestroySessionComplete MultiplayerOnDestroySessionComplete; FMultiplayerOnStartSessionComplete MultiplayerOnStartSessionComplete; protected: // // Internal callbacks for the delegates we'll add to the Online Session Interface delegate list. // These don't need to be called outside this class. // void OnCreateSessionComplete(FName SessionName, bool bWasSuccessful); void OnFindSessionsComplete(bool bWasSuccessful); void OnJoinSessionComplete(FName SessionName, EOnJoinSessionCompleteResult::Type Result); void OnDestroySessionComplete(FName SessionName, bool bWasSuccessful); void OnStartSessionComplete(FName SessionName, bool bWasSuccessful); private: IOnlineSessionPtr SessionInterface; TSharedPtr\u003cFOnlineSessionSettings\u003e LastSessionSettings; TSharedPtr\u003cFOnlineSessionSearch\u003e LastSessionSearch; // // To add to the Online Session Interface delegate list. // We'll bind our MultiplayerSessionsSubsystem internal callbacks to these. // FOnCreateSessionCompleteDelegate CreateSessionCompleteDelegate; FDelegateHandle CreateSessionCompleteDelegateHandle; FOnFindSessionsCompleteDelegate FindSessionsCompleteDelegate; FDelegateHandle FindSessionsCompleteDelegateHandle; FOnJoinSessionCompleteDelegate JoinSessionCompleteDelegate; FDelegateHandle JoinSessionCompleteDelegateHandle; FOnDestroySessionCompleteDelegate DestroySessionCompleteDelegate; FDelegateHandle DestroySessionCompleteDelegateHandle; FOnStartSessionCompleteDelegate StartSessionCompleteDelegate; FDelegateHandle StartSessionCompleteDelegateHandle; bool bCreateSessionOnDestroy{false}; int32 LastNumPublicConnections; FString LastMatchType; }; 注意点如下：\n代码开始通过宏定义了若干个自定义的代理，这些代理有些是动态多播代理，有些是普通多播代理，原因在于参数的限制。声明代理后需要在类内部进行实例的声明； 在这里声明若干自定义代理的目的是为了让menu的函数可以在各种session任务完成后执行相应的回调函数，同时本类不需要知道具体的实现，实现类之间的解耦； 这里将CreateSession等函数声明为public函数，方便menu直接调用 private部分声明了多种代理，用于绑定当相关Session操作完成后会进行回调的函数，和上面的自定义回调进行对比，前面的用于令其他类绑定对应的回调函数，通知者为当前类；当前的代理用来给Session Interface进行绑定，通知者为Interface； 将代理绑定到Session Interface后，返回对应的Handle，这个Handle可以后续将代理进行解绑。 MultiplayerSessionsSubsystem.cpp实现如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 #include \"MultiplayerSessionsSubsystem.h\" #include \"OnlineSubsystem.h\" #include \"OnlineSessionSettings.h\" #include \"OnlineSubsystemUtils.h\" #include \"Online/OnlineSessionNames.h\" UMultiplayerSessionsSubsystem::UMultiplayerSessionsSubsystem(): CreateSessionCompleteDelegate(FOnCreateSessionCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnCreateSessionComplete)), FindSessionsCompleteDelegate(FOnFindSessionsCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnFindSessionsComplete)), JoinSessionCompleteDelegate(FOnJoinSessionCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnJoinSessionComplete)), DestroySessionCompleteDelegate(FOnDestroySessionCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnDestroySessionComplete)), StartSessionCompleteDelegate(FOnStartSessionCompleteDelegate::CreateUObject(this, \u0026ThisClass::OnStartSessionComplete)) { IOnlineSubsystem* Subsystem = Online::GetSubsystem(UObject::GetWorld()); if(Subsystem) { SessionInterface = Subsystem-\u003eGetSessionInterface(); } } void UMultiplayerSessionsSubsystem::CreateSession(int32 NumPublicConnections, FString MatchType) { if(!SessionInterface.IsValid()) { return; } auto ExistingSession = SessionInterface-\u003eGetNamedSession(NAME_GameSession); if(ExistingSession != nullptr) { bCreateSessionOnDestroy = true; LastNumPublicConnections = NumPublicConnections; LastMatchType = MatchType; DestroySession(); } // Store the delegate in a FDelegateHandle so we can later remove it from the delegate list CreateSessionCompleteDelegateHandle = SessionInterface-\u003eAddOnCreateSessionCompleteDelegate_Handle(CreateSessionCompleteDelegate); LastSessionSettings = MakeShareable(new FOnlineSessionSettings()); LastSessionSettings-\u003ebIsLANMatch = Online::GetSubsystem(GetWorld())-\u003eGetSubsystemName() == \"NULL\" ? true : false; LastSessionSettings-\u003eNumPublicConnections = NumPublicConnections; LastSessionSettings-\u003ebAllowJoinInProgress = true; LastSessionSettings-\u003ebAllowJoinViaPresence = true; LastSessionSettings-\u003ebShouldAdvertise = true; LastSessionSettings-\u003ebUsesPresence = true; LastSessionSettings-\u003ebUseLobbiesIfAvailable = true; LastSessionSettings-\u003eSet(FName(\"MatchType\"), MatchType, EOnlineDataAdvertisementType::ViaOnlineServiceAndPing); LastSessionSettings-\u003eBuildUniqueId = 1; const ULocalPlayer* LocalPlayer = GetWorld()-\u003eGetFirstLocalPlayerFromController(); if(!SessionInterface-\u003eCreateSession(*LocalPlayer-\u003eGetPreferredUniqueNetId(), NAME_GameSession, *LastSessionSettings)) { SessionInterface-\u003eClearOnCreateSessionCompleteDelegate_Handle(CreateSessionCompleteDelegateHandle); // Broadcast our own custom delegate MultiplayerOnCreateSessionComplete.Broadcast(false); } } void UMultiplayerSessionsSubsystem::FindSessions(int32 MaxSearchResults) { if(!SessionInterface.IsValid()) { return; } FindSessionsCompleteDelegateHandle = SessionInterface-\u003eAddOnFindSessionsCompleteDelegate_Handle(FindSessionsCompleteDelegate); LastSessionSearch = MakeShareable(new FOnlineSessionSearch()); LastSessionSearch-\u003eMaxSearchResults = MaxSearchResults; LastSessionSearch-\u003ebIsLanQuery = Online::GetSubsystem(GetWorld())-\u003eGetSubsystemName() == \"NULL\" ? true : false; LastSessionSearch-\u003eQuerySettings.Set(SEARCH_PRESENCE, true, EOnlineComparisonOp::Equals); const ULocalPlayer* LocalPlayer = GetWorld()-\u003eGetFirstLocalPlayerFromController(); if(!SessionInterface-\u003eFindSessions(*LocalPlayer-\u003eGetPreferredUniqueNetId(), LastSessionSearch.ToSharedRef())) { SessionInterface-\u003eClearOnFindSessionsCompleteDelegate_Handle(FindSessionsCompleteDelegateHandle); MultiplayerOnFindSessionsComplete.Broadcast(TArray\u003cFOnlineSessionSearchResult\u003e(), false); } } void UMultiplayerSessionsSubsystem::JoinSession(const FOnlineSessionSearchResult\u0026 SessionResult) { // 相较原版本修改的地方 FOnlineSessionSearchResult Result = SessionResult; if(!SessionInterface || !SessionInterface.IsValid()) { MultiplayerOnJoinSessionComplete.Broadcast(EOnJoinSessionCompleteResult::UnknownError); return; } JoinSessionCompleteDelegateHandle = SessionInterface-\u003eAddOnJoinSessionCompleteDelegate_Handle(JoinSessionCompleteDelegate); Result.Session.SessionSettings.bUseLobbiesIfAvailable = true; Result.Session.SessionSettings.bUsesPresence = true; const ULocalPlayer* LocalPlayer = GetWorld()-\u003eGetFirstLocalPlayerFromController(); if(!SessionInterface-\u003eJoinSession(*LocalPlayer-\u003eGetPreferredUniqueNetId(), NAME_GameSession, Result)) { SessionInterface-\u003eClearOnJoinSessionCompleteDelegate_Handle(JoinSessionCompleteDelegateHandle); MultiplayerOnJoinSessionComplete.Broadcast(EOnJoinSessionCompleteResult::UnknownError); } } void UMultiplayerSessionsSubsystem::DestroySession() { if(!SessionInterface.IsValid()) { MultiplayerOnDestroySessionComplete.Broadcast(false); return; } DestroySessionCompleteDelegateHandle = SessionInterface-\u003eAddOnDestroySessionCompleteDelegate_Handle(DestroySessionCompleteDelegate); if(!SessionInterface-\u003eDestroySession(NAME_GameSession)) { SessionInterface-\u003eClearOnDestroySessionCompleteDelegate_Handle(DestroySessionCompleteDelegateHandle); MultiplayerOnDestroySessionComplete.Broadcast(false); } } void UMultiplayerSessionsSubsystem::OnCreateSessionComplete(FName SessionName, bool bWasSuccessful) { if(SessionInterface) { SessionInterface-\u003eClearOnCreateSessionCompleteDelegate_Handle(CreateSessionCompleteDelegateHandle); } MultiplayerOnCreateSessionComplete.Broadcast(bWasSuccessful); } void UMultiplayerSessionsSubsystem::OnFindSessionsComplete(bool bWasSuccessful) { if(SessionInterface) { SessionInterface-\u003eClearOnFindSessionsCompleteDelegate_Handle(FindSessionsCompleteDelegateHandle); } if(LastSessionSearch-\u003eSearchResults.Num() \u003c= 0) { MultiplayerOnFindSessionsComplete.Broadcast(TArray\u003cFOnlineSessionSearchResult\u003e(), false); return; } MultiplayerOnFindSessionsComplete.Broadcast(LastSessionSearch-\u003eSearchResults, bWasSuccessful); } void UMultiplayerSessionsSubsystem::OnJoinSessionComplete(FName SessionName, EOnJoinSessionCompleteResult::Type Result) { if(SessionInterface) { SessionInterface-\u003eClearOnJoinSessionCompleteDelegate_Handle(JoinSessionCompleteDelegateHandle); } MultiplayerOnJoinSessionComplete.Broadcast(Result); } void UMultiplayerSessionsSubsystem::OnDestroySessionComplete(FName SessionName, bool bWasSuccessful) { if(SessionInterface) { SessionInterface-\u003eClearOnDestroySessionCompleteDelegate_Handle(DestroySessionCompleteDelegateHandle); } if(bWasSuccessful \u0026\u0026 bCreateSessionOnDestroy) { bCreateSessionOnDestroy = false; CreateSession(LastNumPublicConnections, LastMatchType); } MultiplayerOnDestroySessionComplete.Broadcast(bWasSuccessful); } 首先，这里和官方实现的主要差别在：UMultiplayerSessionsSubsystem::JoinSession部分，在其中，使用了拷贝的FOnlineSessionSearchResult类型，并且重新进行了一些设定，进行设定后，在测试的版本中可以顺利加入游戏，否则不能。\n接下来对代码内容进行说明：\n在构造函数中，对各种Delegate进行了初始化，注意到这里的回调函数都是非动态的； CreateSession的实现中，如果当前还有未删除的session，就保存当前的参数，执行DestroySession，并在实现后的回调函数中进行判断并再次创建Session，如果直接在CreateSession中删除并创建，会导致Destroy还未成功就进行创建，导致创建失败。 NAME_GameSession是一个宏，在这里作为session的固定名字； 在Session操作开始时，将代理进行绑定，而当操作成功的回调或者操作失败时，就通过Handle清除对应的代理，防止重复触发； 对于自定义代理，需要在操作成功或者失败时进行广播（Broadcast）操作； ",
  "wordCount" : "1516",
  "inLanguage": "en",
  "datePublished": "2025-05-19T18:02:04+08:00",
  "dateModified": "2025-05-19T18:02:04+08:00",
  "author":{
    "@type": "Person",
    "name": "李睿杰"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://wstfdxfh.github.io/posts/unrealengine/unrealonline/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "李睿杰的博客",
    "logo": {
      "@type": "ImageObject",
      "url": "https://wstfdxfh.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://wstfdxfh.github.io/" accesskey="h" title="李睿杰的博客 (Alt + H)">李睿杰的博客</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://wstfdxfh.github.io/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://wstfdxfh.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://wstfdxfh.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://wstfdxfh.github.io/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://wstfdxfh.github.io/posts/unrealengine/">UnrealEngine</a></div>
    <h1 class="post-title entry-hint-parent">
      UnrealOnline
    </h1>
    <div class="post-meta"><span title='2025-05-19 18:02:04 +0800 CST'>May 19, 2025</span>&nbsp;·&nbsp;李睿杰

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ae%80%e4%bb%8b" aria-label="简介">简介</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%ae%be%e7%bd%ae" aria-label="配置文件设置">配置文件设置</a></li>
                <li>
                    <a href="#%e6%8f%92%e4%bb%b6%e5%88%9b%e5%bb%ba" aria-label="插件创建">插件创建</a></li>
                <li>
                    <a href="#%e7%9b%ae%e5%bd%95%e7%b1%bb%e4%bb%a3%e7%a0%81" aria-label="目录类代码">目录类代码</a><ul>
                        
                <li>
                    <a href="#%e6%8c%89%e9%92%ae%e7%bb%91%e5%ae%9a" aria-label="按钮绑定">按钮绑定</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0%e5%a3%b0%e6%98%8e%e6%b3%a8%e6%84%8f" aria-label="回调函数声明注意">回调函数声明注意</a></li>
                <li>
                    <a href="#onlinesubsystem%e4%bb%a3%e7%a0%81" aria-label="OnlineSubSystem代码">OnlineSubSystem代码</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="简介">简介<a hidden class="anchor" aria-hidden="true" href="#简介">#</a></h2>
<p>相关课程：</p>
<p><a href="https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/">https://www.udemy.com/course/unreal-engine-5-cpp-multiplayer-shooter/</a></p>
<p>这篇笔记简单介绍如何在UE5.5中建立一个在线链接，包含OnlineSubsystem的使用方法，自定义代理的建立等内容。</p>
<p>效果如下：</p>
<!-- raw HTML omitted -->
<p>在steam登录的情况下，在2台不同的主机上可以建立链接，在一个大厅中进行游玩（注意需要不同的账号，以及相同的地域）。</p>
<h2 id="配置文件设置">配置文件设置<a hidden class="anchor" aria-hidden="true" href="#配置文件设置">#</a></h2>
<p>在<code>DefaultEngine.ini</code>中，添加以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[/Script/Engine.GameEngine]</span>
</span></span><span class="line"><span class="cl"><span class="na">+NetDriverDefinitions</span><span class="o">=</span><span class="s">(DefName=&#34;GameNetDriver&#34;,DriverClassName=&#34;OnlineSubsystemSteam.SteamNetDriver&#34;,DriverClassNameFallback=&#34;OnlineSubsystemUtils.IpNetDriver&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[OnlineSubsystem]</span>
</span></span><span class="line"><span class="cl"><span class="na">DefaultPlatformService</span><span class="o">=</span><span class="s">Steam</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[OnlineSubsystemSteam]</span>
</span></span><span class="line"><span class="cl"><span class="na">bEnabled</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl"><span class="na">SteamDevAppId</span><span class="o">=</span><span class="s">480</span>
</span></span><span class="line"><span class="cl"><span class="na">bInitServerOnClient</span><span class="o">=</span><span class="s">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[/Script/OnlineSubsystemSteam.SteamNetDriver]</span>
</span></span><span class="line"><span class="cl"><span class="na">NetConnectionClassName</span><span class="o">=</span><span class="s">&#34;OnlineSubsystemSteam.SteamNetConnection&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>480是一个公用的游戏id</p>
<p>在<code>DefaultEngine.ini</code>中添加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[/Script/Engine.GameSession]</span>
</span></span><span class="line"><span class="cl"><span class="na">MaxPlayers</span><span class="o">=</span><span class="s">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>规定了最大玩家数量。</p>
<h2 id="插件创建">插件创建<a hidden class="anchor" aria-hidden="true" href="#插件创建">#</a></h2>
<p>在编辑器的插件设置中可以创建相应的插件，并且在游戏中利用这些插件，以实现代码或者蓝图的复用。插件和游戏存在以下的单项依赖关系：</p>
<p><img alt="image-20250519182751415" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250519182751415.png"></p>
<p>例如，游戏模块可以依赖于游戏插件或者其他模块，但是插件不可依赖于游戏模块。</p>
<p>在创建插件时，选择<code>Blank</code>模板，创建后在<code>MultiplayerSessions.uplugin</code>中添加依赖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">...</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Modules&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;MultiplayerSessions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;Runtime&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;LoadingPhase&#34;</span><span class="p">:</span> <span class="s2">&#34;Default&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">],</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;Plugins&#34;</span><span class="p">:[</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;OnlineSubsystem&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Enabled&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;OnlineSubsystemSteam&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;Enabled&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>MultiplayerSessions.Build.cs</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">UnrealBuildTool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">MultiplayerSessions</span> <span class="p">:</span> <span class="n">ModuleRules</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">MultiplayerSessions</span><span class="p">(</span><span class="n">ReadOnlyTargetRules</span> <span class="n">Target</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">PCHUsage</span> <span class="p">=</span> <span class="n">ModuleRules</span><span class="p">.</span><span class="n">PCHUsageMode</span><span class="p">.</span><span class="n">UseExplicitOrSharedPCHs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">PublicIncludePaths</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">PrivateIncludePaths</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="k">new</span> <span class="kt">string</span><span class="p">[]</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">PublicDependencyModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]{</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Core&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;OnlineSubsystem&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;OnlineSubsystemSteam&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;UMG&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Slate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;SlateCore&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">PrivateDependencyModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span> <span class="k">new</span> <span class="kt">string</span><span class="p">[]{</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;CoreUObject&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Engine&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;Slate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;SlateCore&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">DynamicallyLoadedModuleNames</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="k">new</span> <span class="kt">string</span><span class="p">[]{});</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="目录类代码">目录类代码<a hidden class="anchor" aria-hidden="true" href="#目录类代码">#</a></h2>
<p>创建一个menuC++类，并在此基础上创建一个蓝图</p>
<p>对应蓝图实现如下：</p>
<!-- raw HTML omitted -->
<p>初始关卡蓝图如下：</p>
<!-- raw HTML omitted -->
<p><code>Menu.h</code>代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CoreMinimal.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Blueprint/UserWidget.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Interfaces/OnlineSessionInterface.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Menu.generated.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">UCLASS</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MULTIPLAYERSESSIONS_API</span> <span class="nl">UMenu</span> <span class="p">:</span> <span class="k">public</span> <span class="n">UUserWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">(</span><span class="n">BlueprintCallable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">MenuSetup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">       <span class="n">int32</span> <span class="n">NumberOfPublicConnections</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">FString</span> <span class="n">TypeOfMatch</span> <span class="o">=</span> <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;FreeForAll&#34;</span><span class="p">)),</span> <span class="n">FString</span> <span class="n">LobbyPath</span> <span class="o">=</span> <span class="n">FString</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;/Game/ThirdPerson/Maps/Lobby&#34;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Initialize</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当退出关卡加入大厅时调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">NativeDestruct</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 回调函数，绑定在FMultiplayerOnCreateSessionComplete上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">OnFindSessions</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;&amp;</span> <span class="n">SessionResults</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">OnJoinSession</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">OnDestroySession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">OnStartSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 必须和Editor中名称完全一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">BindWidget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">UButton</span><span class="o">*</span> <span class="n">HostButton</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UPROPERTY</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="n">BindWidget</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">UButton</span><span class="o">*</span> <span class="n">JoinButton</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">HostButtonClicked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">UFUNCTION</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">JoinButtonClicked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">MenuTearDown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">UMultiplayerSessionsSubsystem</span><span class="o">*</span> <span class="n">MultiplayerSessionsSubsystem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">int32</span>   <span class="n">NumPublicConnections</span><span class="p">{</span><span class="mi">4</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">FString</span> <span class="n">MatchType</span><span class="p">{</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;FreeForAll&#34;</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl">    <span class="n">FString</span> <span class="n">PathToLobby</span><span class="p">{</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="按钮绑定">按钮绑定<a hidden class="anchor" aria-hidden="true" href="#按钮绑定">#</a></h3>
<p>对于蓝图中名称和头文件中完全一致的UI控件，可以使用<code>UPROPERTY(meta=(BindWidget))</code>进行自动绑定，这样当蓝图中的按钮被点击时，cpp中的同名称按钮也会被触发，由于<code>UMenu::Initialize</code>函数添加了<code>HostButton-&gt;OnClicked.AddDynamic(this, &amp;ThisClass::HostButtonClicked);</code>绑定，因此会触发相应的回调函数。</p>
<h2 id="回调函数声明注意">回调函数声明注意<a hidden class="anchor" aria-hidden="true" href="#回调函数声明注意">#</a></h2>
<p>这里回调函数中，有部分包含了<code>UFUNCTION</code>声明，有的没有，其中包含了的使用的是动态回调，而没有的则使用普通回调，不能被蓝图使用，这种差别的原因是<code>TArray&lt;&gt;</code>或者<code>EOnJoinSessionCompleteResult::Type</code>的类型不被UE的反射系统支持，而bool则原生支持，所以调用的时候可以使用动态代理的回调。要令上述类型支持动态回调，方法之一是将这些类型作为一个声明了<code>UCLASS</code>,<code>USTRUCT</code>的成员，并且使用<code>UPROPERTY</code>标记，这样可以将类作为参数间接访问相关类型。</p>
<p><code>Menu.cpp</code>代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Menu.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Components/Button.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;MultiplayerSessionsSubsystem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSessionSettings.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSubsystemUtils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">MenuSetup</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumberOfPublicConnections</span><span class="p">,</span> <span class="n">FString</span> <span class="n">TypeOfMatch</span><span class="p">,</span> <span class="n">FString</span> <span class="n">LobbyPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">PathToLobby</span> <span class="o">=</span> <span class="n">FString</span><span class="o">::</span><span class="n">Printf</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;%s?listen&#34;</span><span class="p">),</span> <span class="o">*</span><span class="n">LobbyPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">NumPublicConnections</span> <span class="o">=</span> <span class="n">NumberOfPublicConnections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">MatchType</span> <span class="o">=</span> <span class="n">TypeOfMatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">AddToViewport</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetVisibility</span><span class="p">(</span><span class="n">ESlateVisibility</span><span class="o">::</span><span class="n">Visible</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">SetIsFocusable</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">World</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">World</span><span class="o">-&gt;</span><span class="n">GetFirstPlayerController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FInputModeUIOnly</span> <span class="n">InputModeData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">InputModeData</span><span class="p">.</span><span class="n">SetWidgetToFocus</span><span class="p">(</span><span class="n">TakeWidget</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">			<span class="n">InputModeData</span><span class="p">.</span><span class="n">SetLockMouseToViewportBehavior</span><span class="p">(</span><span class="n">EMouseLockMode</span><span class="o">::</span><span class="n">DoNotLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetInputMode</span><span class="p">(</span><span class="n">InputModeData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetShowMouseCursor</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">UGameInstance</span><span class="o">*</span> <span class="n">GameInstance</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">GameInstance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span> <span class="o">=</span> <span class="n">GameInstance</span><span class="o">-&gt;</span><span class="n">GetSubsystem</span><span class="o">&lt;</span><span class="n">UMultiplayerSessionsSubsystem</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">AddUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnFindSessions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">AddUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnJoinSession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnDestroySession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">MultiplayerOnStartSessionComplete</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnStartSession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">Initialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// AddToViewport不放在该函数的原因是此时尚未完成全部初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">Super</span><span class="o">::</span><span class="n">Initialize</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">HostButton</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">		<span class="n">HostButton</span><span class="o">-&gt;</span><span class="n">OnClicked</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">HostButtonClicked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">JoinButton</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">OnClicked</span><span class="p">.</span><span class="n">AddDynamic</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">JoinButtonClicked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">NativeDestruct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">MenuTearDown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">NativeDestruct</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnCreateSession</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">World</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">World</span><span class="o">-&gt;</span><span class="n">ServerTravel</span><span class="p">(</span><span class="n">PathToLobby</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">HostButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnFindSessions</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;&amp;</span> <span class="n">SessionResults</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">Result</span> <span class="p">:</span> <span class="n">SessionResults</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FString</span> <span class="n">SettingsValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">SessionSettings</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">&#34;MatchType&#34;</span><span class="p">),</span> <span class="n">SettingsValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">SettingsValue</span> <span class="o">==</span> <span class="n">MatchType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">JoinSession</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">bWasSuccessful</span> <span class="o">||</span> <span class="n">SessionResults</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">OnJoinSession</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">IOnlineSubsystem</span><span class="o">*</span> <span class="n">Subsystem</span> <span class="o">=</span> <span class="n">Online</span><span class="o">::</span><span class="n">GetSubsystem</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Subsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">IOnlineSessionPtr</span> <span class="n">SessionInterface</span> <span class="o">=</span> <span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">GetSessionInterface</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FString</span> <span class="n">Address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">GetResolvedConnectString</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">,</span> <span class="n">Address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">PlayerController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">ClientTravel</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">TRAVEL_Absolute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Result</span><span class="o">!=</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Success</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">HostButtonClicked</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">HostButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">CreateSession</span><span class="p">(</span><span class="n">NumPublicConnections</span><span class="p">,</span> <span class="n">MatchType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">JoinButtonClicked</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">JoinButton</span><span class="o">-&gt;</span><span class="n">SetIsEnabled</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">MultiplayerSessionsSubsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerSessionsSubsystem</span><span class="o">-&gt;</span><span class="n">FindSessions</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMenu</span><span class="o">::</span><span class="n">MenuTearDown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">RemoveFromParent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">UWorld</span><span class="o">*</span> <span class="n">World</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">APlayerController</span><span class="o">*</span> <span class="n">PlayerController</span> <span class="o">=</span> <span class="n">World</span><span class="o">-&gt;</span><span class="n">GetFirstPlayerController</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">FInputModeGameOnly</span> <span class="n">InputModeData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetInputMode</span><span class="p">(</span><span class="n">InputModeData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">PlayerController</span><span class="o">-&gt;</span><span class="n">SetShowMouseCursor</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>该代码的注意点如下：</p>
<ol>
<li><code>Initialize</code>函数在创建UI时进行调用，只进行按钮的代理绑定操作，其他初始操作（比如<code>AddToViewport</code>）放到自定义函数；</li>
<li><code>MenuSetup</code>中，调整了一些UI设置，并且获取了<code>UMultiplayerSessionsSubsystem</code>，并且获取其中的代理进行了回调函数的绑定，注意动态回调和非动态的函数区别。</li>
<li>在相关按钮被按下后，按钮被设置为不可用，直到回调中返回结果后才可以再次点击，这是为了防止多次调用内容。</li>
<li><code>UMenu::NativeDestruct</code>函数被调用时，表示用户被移动到其他地图，本地图被移除。</li>
</ol>
<h2 id="onlinesubsystem代码">OnlineSubSystem代码<a hidden class="anchor" aria-hidden="true" href="#onlinesubsystem代码">#</a></h2>
<p><code>MultiplayerSessionsSubsystem.h</code>继承<code>UGameInstanceSubsystem</code>，特点为：</p>
<ol>
<li>是一个单例类</li>
<li>和<code>GameInstance</code>拥有相同的生命周期，游戏开始时创建，结束时销毁</li>
<li>通过继承<code>UGameInstanceSubsystem</code>，而非<code>UGameInstance</code>，可以使具体功能实现解耦</li>
</ol>
<p>实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CoreMinimal.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Subsystems/GameInstanceSubsystem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Interfaces/OnlineSessionInterface.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;MultiplayerSessionsSubsystem.generated.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Delcaring our own custom delegates for the Menu class to bind callbacks to
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnCreateSessionComplete</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLARE_MULTICAST_DELEGATE_TwoParams</span><span class="p">(</span><span class="n">FMultiplayerOnFindSessionsComplete</span><span class="p">,</span> <span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;&amp;</span> <span class="n">SessionResults</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLARE_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnJoinSessionComplete</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnDestroySessionComplete</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span><span class="p">(</span><span class="n">FMultiplayerOnStartSessionComplete</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">UCLASS</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MULTIPLAYERSESSIONS_API</span> <span class="nl">UMultiplayerSessionsSubsystem</span> <span class="p">:</span> <span class="k">public</span> <span class="n">UGameInstanceSubsystem</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">UMultiplayerSessionsSubsystem</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// To handle session functionality. The Menu class will call these
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="nf">CreateSession</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumPublicConnections</span><span class="p">,</span> <span class="n">FString</span> <span class="n">MatchType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">FindSessions</span><span class="p">(</span><span class="n">int32</span> <span class="n">MaxSearchResults</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">JoinSession</span><span class="p">(</span><span class="k">const</span> <span class="n">FOnlineSessionSearchResult</span><span class="o">&amp;</span> <span class="n">SessionResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">DestroySession</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">StartSession</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Our own custom delegates for the Menu class to bind callbacks to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FMultiplayerOnCreateSessionComplete</span> <span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FMultiplayerOnFindSessionsComplete</span> <span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FMultiplayerOnJoinSessionComplete</span> <span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FMultiplayerOnDestroySessionComplete</span> <span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FMultiplayerOnStartSessionComplete</span> <span class="n">MultiplayerOnStartSessionComplete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Internal callbacks for the delegates we&#39;ll add to the Online Session Interface delegate list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// These don&#39;t need to be called outside this class.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">void</span> <span class="n">OnCreateSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">OnFindSessionsComplete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">OnJoinSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">OnDestroySessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="nf">OnStartSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">IOnlineSessionPtr</span> <span class="n">SessionInterface</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">TSharedPtr</span><span class="o">&lt;</span><span class="n">FOnlineSessionSettings</span><span class="o">&gt;</span> <span class="n">LastSessionSettings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">TSharedPtr</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearch</span><span class="o">&gt;</span> <span class="n">LastSessionSearch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// To add to the Online Session Interface delegate list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// We&#39;ll bind our MultiplayerSessionsSubsystem internal callbacks to these.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FOnCreateSessionCompleteDelegate</span> <span class="n">CreateSessionCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FOnFindSessionsCompleteDelegate</span> <span class="n">FindSessionsCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FOnJoinSessionCompleteDelegate</span> <span class="n">JoinSessionCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FOnDestroySessionCompleteDelegate</span> <span class="n">DestroySessionCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FOnStartSessionCompleteDelegate</span> <span class="n">StartSessionCompleteDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FDelegateHandle</span> <span class="n">StartSessionCompleteDelegateHandle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">bCreateSessionOnDestroy</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">int32</span> <span class="n">LastNumPublicConnections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FString</span> <span class="n">LastMatchType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意点如下：</p>
<ol>
<li>代码开始通过宏定义了若干个自定义的代理，这些代理有些是动态多播代理，有些是普通多播代理，原因在于参数的限制。声明代理后需要在类内部进行实例的声明；</li>
<li>在这里声明若干自定义代理的目的是为了让menu的函数可以在各种session任务完成后执行相应的回调函数，同时本类不需要知道具体的实现，实现类之间的解耦；</li>
<li>这里将<code>CreateSession</code>等函数声明为<code>public</code>函数，方便menu直接调用</li>
<li><code>private</code>部分声明了多种代理，用于绑定当相关Session操作完成后会进行回调的函数，和上面的自定义回调进行对比，前面的用于令其他类绑定对应的回调函数，通知者为当前类；当前的代理用来给Session Interface进行绑定，通知者为Interface；</li>
<li>将代理绑定到Session Interface后，返回对应的Handle，这个Handle可以后续将代理进行解绑。</li>
</ol>
<p><img alt="image-20250519215739251" loading="lazy" src="/posts/unrealengine/unrealonline/image-20250519215739251.png"></p>
<p><code>MultiplayerSessionsSubsystem.cpp</code>实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;MultiplayerSessionsSubsystem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSubsystem.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSessionSettings.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;OnlineSubsystemUtils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Online/OnlineSessionNames.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">UMultiplayerSessionsSubsystem</span><span class="p">()</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">CreateSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnCreateSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnCreateSessionComplete</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="n">FindSessionsCompleteDelegate</span><span class="p">(</span><span class="n">FOnFindSessionsCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnFindSessionsComplete</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="n">JoinSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnJoinSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnJoinSessionComplete</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="n">DestroySessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnDestroySessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnDestroySessionComplete</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="n">StartSessionCompleteDelegate</span><span class="p">(</span><span class="n">FOnStartSessionCompleteDelegate</span><span class="o">::</span><span class="n">CreateUObject</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ThisClass</span><span class="o">::</span><span class="n">OnStartSessionComplete</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">IOnlineSubsystem</span><span class="o">*</span> <span class="n">Subsystem</span> <span class="o">=</span> <span class="n">Online</span><span class="o">::</span><span class="n">GetSubsystem</span><span class="p">(</span><span class="n">UObject</span><span class="o">::</span><span class="n">GetWorld</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">Subsystem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span> <span class="o">=</span> <span class="n">Subsystem</span><span class="o">-&gt;</span><span class="n">GetSessionInterface</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">CreateSession</span><span class="p">(</span><span class="n">int32</span> <span class="n">NumPublicConnections</span><span class="p">,</span> <span class="n">FString</span> <span class="n">MatchType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">auto</span> <span class="n">ExistingSession</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">GetNamedSession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">ExistingSession</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">bCreateSessionOnDestroy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">LastNumPublicConnections</span> <span class="o">=</span> <span class="n">NumPublicConnections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">LastMatchType</span> <span class="o">=</span> <span class="n">MatchType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DestroySession</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Store the delegate in a FDelegateHandle so we can later remove it from the delegate list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">CreateSessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span> <span class="o">=</span> <span class="n">MakeShareable</span><span class="p">(</span><span class="k">new</span> <span class="n">FOnlineSessionSettings</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bIsLANMatch</span> <span class="o">=</span> <span class="n">Online</span><span class="o">::</span><span class="n">GetSubsystem</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">GetSubsystemName</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;NULL&#34;</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">NumPublicConnections</span> <span class="o">=</span> <span class="n">NumPublicConnections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bAllowJoinInProgress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bAllowJoinViaPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bShouldAdvertise</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bUsesPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">bUseLobbiesIfAvailable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span><span class="n">FName</span><span class="p">(</span><span class="s">&#34;MatchType&#34;</span><span class="p">),</span> <span class="n">MatchType</span><span class="p">,</span> <span class="n">EOnlineDataAdvertisementType</span><span class="o">::</span><span class="n">ViaOnlineServiceAndPing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSettings</span><span class="o">-&gt;</span><span class="n">BuildUniqueId</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">CreateSession</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">NAME_GameSession</span><span class="p">,</span> <span class="o">*</span><span class="n">LastSessionSettings</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Broadcast our own custom delegate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">FindSessions</span><span class="p">(</span><span class="n">int32</span> <span class="n">MaxSearchResults</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">FindSessionsCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSearch</span> <span class="o">=</span> <span class="n">MakeShareable</span><span class="p">(</span><span class="k">new</span> <span class="n">FOnlineSessionSearch</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">MaxSearchResults</span> <span class="o">=</span> <span class="n">MaxSearchResults</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">bIsLanQuery</span> <span class="o">=</span> <span class="n">Online</span><span class="o">::</span><span class="n">GetSubsystem</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">GetSubsystemName</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;NULL&#34;</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">QuerySettings</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">SEARCH_PRESENCE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">EOnlineComparisonOp</span><span class="o">::</span><span class="n">Equals</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">FindSessions</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">LastSessionSearch</span><span class="p">.</span><span class="n">ToSharedRef</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">JoinSession</span><span class="p">(</span><span class="k">const</span> <span class="n">FOnlineSessionSearchResult</span><span class="o">&amp;</span> <span class="n">SessionResult</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 相较原版本修改的地方
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FOnlineSessionSearchResult</span> <span class="n">Result</span> <span class="o">=</span> <span class="n">SessionResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span> <span class="o">||</span> <span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">UnknownError</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">JoinSessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">SessionSettings</span><span class="p">.</span><span class="n">bUseLobbiesIfAvailable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Result</span><span class="p">.</span><span class="n">Session</span><span class="p">.</span><span class="n">SessionSettings</span><span class="p">.</span><span class="n">bUsesPresence</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">ULocalPlayer</span><span class="o">*</span> <span class="n">LocalPlayer</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetFirstLocalPlayerFromController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">JoinSession</span><span class="p">(</span><span class="o">*</span><span class="n">LocalPlayer</span><span class="o">-&gt;</span><span class="n">GetPreferredUniqueNetId</span><span class="p">(),</span> <span class="n">NAME_GameSession</span><span class="p">,</span> <span class="n">Result</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">UnknownError</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">DestroySession</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="p">.</span><span class="n">IsValid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">DestroySessionCompleteDelegateHandle</span> <span class="o">=</span> <span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">AddOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">DestroySession</span><span class="p">(</span><span class="n">NAME_GameSession</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">OnCreateSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnCreateSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">CreateSessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">MultiplayerOnCreateSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">OnFindSessionsComplete</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnFindSessionsCompleteDelegate_Handle</span><span class="p">(</span><span class="n">FindSessionsCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">SearchResults</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">TArray</span><span class="o">&lt;</span><span class="n">FOnlineSessionSearchResult</span><span class="o">&gt;</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">MultiplayerOnFindSessionsComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">LastSessionSearch</span><span class="o">-&gt;</span><span class="n">SearchResults</span><span class="p">,</span> <span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">OnJoinSessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="n">EOnJoinSessionCompleteResult</span><span class="o">::</span><span class="n">Type</span> <span class="n">Result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnJoinSessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">JoinSessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">MultiplayerOnJoinSessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">Result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UMultiplayerSessionsSubsystem</span><span class="o">::</span><span class="n">OnDestroySessionComplete</span><span class="p">(</span><span class="n">FName</span> <span class="n">SessionName</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bWasSuccessful</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SessionInterface</span><span class="o">-&gt;</span><span class="n">ClearOnDestroySessionCompleteDelegate_Handle</span><span class="p">(</span><span class="n">DestroySessionCompleteDelegateHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">bWasSuccessful</span> <span class="o">&amp;&amp;</span> <span class="n">bCreateSessionOnDestroy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">bCreateSessionOnDestroy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">CreateSession</span><span class="p">(</span><span class="n">LastNumPublicConnections</span><span class="p">,</span> <span class="n">LastMatchType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">MultiplayerOnDestroySessionComplete</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">bWasSuccessful</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先，这里和官方实现的主要差别在：<code>UMultiplayerSessionsSubsystem::JoinSession</code>部分，在其中，使用了拷贝的<code>FOnlineSessionSearchResult</code>类型，并且重新进行了一些设定，进行设定后，在测试的版本中可以顺利加入游戏，否则不能。</p>
<p>接下来对代码内容进行说明：</p>
<ol>
<li>在构造函数中，对各种Delegate进行了初始化，注意到这里的回调函数都是非动态的；</li>
<li><code>CreateSession</code>的实现中，如果当前还有未删除的session，就保存当前的参数，执行<code>DestroySession</code>，并在实现后的回调函数中进行判断并再次创建Session，如果直接在<code>CreateSession</code>中删除并创建，会导致Destroy还未成功就进行创建，导致创建失败。</li>
<li><code>NAME_GameSession</code>是一个宏，在这里作为session的固定名字；</li>
<li>在Session操作开始时，将代理进行绑定，而当操作成功的回调或者操作失败时，就通过Handle清除对应的代理，防止重复触发；</li>
<li>对于自定义代理，需要在操作成功或者失败时进行广播（Broadcast）操作；</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="https://wstfdxfh.github.io/posts/unrealengine/unrealdebug/">
    <span class="title">Next »</span>
    <br>
    <span>UnrealDebug</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://wstfdxfh.github.io/">李睿杰的博客</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
